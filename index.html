<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Team Calendar</title>
    <meta name="description" content="Team resource calendar with real Excel integration">
    <meta name="theme-color" content="#3b82f6">

```
<!-- PWA Configuration -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Team Calendar">

<!-- PWA Manifest -->
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVGVhbSBDYWxlbmRhciIsInNob3J0X25hbWUiOiJUZWFtQ2FsIiwiZGVzY3JpcHRpb24iOiJUZWFtIHJlc291cmNlIGNhbGVuZGFyIHdpdGggcmVhbCBFeGNlbCBpbnRlZ3JhdGlvbiIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjM2I4MmY2In0=">

<!-- Excel Processing Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
    :root {
        --primary: #3b82f6;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-500: #6b7280;
        --gray-700: #374151;
        --gray-900: #111827;
        --white: #ffffff;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        background: var(--gray-50);
        color: var(--gray-900);
        -webkit-font-smoothing: antialiased;
    }

    .container {
        max-width: 428px;
        margin: 0 auto;
        min-height: 100vh;
        background: var(--white);
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    .header {
        background: var(--white);
        padding: 16px;
        border-bottom: 1px solid var(--gray-200);
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .header-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .btn {
        background: none;
        border: none;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .btn:hover {
        background: var(--gray-100);
    }

    .month-nav {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .month-title {
        font-size: 18px;
        font-weight: 600;
        min-width: 150px;
        text-align: center;
    }

    .status-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 8px;
        font-size: 12px;
        border-top: 1px solid var(--gray-200);
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-excel { background: var(--success); }
    .status-sample { background: var(--warning); }
    .status-error { background: var(--error); }

    .content {
        padding: 16px;
    }

    .jobs-card {
        background: var(--white);
        border: 1px solid var(--gray-200);
        border-radius: 12px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: var(--white);
        border-radius: 12px 12px 0 0;
    }

    .card-title {
        font-size: 16px;
        font-weight: 600;
    }

    .badge {
        background: rgba(255,255,255,0.2);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .jobs-list {
        padding: 12px 16px 16px;
        max-height: 300px;
        overflow-y: auto;
    }

    .job {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--white);
    }

    .job:hover {
        background: var(--gray-50);
        transform: translateY(-1px);
    }

    .job.on-call {
        border-color: #fca5a5;
        background: #fef2f2;
    }

    .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-size: 12px;
        font-weight: 700;
    }

    .job-info {
        flex: 1;
    }

    .job-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 2px;
    }

    .job-meta {
        font-size: 12px;
        color: var(--gray-500);
    }

    .job-badges {
        display: flex;
        gap: 4px;
        margin-bottom: 4px;
    }

    .type-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
    }

    .priority-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 600;
    }

    .priority-high { background: #fef2f2; color: #dc2626; }
    .priority-medium { background: #fef3c7; color: #d97706; }
    .priority-low { background: #ecfdf5; color: #059669; }

    .job-design { background: #dbeafe; color: #1e40af; }
    .job-development { background: #dcfce7; color: #166534; }
    .job-testing { background: #fef3c7; color: #92400e; }
    .job-meeting { background: #e9d5ff; color: #7c3aed; }
    .job-review { background: #fed7aa; color: #c2410c; }
    .job-planning { background: #fce7f3; color: #be185d; }
    .job-on-call { background: #fee2e2; color: #dc2626; }

    .member-blue { background: #3b82f6; }
    .member-green { background: #10b981; }
    .member-purple { background: #8b5cf6; }
    .member-yellow { background: #f59e0b; }
    .member-pink { background: #ec4899; }
    .member-orange { background: #f97316; }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
    }

    .modal-content {
        background: var(--white);
        border-radius: 12px;
        max-width: 400px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        border-bottom: 1px solid var(--gray-200);
    }

    .modal-body {
        padding: 16px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        font-size: 14px;
    }

    .input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .primary-btn {
        width: 100%;
        padding: 12px;
        background: var(--primary);
        color: var(--white);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 8px;
    }

    .primary-btn:hover {
        background: #2563eb;
    }

    .empty-state {
        text-align: center;
        padding: 32px 16px;
        color: var(--gray-500);
    }

    .toast {
        position: fixed;
        top: 20px;
        left: 16px;
        right: 16px;
        max-width: 400px;
        margin: 0 auto;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 600;
        z-index: 2000;
        transform: translateY(-100px);
        transition: transform 0.3s;
    }

    .toast.show {
        transform: translateY(0);
    }

    .toast-success { background: var(--success); color: var(--white); }
    .toast-error { background: var(--error); color: var(--white); }
    .toast-info { background: var(--primary); color: var(--white); }

    .hidden { display: none !important; }

    .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
```

</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-row">
                <button class="btn" id="refreshBtn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 4v6h6M23 20v-6h-6"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                </button>

```
            <div class="month-nav">
                <button class="btn" id="prevBtn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </button>
                <h1 class="month-title" id="monthTitle">April 2024</h1>
                <button class="btn" id="nextBtn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>
            </div>
            
            <button class="btn" id="settingsBtn">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </button>
        </div>
        
        <div class="status-bar">
            <div class="status-dot status-sample" id="statusDot"></div>
            <span id="statusText">Loading...</span>
        </div>
    </div>

    <!-- Content -->
    <div class="content">
        <!-- Today's Jobs -->
        <div class="jobs-card">
            <div class="card-header">
                <h2 class="card-title">ðŸ“… Today's Scheduled Jobs</h2>
                <div class="badge" id="todayCount">0</div>
            </div>
            <div class="jobs-list" id="todayJobs"></div>
        </div>

        <!-- On-Call -->
        <div class="jobs-card">
            <div class="card-header">
                <h2 class="card-title">ðŸš¨ Today's On-Call</h2>
            </div>
            <div class="jobs-list" id="onCallInfo"></div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal hidden" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Excel Integration Settings</h2>
            <button class="btn" id="closeSettingsBtn">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="label">OneDrive Share Link</label>
                <input type="text" class="input" id="shareLinkInput" placeholder="Paste your OneDrive share link">
            </div>

            <div class="form-group">
                <label class="label">Excel File Name</label>
                <input type="text" class="input" id="fileNameInput" value="TeamCalendar_2024-04.xlsx">
            </div>

            <button class="primary-btn" id="loadRealDataBtn">Load Real Excel Data</button>
            <button class="primary-btn" id="testConnectionBtn">Test Connection</button>
            <button class="primary-btn" id="saveSettingsBtn">Save Settings</button>
            
            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);">
                <p style="font-size: 12px; color: var(--gray-500); margin-bottom: 8px;">
                    <strong>How to get your share link:</strong><br>
                    1. Go to OneDrive in browser<br>
                    2. Right-click your Excel file<br>
                    3. Share â†’ Copy link<br>
                    4. Paste the full URL above
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    // App State
    const state = {
        currentMonth: new Date(2024, 3, 1), // April 2024
        currentDate: new Date(2024, 3, 12), // April 12
        teamMembers: [],
        jobAssignments: {},
        settings: {
            shareLink: '',
            fileName: 'TeamCalendar_2024-04.xlsx'
        }
    };

    // Excel Data Loading
    async function loadRealExcelData() {
        try {
            showToast('Loading real Excel data from OneDrive...', 'info');
            updateStatus('sample', 'Connecting to OneDrive...');

            if (!state.settings.shareLink) {
                throw new Error('No OneDrive share link provided');
            }

            // Convert OneDrive share link to direct download URL
            const downloadUrl = convertShareLinkToDownloadUrl(state.settings.shareLink);
            console.log('Download URL:', downloadUrl);

            // Fetch Excel file as binary data
            const response = await fetch(downloadUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                }
            });

            if (!response.ok) {
                throw new Error(`Failed to fetch Excel file: ${response.status} ${response.statusText}`);
            }

            const arrayBuffer = await response.arrayBuffer();
            console.log('Excel file downloaded, size:', arrayBuffer.byteLength);

            // Parse Excel file using SheetJS
            const workbook = XLSX.read(arrayBuffer, {
                type: 'array',
                cellDates: true,
                cellFormulas: false
            });

            console.log('Workbook sheets:', workbook.SheetNames);

            // Parse each required worksheet
            const teamMembers = parseTeamMembersSheet(workbook);
            const jobAssignments = parseJobAssignmentsSheet(workbook);

            console.log('Parsed team members:', teamMembers);
            console.log('Parsed job assignments:', Object.keys(jobAssignments).length, 'members with jobs');

            // Update app state with real data
            state.teamMembers = teamMembers;
            state.jobAssignments = jobAssignments;

            updateStatus('excel', 'Real Excel data loaded');
            showToast('Excel data loaded successfully!', 'success');
            
            renderApp();
            
        } catch (error) {
            console.error('Excel loading error:', error);
            showToast(`Excel loading failed: ${error.message}`, 'error');
            updateStatus('error', 'Excel loading failed');
            
            // Fall back to sample data
            loadSampleData();
        }
    }

    function convertShareLinkToDownloadUrl(shareLink) {
        try {
            // Convert OneDrive share link to direct download URL
            if (shareLink.includes('sharepoint.com')) {
                // For SharePoint/OneDrive for Business links
                const base64Encoded = shareLink.split('/').pop().split('?')[0];
                return shareLink.replace(':x:', ':x:').replace(/\?.*$/, '') + '&download=1';
            } else {
                // For personal OneDrive links
                return shareLink + '&download=1';
            }
        } catch (error) {
            console.error('Error converting share link:', error);
            return shareLink;
        }
    }

    function parseTeamMembersSheet(workbook) {
        try {
            const sheetName = 'Team Members';
            if (!workbook.Sheets[sheetName]) {
                throw new Error(`Worksheet "${sheetName}" not found`);
            }

            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Skip header row and parse data
            const dataRows = jsonData.slice(1);
            const teamMembers = [];

            dataRows.forEach((row, index) => {
                if (row[0] && row[1]) { // ID and Name required
                    teamMembers.push({
                        id: parseInt(row[0]),
                        name: row[1],
                        role: row[2] || 'Team Member',
                        color: row[3] || 'member-blue',
                        avatar: row[4] || row[1].substring(0, 2).toUpperCase()
                    });
                }
            });

            console.log('Parsed team members:', teamMembers);
            return teamMembers;
        } catch (error) {
            console.error('Error parsing Team Members sheet:', error);
            throw error;
        }
    }

    function parseJobAssignmentsSheet(workbook) {
        try {
            const sheetName = 'Job Assignments';
            if (!workbook.Sheets[sheetName]) {
                throw new Error(`Worksheet "${sheetName}" not found`);
            }

            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Skip header row and parse data
            const dataRows = jsonData.slice(1);
            const jobAssignments = {};

            dataRows.forEach((row, index) => {
                try {
                    if (row[0] && row[1] && row[2]) { // Member_ID, Date, Job_Title required
                        const memberId = parseInt(row[0]);
                        const date = new Date(row[1]);
                        const day = date.getDate();

                        const job = {
                            title: row[2],
                            type: row[3] || 'development',
                            duration: row[4] || 'full',
                            description: row[5] || '',
                            client: row[6] || 'Unknown',
                            priority: row[7] || 'Medium',
                            estimatedHours: parseFloat(row[8]) || 8,
                            status: row[9] || 'Not Started',
                            notes: row[10] || ''
                        };

                        if (!jobAssignments[memberId]) {
                            jobAssignments[memberId] = {};
                        }
                        if (!jobAssignments[memberId][day]) {
                            jobAssignments[memberId][day] = [];
                        }

                        jobAssignments[memberId][day].push(job);
                    }
                } catch (rowError) {
                    console.warn(`Error parsing job assignment row ${index + 2}:`, rowError);
                }
            });

            console.log('Parsed job assignments:', jobAssignments);
            return jobAssignments;
        } catch (error) {
            console.error('Error parsing Job Assignments sheet:', error);
            throw error;
        }
    }

    // Sample Data Fallback
    function loadSampleData() {
        console.log('Loading sample data...');
        
        state.teamMembers = [
            { id: 1, name: 'Sarah Martinez', role: 'UI/UX Designer', color: 'member-blue', avatar: 'SM' },
            { id: 2, name: 'Alex Chen', role: 'Frontend Dev', color: 'member-green', avatar: 'AC' },
            { id: 3, name: 'Maya Patel', role: 'Backend Dev', color: 'member-purple', avatar: 'MP' },
            { id: 5, name: 'Lisa Wong', role: 'Project Manager', color: 'member-pink', avatar: 'LW' }
        ];

        state.jobAssignments = {
            1: {
                12: [{
                    title: 'Design Review',
                    type: 'meeting',
                    duration: 'half',
                    description: 'Review design deliverables',
                    client: 'TechCorp Inc.',
                    priority: 'High',
                    estimatedHours: 4,
                    status: 'Scheduled',
                    notes: 'Prepare presentation'
                }]
            },
            5: {
                12: [{
                    title: 'On-Call Support',
                    type: 'on-call',
                    duration: 'full',
                    description: 'Emergency support',
                    client: 'Operations',
                    priority: 'High',
                    estimatedHours: 8,
                    status: 'Active',
                    notes: 'Monitor alerts'
                }]
            }
        };

        updateStatus('sample', 'Using sample data');
        renderApp();
    }

    // Render Functions
    function renderApp() {
        renderTodaysJobs();
        renderOnCall();
    }

    function renderTodaysJobs() {
        const today = state.currentDate.getDate();
        const allJobs = [];

        // Collect all jobs for today
        for (const memberId in state.jobAssignments) {
            const memberJobs = state.jobAssignments[memberId]?.[today] || [];
            const member = state.teamMembers.find(m => m.id === parseInt(memberId));
            
            if (member) {
                memberJobs.forEach(job => {
                    allJobs.push({
                        ...job,
                        memberName: member.name,
                        memberAvatar: member.avatar,
                        memberColor: member.color
                    });
                });
            }
        }

        // Sort by priority
        allJobs.sort((a, b) => {
            const priority = { 'High': 3, 'Medium': 2, 'Low': 1 };
            return (priority[b.priority] || 0) - (priority[a.priority] || 0);
        });

        // Update count
        document.getElementById('todayCount').textContent = allJobs.length;

        // Render jobs
        const container = document.getElementById('todayJobs');
        if (allJobs.length === 0) {
            container.innerHTML = '<div class="empty-state">No jobs scheduled for today</div>';
            return;
        }

        container.innerHTML = '';
        allJobs.forEach(job => {
            const jobEl = document.createElement('div');
            jobEl.className = `job ${job.type === 'on-call' ? 'on-call' : ''}`;
            
            jobEl.innerHTML = `
                <div class="avatar ${job.memberColor}">${job.memberAvatar}</div>
                <div class="job-info">
                    <div class="job-badges">
                        <div class="type-badge job-${job.type}">
                            ${job.type.charAt(0).toUpperCase() + job.type.slice(1)}
                        </div>
                        <div class="priority-badge priority-${job.priority.toLowerCase()}">
                            ${job.priority}
                        </div>
                    </div>
                    <div class="job-title">${job.title}</div>
                    <div class="job-meta">${job.memberName} â€¢ ${job.client}</div>
                    <div class="job-meta">
                        ${job.duration === 'full' ? 'Full Day' : 'Half Day'} (${job.estimatedHours}h)
                    </div>
                </div>
            `;

            container.appendChild(jobEl);
        });
    }

    function renderOnCall() {
        const today = state.currentDate.getDate();
        let onCallPerson = null;

        // Find on-call person
        for (const memberId in state.jobAssignments) {
            const memberJobs = state.jobAssignments[memberId]?.[today] || [];
            if (memberJobs.some(job => job.type === 'on-call')) {
                onCallPerson = state.teamMembers.find(m => m.id === parseInt(memberId));
                break;
            }
        }

        const container = document.getElementById('onCallInfo');
        if (onCallPerson) {
            container.innerHTML = `
                <div class="job on-call">
                    <div class="avatar ${onCallPerson.color}">${onCallPerson.avatar}</div>
                    <div class="job-info">
                        <div class="job-title">${onCallPerson.name}</div>
                        <div class="job-meta">${onCallPerson.role}</div>
                        <div class="job-meta" style="color: #dc2626; font-weight: 600;">
                            ðŸš¨ Available for emergency support
                        </div>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = '<div class="empty-state">No one assigned</div>';
        }
    }

    function updateStatus(type, message) {
        document.getElementById('statusDot').className = `status-dot status-${type}`;
        document.getElementById('statusText').textContent = message;
    }

    function showToast(message, type = 'info') {
        const existingToasts = document.querySelectorAll('.toast');
        existingToasts.forEach(toast => toast.remove());

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Settings Functions
    function loadSettings() {
        const saved = localStorage.getItem('teamCalendarSettings');
        if (saved) {
            try {
                state.settings = { ...state.settings, ...JSON.parse(saved) };
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        document.getElementById('shareLinkInput').value = state.settings.shareLink;
        document.getElementById('fileNameInput').value = state.settings.fileName;
    }

    function saveSettings() {
        state.settings.shareLink = document.getElementById('shareLinkInput').value.trim();
        state.settings.fileName = document.getElementById('fileNameInput').value.trim();

        localStorage.setItem('teamCalendarSettings', JSON.stringify(state.settings));
        showToast('Settings saved!', 'success');
        closeModal();
    }

    async function testConnection() {
        const button = document.getElementById('testConnectionBtn');
        button.disabled = true;
        button.innerHTML = 'Testing... <span class="spinner"></span>';

        try {
            if (!state.settings.shareLink) {
                throw new Error('Please enter OneDrive share link first');
            }

            // Test the connection
            const downloadUrl = convertShareLinkToDownloadUrl(state.settings.shareLink);
            const response = await fetch(downloadUrl, { method: 'HEAD' });

            if (response.ok) {
                showToast('OneDrive connection successful!', 'success');
            } else {
                throw new Error(`Connection failed: ${response.status}`);
            }
        } catch (error) {
            showToast(`Connection test failed: ${error.message}`, 'error');
        } finally {
            button.disabled = false;
            button.textContent = 'Test Connection';
        }
    }

    function openSettings() {
        document.getElementById('settingsModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('settingsModal').classList.add('hidden');
    }

    // Event Listeners
    document.getElementById('settingsBtn').onclick = openSettings;
    document.getElementById('closeSettingsBtn').onclick = closeModal;
    document.getElementById('saveSettingsBtn').onclick = saveSettings;
    document.getElementById('testConnectionBtn').onclick = testConnection;
    document.getElementById('loadRealDataBtn').onclick = loadRealExcelData;
    document.getElementById('refreshBtn').onclick = () => {
        if (state.settings.shareLink) {
            loadRealExcelData();
        } else {
            openSettings();
        }
    };

    document.getElementById('settingsModal').onclick = (e) => {
        if (e.target.id === 'settingsModal') closeModal();
    };

    // Initialize
    function init() {
        loadSettings();
        
        // Try to load real Excel data if configured
        if (state.settings.shareLink) {
            loadRealExcelData();
        } else {
            loadSampleData();
            setTimeout(() => {
                showToast('Add OneDrive link in Settings for real data', 'info');
            }, 2000);
        }
    }

    init();
</script>
```

</body>
</html>