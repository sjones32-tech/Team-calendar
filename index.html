<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAI Site Key Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --bg-primary: #ffffff;
            --bg-secondary: #f3f4f6;
            --border: #e5e7eb;
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
        }

        /* Auto-Save Indicator */
        .auto-save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
            background: white;
            padding: 8px 14px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .auto-save-indicator.saving {
            background: var(--warning);
            color: white;
        }

        .auto-save-indicator.saved {
            background: var(--success);
            color: white;
        }

        .auto-save-indicator.error {
            background: var(--danger);
            color: white;
        }

        .save-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        .auto-save-indicator.saving .save-spinner {
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
            font-size: 0.85em;
            color: var(--success);
        }

        .sync-status.syncing {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .sync-status.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
/* Cabinet Visual */
.cabinet-visual {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 20px;
}

.cabinet-slot {
    background: white;
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 15px 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
}

.cabinet-slot:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.cabinet-slot.occupied {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border-color: var(--primary);
}

.cabinet-slot.empty {
    background: white;
    border-style: dashed;
    opacity: 0.7;
}

.cabinet-slot.on-loan {
    background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
    border-color: var(--warning);
}

.slot-number {
    font-size: 0.75em;
    color: var(--text-secondary);
    position: absolute;
    top: 5px;
    right: 8px;
}

.slot-key-icon {
    font-size: 2em;
    margin-bottom: 5px;
}

.slot-key-id {
    font-weight: 600;
    font-size: 0.85em;
    color: var(--text-primary);
}

.slot-status {
    font-size: 0.7em;
    color: var(--text-secondary);
    margin-top: 5px;
}

.cabinet-info-row {
    display: flex;
    font-size: 0.9em;
}
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .logo-image {
            width: 45px;
            height: 45px;
            object-fit: contain;
            background: white;
            padding: 8px;
            border-radius: 8px;
        }

        .bai-logo {
            background: white;
            color: #3b82f6;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 900;
            font-size: 1.2em;
        }

        .app-title {
            flex: 1;
        }

        .app-title h1 {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .app-subtitle {
            font-size: 0.85em;
            opacity: 0.8;
        }

        .nav-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95em;
            position: relative;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--sidebar-hover);
            color: white;
            padding-left: 24px;
        }

        .nav-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: var(--primary);
            color: white;
        }

        .nav-item.active .nav-icon {
            color: var(--primary);
        }

        .nav-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 20px 20px;
        }

        .nav-icon {
            width: 20px;
            text-align: center;
            font-size: 1.1em;
        }

        /* Main Content */
        .main-container {
            flex: 1;
            margin-left: 280px;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-left h2 {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875em;
        }

        .content {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }

        .stat-icon.blue { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .stat-icon.yellow { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-icon.red { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .stat-details {
            flex: 1;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875em;
            margin-top: 4px;
        }

        /* Search Bar */
        .search-section {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
        }

        .search-input {
            width: 100%;
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Tabs */
        .tabs-container {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 24px;
        }

        .tabs-header {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .tab-button {
            padding: 16px 24px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .tab-button:hover {
            color: var(--text-primary);
        }

        .tab-button.active {
            color: var(--primary);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }

        .tab-content {
            padding: 24px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 20px;
        }

        /* Key Items */
        .key-item {
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 12px;
            transition: all 0.2s;
            background: white;
        }

        .key-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .key-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .key-id {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.05em;
        }

        .key-details {
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.5;
        }

        .key-meta {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 0.875em;
            color: var(--text-secondary);
        }

        .key-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9em;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-section {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-section-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 1.05em;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Alert */
        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .alert.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: var(--success);
            color: white;
        }

        .alert-error {
            background: var(--danger);
            color: white;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3em;
            opacity: 0.3;
            margin-bottom: 16px;
        }

        .empty-text {
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .empty-subtext {
            font-size: 0.9em;
        }

        /* Overdue Alert Section */
        .overdue-section {
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            display: none;
        }

        .overdue-section.show {
            display: block;
        }

        .overdue-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            color: var(--danger);
        }

        .overdue-title {
            font-size: 1.1em;
            font-weight: 600;
        }

        .overdue-item {
            background: white;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid rgba(239, 68, 68, 0.2);
            transition: all 0.2s;
        }

        .overdue-item:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
            transform: translateY(-1px);
        }

        /* Backup Item */
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .backup-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .backup-info {
            flex: 1;
        }

        .backup-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .backup-meta {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .backup-actions {
            display: flex;
            gap: 8px;
        }

        /* Progress Bar */
        .progress-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 8px;
            transition: width 0.3s;
        }

        /* File Manager Status */
        .file-manager-status {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .file-manager-status.connected {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
        }

        .file-manager-status.disconnected {
            background: rgba(239, 68, 68, 0.05);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-container {
                margin-left: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Auto-Save Indicator -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        <div class="save-spinner"></div>
        <span id="saveStatusText">Saved</span>
    </div>
	
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="logo-section">
                <img src="https://cdn.bfldr.com/V9KRPA8/at/qc5hwfrxk25hrr6pbzgwww/BAI_Communications_Logo_Element_blue.ai?auto=webp&format=png" alt="BAI Logo" class="logo-image" onerror="this.style.display='none'">
                <div class="app-title">
                    <h1>Key Manager</h1>
                    <div class="app-subtitle">Site Key Management</div>
                </div>
            </div>
        </div>
        <nav class="nav-menu">
            <a href="#" class="nav-item active" data-page="dashboard">
                <span class="nav-icon">üè†</span>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" data-page="keys">
                <span class="nav-icon">üîë</span>
                <span>All Keys</span>
            </a>
            <a href="#" class="nav-item" data-page="loans">
                <span class="nav-icon">üìã</span>
                <span>Active Loans</span>
            </a>
            <a href="#" class="nav-item" data-page="history">
                <span class="nav-icon">üìö</span>
                <span>Loan History</span>
            </a>
            
            <div class="nav-divider"></div>
            
            <a href="#" class="nav-item" data-page="customers">
                <span class="nav-icon">üë•</span>
                <span>Customers</span>
            </a>
			<a href="#" class="nav-item" data-page="technicians">
				<span class="nav-icon">üôãüèª‚Äç‚ôÇÔ∏è</span>
				<span>Technicians</span>
			</a>
			<a href="#" class="nav-item" data-page="keycabinet">
				<span class="nav-icon">üóÑÔ∏è</span>
				<span>Key Cabinet</span>
			</a>
			<div class="nav-divider"></div>
            <a href="#" class="nav-item" data-page="sites">
                <span class="nav-icon">üè¢</span>
                <span>Sites</span>
            </a>
            
            <div class="nav-divider"></div>
            
            <a href="#" class="nav-item" data-page="reports">
                <span class="nav-icon">üìà</span>
                <span>Reports</span>
            </a>
            <a href="#" class="nav-item" data-page="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </a>
        </nav>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
			<div>
                    <h2>Dashboard</h2>
                    <div class="header-subtitle">Overview of key management operations</div>
                </div>
                <div class="sync-status" id="syncStatus">
                    <span>üíæ</span>
                    <span id="syncStatusText">All data saved</span>
                </div>
            </div>
			<div class="header-actions">
                <button class="btn btn-secondary" id="importBtn">
                    <span>üì•</span>
                    Import/Export
                </button>
                <button class="btn btn-primary" id="quickLoanBtn">
                    <span>‚ö°</span>
                    Quick Loan
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <span>üîë</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-value" id="totalKeys">0</div>
                        <div class="stat-label">Total Keys</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <span>‚úÖ</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-value" id="availableKeys">0</div>
                        <div class="stat-label">Available</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon yellow">
                        <span>üìã</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-value" id="loanedKeys">0</div>
                        <div class="stat-label">On Loan</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon red">
                        <span>‚ö†Ô∏è</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-value" id="overdueKeys">0</div>
                        <div class="stat-label">Overdue</div>
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <input type="text" class="search-input" id="globalSearch" placeholder="Search keys, customers, sites...">
            </div>

            <!-- Overdue Alert -->
            <div class="overdue-section" id="overdueAlert">
                <div class="overdue-header">
                    <span style="font-size: 1.5em;">üö®</span>
                    <div class="overdue-title">Overdue Keys - Action Required</div>
                </div>
                <div id="overdueList"></div>
            </div>

            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-button active" data-tab="available">Available Keys</button>
                    <button class="tab-button" data-tab="loans">Active Loans</button>
                    <button class="tab-button" data-tab="history">Recent History</button>
                </div>
                <div class="tab-content">
                    <div class="tab-panel active" id="available-panel">
                        <div id="availableList">
                            <div class="empty-state">
                                <div class="empty-icon">üîë</div>
                                <div class="empty-text">No available keys</div>
                                <div class="empty-subtext">Add keys to get started</div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-panel" id="loans-panel">
                        <div id="loansList">
                            <div class="empty-state">
                                <div class="empty-icon">üìã</div>
                                <div class="empty-text">No active loans</div>
                                <div class="empty-subtext">Loan out keys to track them</div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-panel" id="history-panel">
                        <div id="historyList">
                            <div class="empty-state">
                                <div class="empty-icon">üìö</div>
                                <div class="empty-text">No history yet</div>
                                <div class="empty-subtext">Completed loans will appear here</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Key Modal -->
    <div id="addKeyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Key</h3>
                <button class="modal-close" onclick="closeModal('addKeyModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Key ID *</label>
                    <input type="text" id="keyId" class="form-input" placeholder="e.g., SITE-001">
                </div>
				<div class="form-group">
                    <label class="form-label">Key SN *</label>
                    <input type="text" id="keySN" class="form-input" placeholder="e.g., 28">
                </div>
				<div class="form-group">
                    <label class="form-label">Key Number *</label>
                    <input type="text" id="keyNumber" class="form-input" placeholder="e.g., N2B8">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="keyDesc" class="form-input" placeholder="e.g., Main entrance key">
                </div>
				<div class="form-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
				<div style="font-weight: 600; color: var(--text-primary); margin-bottom: 15px; font-size: 0.95em;">
				   Key Cabinet Information
				</div>  
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" id="keylocation" class="form-input" placeholder="e.g., SYD Office Cabinet">
                </div>
				<div class="form-group">
                    <label class="form-label">Location Number</label>
                    <input type="text" id="keylocationNumber" class="form-input" placeholder="e.g., Hook 41">
                </div>
				</div>
				<!-- NEW FIELDS -->
				<div class="form-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 15px; font-size: 0.95em;">
                    Assignment Information
                </div>
                <div class="form-group">
                    <label class="form-label">Assigned Technician</label>
                    <input type="text" id="assignedTechnician" class="form-input" placeholder="e.g., John Smith">
                </div>
                <div class="form-group">
                    <label class="form-label">Assigned Date</label>
                    <input type="date" id="assignedDate" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addKeyModal')">Cancel</button>
                <button class="btn btn-primary" id="saveKeyBtn">Add Key</button>
            </div>
			</div>
		</div>
	</div>
    <!-- Loan Modal -->
    <div id="loanModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Loan Out Key</h3>
                <button class="modal-close" onclick="closeModal('loanModal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Key Selection -->
                <div class="form-section">
                    <div class="form-section-title">üîë Key Selection</div>
                    <div class="form-group">
                        <label class="form-label">Select Key *</label>
                        <select id="loanKeyId" class="form-select">
                            <option value="">Choose a key...</option>
                        </select>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="form-section">
                    <div class="form-section-title">üë§ Customer Information</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Name *</label>
                            <input type="text" id="customerName" class="form-input" placeholder="John Smith">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company</label>
                            <input type="text" id="customerCompany" class="form-input" placeholder="ABC Corp">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" id="customerEmail" class="form-input" placeholder="john@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone *</label>
                            <input type="tel" id="customerPhone" class="form-input" placeholder="+1-555-0123">
                        </div>
                    </div>
                </div>

                <!-- Site Information -->
                <div class="form-section">
                    <div class="form-section-title">üè¢ Site Information</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Site Name *</label>
                            <input type="text" id="siteName" class="form-input" placeholder="Westfield Centre">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Site Number *</label>
                            <input type="text" id="siteNumber" class="form-input" placeholder="WFC-001">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Access Request Number *</label>
                        <input type="text" id="siteAccessRequestNumber" class="form-input" placeholder="SAR-2025-001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Purpose of Access *</label>
                        <input type="text" id="accessPurpose" class="form-input" placeholder="Maintenance work">
                    </div>
                </div>

                <!-- Loan Details -->
                <div class="form-section">
                    <div class="form-section-title">üìÖ Loan Details</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Loan Type *</label>
                            <select id="loanType" class="form-select">
                                <option value="">Select type...</option>
                                <option value="Temporary">Temporary</option>
                                <option value="Permanent">Permanent</option>
                                <option value="Emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Expected Return *</label>
                            <input type="date" id="expectedReturnDate" class="form-input">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comments</label>
                        <textarea id="loanComments" class="form-textarea" placeholder="Additional notes..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('loanModal')">Cancel</button>
                <button class="btn btn-primary" id="saveLoanBtn">Complete Loan</button>
            </div>
        </div>
    </div>

    <!-- Return Modal -->
    <div id="returnModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Return Key</h3>
                <button class="modal-close" onclick="closeModal('returnModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="returnInfo" style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;"></div>
                
                <div class="form-group">
                    <label class="form-label">Return Date *</label>
                    <input type="date" id="returnDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Returned To *</label>
                    <input type="text" id="returnToName" class="form-input" placeholder="Security desk, John Smith">
                </div>
                <div class="form-group">
                    <label class="form-label">Return Location *</label>
                    <input type="text" id="returnLocation" class="form-input" placeholder="Building A Reception">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="returnNotes" class="form-textarea" placeholder="Key condition, comments..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('returnModal')">Cancel</button>
                <button class="btn btn-success" id="confirmReturnBtn">Complete Return</button>
            </div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div id="importExportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Import/Export Data</h3>
                <button class="modal-close" onclick="closeModal('importExportModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="text-align: center; padding: 40px; border: 2px dashed var(--border); border-radius: 8px; cursor: pointer;" id="importSection">
                        <div style="font-size: 3em; margin-bottom: 16px;">üì•</div>
                        <h4>Import Excel</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 8px;">Click to select file</p>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
                    </div>
                    <div style="text-align: center; padding: 40px; border: 2px dashed var(--border); border-radius: 8px; cursor: pointer;" id="exportSection">
                        <div style="font-size: 3em; margin-bottom: 16px;">üì§</div>
                        <h4>Export Excel</h4>
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 8px;">Download current data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Extend Modal -->
    <div id="extendModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Extend Due Date</h3>
                <button class="modal-close" onclick="closeModal('extendModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="extendInfo" style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;"></div>
                
                <div class="form-group">
                    <label class="form-label">Current Due Date</label>
                    <input type="text" id="currentDueDate" class="form-input" readonly style="background: var(--bg-secondary);">
                </div>
                <div class="form-group">
                    <label class="form-label">New Due Date *</label>
                    <input type="date" id="newDueDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Reason for Extension</label>
                    <textarea id="extensionReason" class="form-textarea" placeholder="e.g., Project delayed, additional time needed"></textarea>
                </div>
                
                <!-- Quick Duration Buttons -->
                <div style="margin-top: 16px;">
                    <label style="font-weight: 500; color: var(--text-secondary); display: block; margin-bottom: 8px; font-size: 0.9em;">Quick Extension:</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setExtension(3)">+3 Days</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setExtension(7)">+1 Week</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setExtension(14)">+2 Weeks</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setExtension(30)">+1 Month</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('extendModal')">Cancel</button>
                <button class="btn btn-warning" id="confirmExtendBtn">Extend Due Date</button>
            </div>
        </div>
    </div>

    <!-- Collection Modal -->
    <div id="collectionModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Key Collection Confirmation</h3>
                <button class="modal-close" onclick="closeModal('collectionModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="collectionInfo" style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;"></div>
                
                <div class="form-section">
                    <div class="form-section-title">üìã Collection Details</div>
                    <div class="form-group">
                        <label class="form-label">Collection Date & Time *</label>
                        <input type="datetime-local" id="keyCollectionDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Collected By *</label>
                        <input type="text" id="keyCollectedBy" class="form-input" placeholder="e.g., Customer name or representative">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Collection Notes</label>
                        <textarea id="keyCollectionNotes" class="form-textarea" placeholder="e.g., ID verified, instructions given"></textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">üìß Notifications</div>
                    <div style="margin: 12px 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="sendCollectionEmail" checked style="margin-right: 8px;">
                            <span>Send collection confirmation email to customer</span>
                        </label>
                    </div>
                    <div style="margin: 12px 0;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="printCollectionReceipt" checked style="margin-right: 8px;">
                            <span>Print collection receipt with terms</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('collectionModal')">Cancel</button>
                <button class="btn btn-primary" id="confirmCollectionBtn">Confirm Collection</button>
            </div>
        </div>
    </div>
	<!-- Key Cabinet Modal -->
	<div id="keycabinetModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title" id="technicianModalTitle">Add Key Cabinet</h3>
            <button class="modal-close" onclick="closeModal('keycabinetModal')">X</button>
        </div>
		<div class="modal-body">
            <input type="hidden" id="keydetailsEdit">
			
            <!-- Key Information -->
			
			<div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Key ID *</label>
                    <input type="text" id="cabinetKeyId" class="form-input" placeholder="e.g., SITE-001">
                </div>
				<div class="form-group">
                    <label class="form-label">Key SN *</label>
                    <input type="text" id="cabinetKeySN" class="form-input" placeholder="e.g., 28">
                </div>
				<div class="form-group">
                    <label class="form-label">Key Number *</label>
                    <input type="text" id="cabinetkeyNumber" class="form-input" placeholder="e.g., N2B8">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" id="cabinetkeyDesc" class="form-input" placeholder="e.g., Main entrance key">
                </div>
                <div class="form-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
				<div style="font-weight: 600; color: var(--text-primary); margin-bottom: 15px; font-size: 0.95em;">
				   Key Cabinet Information
				</div>  
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" id="keyLocation" class="form-input" placeholder="e.g., SYD Office Cabinet">
                </div>
				<div class="form-group">
                    <label class="form-label">Location Number</label>
                    <input type="text" id="keylocationNumber" class="form-input" placeholder="e.g., Hook 41">
                </div>
				</div>		
				<div class="form-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 15px; font-size: 0.95em;">
                    Assignment Information
                </div>
                <div class="form-group">
                    <label class="form-label">Assigned Technician</label>
                    <input type="text" id="assignedTechnician" class="form-input" placeholder="e.g., John Smith">
                </div>
                <div class="form-group">
                    <label class="form-label">Assigned Date</label>
                    <input type="date" id="assignedDate" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addKeyModal')">Cancel</button>
                <button class="btn btn-primary" id="saveKeyBtn">Add Key</button>
            </div>
			</div>
		</div>
	
	
	
	
<!-- Technician Modal -->
<div id="technicianModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title" id="technicianModalTitle">Add Technician</h3>
            <button class="modal-close" onclick="closeModal('technicianModal')">X</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="technicianEditId">
            
            <!-- Personal Information -->
            <div class="form-section">
                <div class="form-section-title">Personal Information</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" id="techName" class="form-input" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Employee ID *</label>
                        <input type="text" id="techEmployeeId" class="form-input" placeholder="EMP-001">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" id="techEmail" class="form-input" placeholder="john.smith@bai.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone *</label>
                        <input type="tel" id="techPhone" class="form-input" placeholder="+1-555-0123">
                    </div>
                </div>
            </div>
            <!-- Professional Information -->
            <div class="form-section">
                <div class="form-section-title">Professional Information</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Department</label>
                        <select id="techDepartment" class="form-select">
                            <option value="">Select department...</option>
                            <option value="SIU Sydney">SIU Sydney</option>
                            <option value="SIU Canberra">SIU Canberra</option>
                            <option value="SIU Newcastle">SIU Newcastle</option>
                            <option value="FIMs">FIMs</option>
                            <option value="Engineering">Engineering</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="techStatus" class="form-select">
                            <option value="Active">Active</option>
                            <option value="On Leave">On Leave</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Hire Date</label>
                        <input type="date" id="techHireDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Certification Level</label>
                        <select id="techCertLevel" class="form-select">
                            <option value="">Select level...</option>
                            <option value="Entry">Entry Level</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Senior">Senior</option>
                            <option value="Expert">Expert</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Skills & Access -->
            <div class="form-section">
                <div class="form-section-title">Skills & Access</div>
                <div class="form-group">
                    <label class="form-label">Specialized Skills</label>
                    <input type="text" id="techSkills" class="form-input" placeholder="e.g., Electrical, HVAC, Network Security">
                </div>
                <div class="form-group">
                    <label class="form-label">Authorized Areas</label>
                    <input type="text" id="techAreas" class="form-input" placeholder="e.g., Building A, Building B, Server Room">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="techNotes" class="form-textarea" placeholder="Additional information..."></textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('technicianModal')">Cancel</button>
            <button class="btn btn-primary" id="saveTechnicianBtn" onclick="saveTechnician()">Save Technician</button>
        </div>
    </div>
</div>




    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <script>
	// Enhanced Data Structure with Metadata
let appData = {
    version: '2.0.0',
    metadata: {
        lastModified: null,
        lastBackup: null,
        backupCount: 0,
        fileHandle: null,
        autoSaveFile: null
    },
    keys: [],
    loans: [],
    sites: [],
	technicians: [],  // NEW: Add technicians array
	cabinets: [], //NEw: Add cabinets array

    settings: {
        dbLocation: 'Browser Storage',
        backupFrequency: 'daily',
        autoSaveInterval: 5,
        defaultLoanDuration: 7,
        overdueThreshold: 2,
        maxExtensions: 3,
        autoReminders: true,
        collectionEmails: true,
        returnConfirmations: true,
        autoBackupEnabled: true,
        fileSystemEnabled: false,
        termsText: `1. Key must be used for authorized purposes only
2. No duplication or sharing permitted
3. Borrower is liable for loss/damage costs
4. Key must be returned by the due date
5. Must follow all site safety and security rules
6. Access to designated areas only
7. Report loss or damage immediately
8. Access can be revoked at any time`,
        legalText: 'Non-compliance may result in access revocation, financial penalties, and legal action.'
    },
    backups: []
};

// Global Variables
let currentReturnLoan = null;
let currentExtendLoan = null;
let currentCollectionLoan = null;
let currentPage = 'dashboard';
let autoSaveInterval = null;
let backupInterval = null;
let autoSaveEnabled = true;
let hasUnsavedChanges = false;
let currentImportType = '';

// File System API Support Check
const fileSystemSupported = 'showSaveFilePicker' in window;

// Getter functions for data access
function getKeys() { return appData.keys; }
function getLoans() { return appData.loans; }
function getSites() { return appData.sites; }
function getTechnicians() { return appData.technicians || []; }

// Initialize
window.addEventListener('DOMContentLoaded', function() {
    loadAllDataFromStorage();
    initializeData();
	initializeTechnicians();
	initializeCabinets();
    setupEventListeners();
    updateDisplay();
    startAutoSave();
    startAutoBackup();
    checkFileSystemSupport();
    
    // Set up beforeunload warning
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        }
    });			
});

// Initialize sample technicians if empty
function initializeTechnicians() {
    if (appData.technicians.length === 0) {
        appData.technicians = [
            {
                id: 'TECH-001',
                employeeId: 'EMP-001',
                name: 'Mike Johnson',
                email: 'mike.johnson@bai.com',
                phone: '+1-555-0123',
                department: 'Maintenance',
                status: 'Active',
                hireDate: '2020-03-15',
                certLevel: 'Senior',
                skills: 'Electrical, HVAC, Plumbing',
                areas: 'Building A, Building B, Building C',
                assignedKeys: 2,
                notes: 'Senior technician, weekend availability'
            },
            {
                id: 'TECH-002',
                employeeId: 'EMP-002',
                name: 'Sarah Williams',
                email: 'sarah.williams@bai.com',
                phone: '+1-555-0456',
                department: 'IT',
                status: 'Active',
                hireDate: '2021-06-01',
                certLevel: 'Expert',
                skills: 'Network Security, Server Management',
                areas: 'Server Room, Building B',
                assignedKeys: 2,
                notes: 'IT specialist, on-call available'
            },
            {
                id: 'TECH-003',
                employeeId: 'EMP-003',
                name: 'David Chen',
                email: 'david.chen@bai.com',
                phone: '+1-555-0789',
                department: 'Security',
                status: 'Active',
                hireDate: '2019-01-10',
                certLevel: 'Senior',
                skills: 'Access Control, CCTV Systems',
                areas: 'All Buildings',
                assignedKeys: 1,
                notes: 'Security supervisor'
            }
        ];
        saveAllDataToStorage();
    }
}
// Initialize sample cabinets if empty
function initializeCabinets() {
    if (!appData.cabinets || appData.cabinets.length === 0) {
        appData.cabinets = [
            {
                id: 'CAB-001',
                name: 'Sydney Office - Main Cabinet',
                location: 'Level 3, Room 301',
                capacity: 50,
                description: 'Primary key storage for Sydney office',
                createdDate: '2024-01-15',
                lastAudit: '2025-01-10'
            },
            {
                id: 'CAB-002',
                name: 'Canberra Office - Cabinet A',
                location: 'Ground Floor, Security Room',
                capacity: 30,
                description: 'Secure key storage for Canberra site',
                createdDate: '2024-03-20',
                lastAudit: '2025-01-05'
            },
            {
                id: 'CAB-003',
                name: 'Newcastle Branch - Cabinet',
                location: 'Reception Area',
                capacity: 20,
                description: 'Key storage for Newcastle operations',
                createdDate: '2024-06-10',
                lastAudit: '2024-12-15'
            }
        ];
        saveAllDataToStorage();
    }
}

function initializeData() {
   // Sample data if no data exists
    if (appData.keys.length === 0) {
        appData.keys = [
            { 
                id: 'SITE-001', 
                description: 'Main entrance key', 
                location: 'Building A',
                locationNumber: 'Hook 41',
                keyNumber: 'N2B8',
                keySN: '28',
                assignedTechnician: 'Mike Johnson',
                assignedDate: '2025-01-15',
                available: true 
            },
            { 
                id: 'SITE-002', 
                description: 'Server room access', 
                location: 'Building B',
                locationNumber: 'Hook 12',
                keyNumber: 'S4R1',
                keySN: '45',
                assignedTechnician: 'Sarah Williams',
                assignedDate: '2025-01-10',
                available: false 
            },
            { 
                id: 'SITE-003', 
                description: 'Emergency exit key', 
                location: 'Building C',
                locationNumber: 'Hook 7',
                keyNumber: 'E9X3',
                keySN: '67',
                assignedTechnician: 'Mike Johnson',
                assignedDate: '2025-01-12',
                available: true 
            },
            { 
                id: 'SITE-004', 
                description: 'Storage room key', 
                location: 'Building A',
                locationNumber: 'Hook 23',
                keyNumber: 'ST5G',
                keySN: '89',
                assignedTechnician: 'David Chen',
                assignedDate: '2025-01-08',
                available: true 
            },
            { 
                id: 'SITE-005', 
                description: 'Conference room key', 
                location: 'Building B',
                locationNumber: 'Hook 15',
                keyNumber: 'CR7M',
                keySN: '102',
                assignedTechnician: 'Sarah Williams',
                assignedDate: '2025-01-14',
                available: false 
            }
        ];
    }
    
    if (appData.loans.length === 0) {
        const today = new Date();
        const overdueDate = new Date();
        overdueDate.setDate(overdueDate.getDate() - 10);
        const futureDate = new Date();
        futureDate.setDate(futureDate.getDate() + 5);
        
        appData.loans = [
            {
                id: 'LOAN-001',
                keyId: 'SITE-002',
                customerName: 'John Smith',
                customerEmail: 'john.smith@example.com',
                customerPhone: '+1-555-0123',
                siteName: 'Westfield Shopping Centre',
                siteNumber: 'WFC-001',
                siteAccessRequestNumber: 'SAR-2025-001',
                loanType: 'Temporary',
                loanDate: new Date(overdueDate.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                expectedReturnDate: overdueDate.toISOString().split('T')[0],
                status: 'active',
                loanComments: 'Server maintenance work',
                keyCollectedBy: 'John Smith',
                keyCollectionDate: new Date(overdueDate.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                reminderCount: 1,
                lastReminderDate: new Date(today.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString()
            },
            {
                id: 'LOAN-002',
                keyId: 'SITE-005',
                customerName: 'Sarah Johnson',
                customerEmail: 'sarah.johnson@example.com',
                customerPhone: '+1-555-0456',
                siteName: 'Central Office Tower',
                siteNumber: 'COT-002',
                siteAccessRequestNumber: 'SAR-2025-002',
                loanType: 'Temporary',
                loanDate: today.toISOString().split('T')[0],
                expectedReturnDate: futureDate.toISOString().split('T')[0],
                status: 'active',
                loanComments: 'Conference room setup'
            }
        ];
    }
}
// Cabinet Tab Switching
function setupCabinetTabs() {
    document.querySelectorAll('.tabs-container .tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Update buttons
            document.querySelectorAll('.tabs-container .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            this.classList.add('active');
            
            // Update panels
            document.querySelectorAll('.tabs-container .tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            const panel = document.getElementById(tabId + '-panel');
            if (panel) {
                panel.classList.add('active');
            }
        });
    });
}

// Show Add Cabinet Modal
function showAddCabinetModal() {
    // Remove existing modal if present
    const existingModal = document.getElementById('addCabinetModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.id = 'addCabinetModal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Cabinet</h3>
					<button class="modal-close" id="closeCabinetModalBtn">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Cabinet Name *</label>
                    <input type="text" id="cabinetName" class="form-input" placeholder="e.g., Sydney Office - Main Cabinet">
                </div>
                <div class="form-group">
                    <label class="form-label">Location *</label>
                    <input type="text" id="cabinetLocation" class="form-input" placeholder="e.g., Level 3, Room 301">
                </div>
                <div class="form-group">
                    <label class="form-label">Capacity *</label>
                    <input type="number" id="cabinetCapacity" class="form-input" value="50" min="1" max="200">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="cabinetDesc" class="form-textarea" placeholder="Additional notes about this cabinet..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
		  <button class="btn btn-secondary" id="cancelCabinetBtn">Cancel</button>
        <button class="btn btn-primary" id="saveCabinetBtn">Add Cabinet</button>
		</div>
        </div>
    `;
    document.body.appendChild(modal);
	
	
    // Attach event listeners after modal is added to DOM
    document.getElementById('closeCabinetModalBtn').addEventListener('click', () => closeModal('addCabinetModal'));
    document.getElementById('cancelCabinetBtn').addEventListener('click', () => closeModal('addCabinetModal'));
    document.getElementById('saveCabinetBtn').addEventListener('click', addCabinet);
}


// Add Cabinet
function addCabinet() {
    const name = document.getElementById('cabinetName').value.trim();
    const location = document.getElementById('cabinetLocation').value.trim();
    const capacity = parseInt(document.getElementById('cabinetCapacity').value);
    const description = document.getElementById('cabinetDesc').value.trim();
    
    if (!name || !location || !capacity) {
        showAlert('Please fill in all required fields', 'error');
        return;
    }
    
    appData.cabinets.push({
        id: 'CAB-' + Date.now(),
        name: name,
        location: location,
        capacity: capacity,
        description: description,
        createdDate: new Date().toISOString().split('T')[0],
        lastAudit: null
    });
    
    markDataChanged();
    showAlert('Cabinet added successfully', 'success');
    closeModal('addCabinetModal');
    updateDisplay();
}

// Edit Cabinet
function editCabinet(cabinetId) {
    const cabinet = appData.cabinets.find(c => c.id === cabinetId);
    if (!cabinet) return;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('editCabinetModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.id = 'editCabinetModal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Cabinet</h3>
                <button class="modal-close" id="closeEditCabinetBtn">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Cabinet Name *</label>
                    <input type="text" id="editCabinetName" class="form-input" value="${cabinet.name}">
                </div>
                <div class="form-group">
                    <label class="form-label">Location *</label>
                    <input type="text" id="editCabinetLocation" class="form-input" value="${cabinet.location}">
                </div>
                <div class="form-group">
                    <label class="form-label">Capacity *</label>
                    <input type="number" id="editCabinetCapacity" class="form-input" value="${cabinet.capacity}" min="1" max="200">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="editCabinetDesc" class="form-textarea">${cabinet.description || ''}</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditCabinetBtn">Cancel</button>
                <button class="btn btn-primary" id="updateCabinetBtn">Update Cabinet</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Attach event listeners after modal is added to DOM
     document.getElementById('closeEditCabinetBtn').addEventListener('click', () => closeModal('editCabinetModal'));
    document.getElementById('cancelEditCabinetBtn').addEventListener('click', () => closeModal('editCabinetModal'));
    document.getElementById('updateCabinetBtn').addEventListener('click', () => updateCabinet(cabinetId));
}

// Update Cabinet
function updateCabinet(cabinetId) {
    const cabinet = appData.cabinets.find(c => c.id === cabinetId);
    if (!cabinet) return;
    
    cabinet.name = document.getElementById('editCabinetName').value.trim();
    cabinet.location = document.getElementById('editCabinetLocation').value.trim();
    cabinet.capacity = parseInt(document.getElementById('editCabinetCapacity').value);
    cabinet.description = document.getElementById('editCabinetDesc').value.trim();
    
    markDataChanged();
    showAlert('Cabinet updated successfully', 'success');
    closeModal('editCabinetModal');
    updateDisplay();
}

// Audit Cabinet
function auditCabinet(cabinetId) {
    const cabinet = appData.cabinets.find(c => c.id === cabinetId);
    if (!cabinet) return;
    
    cabinet.lastAudit = new Date().toISOString().split('T')[0];
    markDataChanged();
    showAlert(`Audit completed for ${cabinet.name}`, 'success');
    updateDisplay();
}
// Add this function after the assignTechnician functions (around line 2900)
function unassignKeyFromTechnician(keyId) {
    const keys = getKeys();
    const key = keys.find(k => k.id === keyId);
    
    if (!key) {
        showAlert('Key not found', 'error');
        return;
    }
    
    if (!key.assignedTechnician || key.assignedTechnician === 'Unassigned') {
        showAlert('This key is not assigned to any technician', 'info');
        return;
    }
    
    const previousTechnician = key.assignedTechnician;
    
    // Create modal for cabinet selection
    const cabinets = appData.cabinets || [];
    
    if (cabinets.length === 0) {
        if (confirm(`Unassign key ${keyId} from ${previousTechnician}? No cabinets available - key will be marked as unassigned.`)) {
            key.assignedTechnician = 'Unassigned';
            key.assignedDate = null;
            key.location = 'Unassigned';
            key.locationNumber = 'Unassigned';
            markDataChanged();
            showAlert(`Key ${keyId} unassigned from ${previousTechnician}`, 'success');
            updateDisplay();
        }
        return;
    }
    
    // Create cabinet selection modal
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.id = 'unassignModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Return Key to Cabinet</h3>
                <button class="modal-close" onclick="closeModal('unassignModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>Key:</strong> ${keyId}<br>
                    <strong>Description:</strong> ${key.description}<br>
                    <strong>Currently Assigned to:</strong> ${previousTechnician}<br>
                    <strong>Assignment Date:</strong> ${key.assignedDate || 'Unknown'}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Cabinet *</label>
                    <select id="returnCabinetSelect" class="form-select">
                        <option value="">Choose a cabinet...</option>
                        ${cabinets.map(cab => {
                            const keysInCabinet = keys.filter(k => k.location === cab.name).length;
                            const available = cab.capacity - keysInCabinet;
                            return `<option value="${cab.name}" ${available <= 0 ? 'disabled' : ''}>
                                ${cab.name} (${available} spaces available)
                            </option>`;
                        }).join('')}
                    </select>
                </div>
                
               <div class="form-group">
                    <label class="form-label">Hook/Location Number</label>
                    <input type="text" id="returnLocationNumber" class="form-input" 
                           placeholder="e.g., Hook 41" value="${key.locationNumber !== 'Unassigned' ? key.locationNumber : ''}">
                </div>
                    
                
                
                <div class="form-group">
                    <label class="form-label">Return Notes</label>
                    <textarea id="returnNotes" class="form-textarea" 
                              placeholder="Reason for unassignment, condition notes, etc."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('unassignModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmUnassignment('${keyId}')">Confirm Return</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function confirmUnassignment(keyId) {
    const cabinetSelect = document.getElementById('returnCabinetSelect');
    const locationNumber = document.getElementById('returnLocationNumber');
    const notes = document.getElementById('returnNotes');
    
    if (!cabinetSelect || !cabinetSelect.value) {
        showAlert('Please select a cabinet', 'error');
        return;
    }
    
    const keys = getKeys();
    const key = keys.find(k => k.id === keyId);
    
    if (!key) return;
    
    const previousTechnician = key.assignedTechnician;
    
    // Update key information
    key.assignedTechnician = 'Unassigned';
    key.assignedDate = null;
    key.location = cabinetSelect.value;
    key.locationNumber = locationNumber.value.trim() || 'Unassigned';
    
    // Add to history (optional - you could track this in a separate array)
    if (!key.assignmentHistory) {
        key.assignmentHistory = [];
    }
    key.assignmentHistory.push({
        action: 'unassigned',
        previousTechnician: previousTechnician,
        returnedToCabinet: cabinetSelect.value,
        locationNumber: locationNumber.value.trim(),
        date: new Date().toISOString(),
        notes: notes.value.trim()
    });
    
    markDataChanged();
    showAlert(`Key ${keyId} successfully returned to ${cabinetSelect.value}`, 'success');
    closeModal('unassignModal');
    
    // Refresh the current page
    if (currentPage === 'keys') {
        displayAllKeys();
    } else if (currentPage === 'technicians') {
        loadTechniciansContent(document.querySelector('.content'));
    } else if (currentPage === 'keycabinet') {
        loadKeyCabinetContent(document.querySelector('.content'));
    } else {
        updateDisplay();
    }
}

// Delete Cabinet function
function deleteCabinet(cabinetId) {
    const cabinet = appData.cabinets.find(c => c.id === cabinetId);
    if (!cabinet) return;
    
    const keys = getKeys();
    const keysInCabinet = keys.filter(k => k.location === cabinet.name);
    const activeLoans = keysInCabinet.filter(k => !k.available);
    
	 if (activeLoans.length > 0) {
        showAlert(`Cannot delete cabinet with ${activeLoans.length} keys currently on loan`, 'error');
        return;
    }
	
    let confirmMessage = `Are you sure you want to delete the cabinet "${cabinet.name}"?`;
    
    if (keysInCabinet.length > 0) {
        confirmMessage = `WARNING: This cabinet "${cabinet.name}" contains ${keysInCabinet.length} key(s). ` +
                         `Deleting this cabinet will unassign the location for these keys. ` +
                         `Are you sure you want to proceed?`;
    }
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // If there are keys in this cabinet, update their location
    if (keysInCabinet.length > 0) {
        keysInCabinet.forEach(key => {
            key.location = 'Unassigned';
            key.locationNumber = 'Unassigned';
        });
    }
    
    // Remove the cabinet from the array
    const index = appData.cabinets.findIndex(c => c.id === cabinetId);
    if (index !== -1) {
        appData.cabinets.splice(index, 1);
    }
    
    markDataChanged();
    showAlert(`Cabinet "${cabinet.name}" deleted successfully`, 'success');
    
    // Refresh the Key Cabinet page
    if (currentPage === 'keycabinet') {
        loadKeyCabinetContent(document.querySelector('.content'));
    }
}

// Show Key Details
function showKeyDetails(keyId) {
    const key = appData.keys.find(k => k.id === keyId);
    if (!key) return;
    
    const loan = appData.loans.find(l => l.keyId === keyId && l.status === 'active');
    
    let loanInfo = '';
    if (loan) {
        loanInfo = `
            <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 6px; margin-top: 15px;">
                <strong>Currently on loan to:</strong><br>
                ${loan.customerName}<br>
                Due: ${loan.expectedReturnDate}
            </div>
        `;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.id = 'keyDetailsModal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Key Details</h3>
                <button class="modal-close" onclick="closeModal('keyDetailsModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px;">
                    <h4>${key.id}</h4>
                    <p>${key.description}</p>
                    <div style="margin-top: 10px;">
                        <strong>Location:</strong> ${key.location}<br>
                        <strong>Hook:</strong> ${key.locationNumber}<br>
                        ${key.keyNumber ? `<strong>Key Number:</strong> ${key.keyNumber}<br>` : ''}
                        ${key.keySN ? `<strong>Serial:</strong> ${key.keySN}<br>` : ''}
                        ${key.assignedTechnician ? `<strong>Assigned to:</strong> ${key.assignedTechnician}<br>` : ''}
                        <strong>Status:</strong> <span class="badge ${key.available ? 'badge-success' : 'badge-warning'}">${key.available ? 'Available' : 'On Loan'}</span>
                    </div>
                    ${loanInfo}
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('keyDetailsModal')">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function setupEventListeners() {
    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            navigateToPage(page);
        });
    });

    // Quick Actions
    document.getElementById('quickLoanBtn').addEventListener('click', () => {
        updateLoanKeyOptions();
        document.getElementById('loanModal').classList.add('show');
    });

    document.getElementById('importBtn').addEventListener('click', () => {
        document.getElementById('importExportModal').classList.add('show');
    });

    // Tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            switchTab(tab);
        });
    });

    // Modal Actions
    document.getElementById('saveKeyBtn').addEventListener('click', addKey);
    document.getElementById('saveLoanBtn').addEventListener('click', loanKey);
    document.getElementById('confirmReturnBtn').addEventListener('click', processReturn);
    document.getElementById('confirmExtendBtn').addEventListener('click', processExtend);
    document.getElementById('confirmCollectionBtn').addEventListener('click', processCollection);

    // Import/Export - FIXED
    document.getElementById('importSection').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });
    
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    
    document.getElementById('exportSection').addEventListener('click', () => {
        showExportOptions();
    });
    
    // Search
    const searchInput = document.getElementById('globalSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            performSearch(e.target.value);
        });
    }

    // Close modals on outside click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('show');
            }
        });
    });

    // Set default dates
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const expectedReturn = document.getElementById('expectedReturnDate');
    if (expectedReturn) {
        expectedReturn.min = tomorrow.toISOString().split('T')[0];
    }
    const returnDate = document.getElementById('returnDate');
    if (returnDate) {
        returnDate.value = new Date().toISOString().split('T')[0];
    }
}

// Enhanced Storage Functions
function saveAllDataToStorage() {
    try {
        // Update metadata
        appData.metadata.lastModified = new Date().toISOString();
        
        // Save to localStorage
        localStorage.setItem('keyManagerData', JSON.stringify(appData));
        
        // Update UI
        updateSaveStatus('saved');
        hasUnsavedChanges = false;
        
        // If file system is enabled, save to file
        if (appData.settings.fileSystemEnabled && appData.metadata.autoSaveFile) {
            saveToFileSystem();
        }
        
        return true;
    } catch (error) {
        console.error('Save error:', error);
        updateSaveStatus('error');
        showAlert('Failed to save data: ' + error.message, 'error');
        return false;
    }
}

function loadAllDataFromStorage() {
    try {
        const saved = localStorage.getItem('keyManagerData');
        if (saved) {
            const loaded = JSON.parse(saved);
            // Merge with default structure to ensure all properties exist
            appData = { ...appData, ...loaded };
            
            // Ensure arrays exist
            if (!Array.isArray(appData.keys)) appData.keys = [];
            if (!Array.isArray(appData.loans)) appData.loans = [];
            if (!Array.isArray(appData.sites)) appData.sites = [];
            if (!Array.isArray(appData.backups)) appData.backups = [];
			if (!Array.isArray(appData.technicians)) appData.technicians = [];
			if (!Array.isArray(appData.cabinets)) appData.cabinets = [];
			
        }
    } 
		catch (error) {
        console.error('Load error:', error);
        showAlert('Failed to load saved data', 'error');
    }
}

// Auto-Save Functions
function startAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    
    const intervalMinutes = appData.settings.autoSaveInterval || 5;
    autoSaveInterval = setInterval(() => {
        if (autoSaveEnabled && hasUnsavedChanges) {
            updateSaveStatus('saving');
            if (saveAllDataToStorage()) {
                console.log('Auto-save completed at', new Date().toLocaleTimeString());
            }
        }
    }, intervalMinutes * 60 * 1000);
}

function updateSaveStatus(status) {
    const indicator = document.getElementById('autoSaveIndicator');
    const statusText = document.getElementById('saveStatusText');
    const syncStatus = document.getElementById('syncStatus');
    const syncStatusText = document.getElementById('syncStatusText');
    
    indicator.classList.remove('saving', 'saved', 'error');
    syncStatus.classList.remove('syncing', 'error');
    
    switch(status) {
        case 'saving':
            indicator.classList.add('saving');
            statusText.textContent = 'Saving...';
            syncStatus.classList.add('syncing');
            syncStatusText.textContent = 'Syncing...';
            break;
        case 'saved':
            indicator.classList.add('saved');
            statusText.textContent = 'All changes saved';
            syncStatusText.textContent = 'All data saved';
            setTimeout(() => {
                indicator.classList.remove('saved');
            }, 2000);
            break;
        case 'error':
            indicator.classList.add('error');
            statusText.textContent = 'Save failed';
            syncStatus.classList.add('error');
            syncStatusText.textContent = 'Sync error';
            break;
    }
}

function markDataChanged() {
    hasUnsavedChanges = true;
    // Trigger save after a short delay
    setTimeout(() => {
        if (hasUnsavedChanges) {
            updateSaveStatus('saving');
            saveAllDataToStorage();
        }
    }, 1000);
}

// Backup Functions
function startAutoBackup() {
    if (!appData.settings.autoBackupEnabled) return;
    
    if (backupInterval) {
        clearInterval(backupInterval);
    }
    
    // Set backup interval based on frequency setting
    let intervalHours = 24; // default daily
    switch(appData.settings.backupFrequency) {
        case 'hourly':
            intervalHours = 1;
            break;
        case 'daily':
            intervalHours = 24;
            break;
        case 'weekly':
            intervalHours = 168;
            break;
        case 'monthly':
            intervalHours = 720;
            break;
    }
    
    backupInterval = setInterval(() => {
        createBackup('auto');
    }, intervalHours * 60 * 60 * 1000);
    
    // Also check if backup is needed on startup
    checkBackupNeeded();
}

function checkBackupNeeded() {
    if (!appData.metadata.lastBackup) {
        createBackup('auto');
        return;
    }
    
    const lastBackup = new Date(appData.metadata.lastBackup);
    const now = new Date();
    const hoursSinceBackup = (now - lastBackup) / (1000 * 60 * 60);
    
    let backupNeeded = false;
    switch(appData.settings.backupFrequency) {
        case 'hourly':
            backupNeeded = hoursSinceBackup >= 1;
            break;
        case 'daily':
            backupNeeded = hoursSinceBackup >= 24;
            break;
        case 'weekly':
            backupNeeded = hoursSinceBackup >= 168;
            break;
        case 'monthly':
            backupNeeded = hoursSinceBackup >= 720;
            break;
    }
    
    if (backupNeeded) {
        createBackup('auto');
    }
}

function createBackup(type = 'manual') {
    try {
        const backup = {
            id: 'BACKUP-' + Date.now(),
            timestamp: new Date().toISOString(),
            type: type,
            data: {
                keys: [...appData.keys],
                loans: [...appData.loans],
                sites: [...appData.sites],
                settings: { ...appData.settings }
            },
            size: JSON.stringify(appData).length
        };
        
        // Add to backups array (keep last 10)
        appData.backups.unshift(backup);
        if (appData.backups.length > 10) {
            appData.backups = appData.backups.slice(0, 10);
        }
        
        // Update metadata
        appData.metadata.lastBackup = backup.timestamp;
        appData.metadata.backupCount++;
        
        // Save to localStorage
        saveAllDataToStorage();
        
        // Also export to file if auto-backup to Excel is enabled
        if (type === 'auto' && appData.settings.autoBackupEnabled) {
            exportBackupToExcel(backup);
        }
        
        console.log(`${type} backup created at`, new Date().toLocaleTimeString());
        
        if (type === 'manual') {
            showAlert('Backup created successfully', 'success');
        }
        
        return backup;
    } catch (error) {
        console.error('Backup error:', error);
        showAlert('Failed to create backup: ' + error.message, 'error');
        return null;
    }
}

function exportBackupToExcel(backup) {
    try {
        const wb = XLSX.utils.book_new();
        const timestamp = new Date(backup.timestamp).toISOString().split('T')[0];
        
        // Keys sheet
        if (backup.data.keys.length > 0) {
            const keysWS = XLSX.utils.json_to_sheet(backup.data.keys);
            XLSX.utils.book_append_sheet(wb, keysWS, "Keys");
        }
        
        // Loans sheet
        if (backup.data.loans.length > 0) {
            const loansWS = XLSX.utils.json_to_sheet(backup.data.loans);
            XLSX.utils.book_append_sheet(wb, loansWS, "Loans");
        }
        
        // Sites sheet
        if (backup.data.sites.length > 0) {
            const sitesWS = XLSX.utils.json_to_sheet(backup.data.sites);
            XLSX.utils.book_append_sheet(wb, sitesWS, "Sites");
        }
        
        // Metadata sheet
        const metadataWS = XLSX.utils.json_to_sheet([{
            BackupID: backup.id,
            BackupType: backup.type,
            BackupDate: backup.timestamp,
            TotalKeys: backup.data.keys.length,
            TotalLoans: backup.data.loans.length,
            TotalSites: backup.data.sites.length
        }]);
        XLSX.utils.book_append_sheet(wb, metadataWS, "Metadata");
        
        // Generate filename
        const filename = `backup-${backup.type}-${timestamp}.xlsx`;
        
        // If File System API is available and enabled, save to selected directory
        if (fileSystemSupported && appData.settings.fileSystemEnabled && appData.metadata.fileHandle) {
            // For now, just save normally
            // In production, you'd use the File System API here
            XLSX.writeFile(wb, filename);
        }
    } catch (error) {
        console.error('Excel backup error:', error);
    }
}

function restoreBackup(backupId) {
    const backup = appData.backups.find(b => b.id === backupId);
    if (!backup) {
        showAlert('Backup not found', 'error');
        return;
    }
    
    if (confirm('Are you sure you want to restore this backup? Current data will be replaced.')) {
        // Restore data
        appData.keys = [...backup.data.keys];
        appData.loans = [...backup.data.loans];
        appData.sites = [...backup.data.sites];
        appData.settings = { ...backup.data.settings };
        
        // Save and update
        saveAllDataToStorage();
        updateDisplay();
        loadPageContent(currentPage);
        
        showAlert('Backup restored successfully', 'success');
    }
}

// File System API Functions
async function checkFileSystemSupport() {
    if (fileSystemSupported) {
        console.log('File System API is supported');
        // Update UI to show file system options
        if (currentPage === 'settings') {
            updateFileSystemStatus(true);
        }
    } else {
        console.log('File System API not supported');
    }
}

async function selectAutoSaveFile() {
    if (!fileSystemSupported) {
        showAlert('File System API is not supported in your browser', 'error');
        return;
    }
    
    try {
        const handle = await window.showSaveFilePicker({
            suggestedName: 'keymanager-autosave.json',
            types: [{
                description: 'JSON Files',
                accept: { 'application/json': ['.json'] }
            }]
        });
        
        appData.metadata.fileHandle = handle;
        appData.metadata.autoSaveFile = handle.name;
        appData.settings.fileSystemEnabled = true;
        
        saveAllDataToStorage();
        updateFileSystemStatus(true, handle.name);
        showAlert(`Auto-save file selected: ${handle.name}`, 'success');
    } catch (error) {
        if (error.name !== 'AbortError') {
            console.error('File selection error:', error);
            showAlert('Failed to select file: ' + error.message, 'error');
        }
    }
}

async function saveToFileSystem() {
    if (!appData.metadata.fileHandle) return;
    
    try {
        const writable = await appData.metadata.fileHandle.createWritable();
        await writable.write(JSON.stringify(appData, null, 2));
        await writable.close();
        
        console.log('Saved to file system:', appData.metadata.autoSaveFile);
    } catch (error) {
        console.error('File system save error:', error);
        // Don't show alert for every auto-save failure
    }
}

function updateFileSystemStatus(enabled, filename = null) {
    const statusElement = document.getElementById('fileSystemStatus');
    if (!statusElement) return;
    
    if (enabled && filename) {
        statusElement.innerHTML = `
            <div class="file-manager-status connected">
                <strong>‚úÖ File System Connected</strong><br>
                Auto-save file: ${filename}<br>
                <button class="btn btn-sm btn-secondary" onclick="disconnectFileSystem()">Disconnect</button>
            </div>
        `;
    } else if (enabled) {
        statusElement.innerHTML = `
            <div class="file-manager-status disconnected">
                <strong>File System Available</strong><br>
                <button class="btn btn-sm btn-primary" onclick="selectAutoSaveFile()">Select Auto-Save File</button>
            </div>
        `;
    } else {
        statusElement.innerHTML = `
            <div class="file-manager-status disconnected">
                <strong>‚ö†Ô∏è File System Not Available</strong><br>
                <small>Use Chrome or Edge for file system support</small>
            </div>
        `;
    }
}

function disconnectFileSystem() {
    appData.metadata.fileHandle = null;
    appData.metadata.autoSaveFile = null;
    appData.settings.fileSystemEnabled = false;
    saveAllDataToStorage();
    updateFileSystemStatus(true);
    showAlert('File system disconnected', 'success');
}

// Export Functions
function showExportOptions() {
    const options = `
        <div style="display: grid; gap: 15px;">
            <button class="btn btn-primary" onclick="exportData('excel')" style="padding: 20px;">
                üìä Export as Excel
            </button>
            <button class="btn btn-secondary" onclick="exportData('json')" style="padding: 20px;">
                üìÑ Export as JSON
            </button>
            <button class="btn btn-secondary" onclick="exportData('backup')" style="padding: 20px;">
                üíæ Create & Export Backup
            </button>
        </div>
    `;
    
    // Create temporary modal for export options
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Export Options</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
            </div>
            <div class="modal-body">
                ${options}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Close import/export modal
    closeModal('importExportModal');
}

function exportData(format = 'excel') {
    try {
        const timestamp = new Date().toISOString().split('T')[0];
        
        if (format === 'json') {
            // Export as JSON
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `keymanager-data-${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showAlert('Data exported as JSON', 'success');
            
        } else if (format === 'backup') {
            // Create and export backup
            const backup = createBackup('manual');
            if (backup) {
                exportBackupToExcel(backup);
                showAlert('Backup created and exported', 'success');
            }
            
        } else {
            // Export as Excel (default)
            const wb = XLSX.utils.book_new();
            
            // Keys sheet
            const keysWS = XLSX.utils.json_to_sheet(appData.keys);
            XLSX.utils.book_append_sheet(wb, keysWS, "Keys");
            
            // Active Loans
            const activeLoans = appData.loans.filter(l => l.status === 'active');
            const activeWS = XLSX.utils.json_to_sheet(activeLoans);
            XLSX.utils.book_append_sheet(wb, activeWS, "Active Loans");
            
            // Loan History
            const historyWS = XLSX.utils.json_to_sheet(appData.loans);
            XLSX.utils.book_append_sheet(wb, historyWS, "Loan History");
            
            // Sites
			if (appData.sites.length > 0) {
				const sitesWS = XLSX.utils.json_to_sheet(appData.sites);
				XLSX.utils.book_append_sheet(wb, sitesWS, "Sites");
			}

			// Technicians
			if (appData.technicians && appData.technicians.length > 0) {
				const techniciansWS = XLSX.utils.json_to_sheet(appData.technicians);
				XLSX.utils.book_append_sheet(wb, techniciansWS, "Technicians");
			}

			// Cabinets
			if (appData.cabinets && appData.cabinets.length > 0) {
				const cabinetsWS = XLSX.utils.json_to_sheet(appData.cabinets);
				XLSX.utils.book_append_sheet(wb, cabinetsWS, "Cabinets");
			}

            
            // Summary
            const summary = [{
                'Total Keys': appData.keys.length,
				'Available Keys': appData.keys.filter(k => k.available).length,
				'Active Loans': activeLoans.length,
				'Overdue Loans': getOverdueLoans().length,
				'Total Sites': appData.sites.length,
				'Total Technicians': appData.technicians ? appData.technicians.length : 0,
				'Total Cabinets': appData.cabinets ? appData.cabinets.length : 0,
				'Export Date': new Date().toLocaleString(),
				'Data Version': appData.version,
				'Last Backup': appData.metadata.lastBackup || 'Never',
				'Backup Count': appData.metadata.backupCount || 0
			}];
            const summaryWS = XLSX.utils.json_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, summaryWS, "Summary");
            
            XLSX.writeFile(wb, `keymanager-export-${timestamp}.xlsx`);
            showAlert('Data exported as Excel', 'success');
        }
        
        // Close any open modals
        document.querySelectorAll('.modal.show').forEach(modal => {
            modal.classList.remove('show');
        });
        
    } catch (error) {
        console.error('Export error:', error);
        showAlert('Export failed: ' + error.message, 'error');
    }
	// Cabinets
if (appData.cabinets && appData.cabinets.length > 0) {
    const cabinetsWS = XLSX.utils.json_to_sheet(appData.cabinets);
    XLSX.utils.book_append_sheet(wb, cabinetsWS, "Cabinets");
}
}

// Import Functions
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    
    if (file.name.endsWith('.json')) {
        // Import JSON
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                
                if (confirm('This will replace all current data. Are you sure?')) {
                    appData = { ...appData, ...imported };
                    saveAllDataToStorage();
                    updateDisplay();
                    loadPageContent(currentPage);
                    showAlert('Data imported successfully from JSON', 'success');
                }
            } catch (error) {
                showAlert('Import failed: ' + error.message, 'error');
            }
        };
        reader.readAsText(file);
        
    } else {
        // Import Excel
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                let imported = {
                    keys: 0,
                    loans: 0,
                    sites: 0,
					technicians: 0,
					cabinets: 0
                };
                
                // Import Keys
                if (workbook.SheetNames.includes('Keys')) {
                    const keysSheet = workbook.Sheets['Keys'];
                    const keysData = XLSX.utils.sheet_to_json(keysSheet);
                    appData.keys = keysData.map(row => ({
                        id: row.id || row.ID,
                        description: row.description || row.Description || '',
                        location: row.location || row.Location || 'Unspecified',
						locationNumber: row.locationNumber || row.locationNumber || 'Unspecified',
						KeyNumber: row.keyNumber || row.KeyNumber || '',
						KeySN: row.keySN || row.KeySN || '',
					
                        available: row.available === true || row.Available === 'Yes' || row.Available === true
                    }));
                    imported.keys = appData.keys.length;
                }
                
                // Import Loans
                if (workbook.SheetNames.includes('Active Loans') || workbook.SheetNames.includes('Loans')) {
                    const sheetName = workbook.SheetNames.includes('Active Loans') ? 'Active Loans' : 'Loans';
                    const loansSheet = workbook.Sheets[sheetName];
                    const loansData = XLSX.utils.sheet_to_json(loansSheet);
                    appData.loans = loansData;
                    imported.loans = appData.loans.length;
                }
                
                // Import Sites
                if (workbook.SheetNames.includes('Sites')) {
                    const sitesSheet = workbook.Sheets['Sites'];
                    const sitesData = XLSX.utils.sheet_to_json(sitesSheet);
                    appData.sites = sitesData;
                    imported.sites = appData.sites.length;
                }
                // Import Technicians
if (workbook.SheetNames.includes('Technicians')) {
    const techniciansSheet = workbook.Sheets['Technicians'];
    const techniciansData = XLSX.utils.sheet_to_json(techniciansSheet);
    appData.technicians = techniciansData;
    imported.technicians = appData.technicians.length;
}


                saveAllDataToStorage();
                updateDisplay();
                loadPageContent(currentPage);
                
                showAlert(`Import successful!\nKeys: ${imported.keys}\nLoans: ${imported.loans}\nSites: ${imported.sites}\nTechnicians: ${imported.technicians}\nCabinets: ${imported.cabinets}`, 'success');
				closeModal('importExportModal');
                
            } catch (error) {
                showAlert('Import failed: ' + error.message, 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    // Reset file input
    event.target.value = '';
	
	// Import Cabinets
		if (workbook.SheetNames.includes('Cabinets')) {
			const cabinetsSheet = workbook.Sheets['Cabinets'];
			const cabinetsData = XLSX.utils.sheet_to_json(cabinetsSheet);
			appData.cabinets = cabinetsData;
			imported.cabinets = appData.cabinets.length;
}
}

// Navigation functions
function navigateToPage(page) {
    // Update active nav item
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    const activeNav = document.querySelector(`[data-page="${page}"]`);
    if (activeNav) {
        activeNav.classList.add('active');
    }
    
    // Update header
    const headerInfo = {
        dashboard: {
            title: 'Dashboard',
            subtitle: 'Overview of key management operations',
            showQuickActions: true
        },
        keys: {
            title: 'Key Management',
            subtitle: 'Manage all keys in the system',
            showQuickActions: true
        },
        loans: {
            title: 'Active Loans',
            subtitle: 'View and manage current key loans',
            showQuickActions: true
        },
        history: {
            title: 'Loan History',
            subtitle: 'View completed and returned loans',
            showQuickActions: false
        },
        customers: {
            title: 'Customer Management',
            subtitle: 'View customer information and loan history',
            showQuickActions: false
        },
		technicians: {
            title: 'Technician Management',
            subtitle: 'Manage technician database and assignments',
            showQuickActions: false
        },
		keycabinet: {
			title: 'Key Cabinet Management',
			subtitle: 'Manage Key Cabinets data',
			showQuickActions: false
		},
        sites: {
            title: 'Site Management',
            subtitle: 'Manage site locations and access points',
            showQuickActions: false
        },
        reports: {
            title: 'Reports & Analytics',
            subtitle: 'Generate reports and view analytics',
            showQuickActions: false
        },
        settings: {
            title: 'Settings',
            subtitle: 'Configure system preferences',
            showQuickActions: false
        }
    };
    
    const info = headerInfo[page] || headerInfo.dashboard;
    const h2 = document.querySelector('.header-left h2');
    const subtitle = document.querySelector('.header-subtitle');
    
    if (h2) h2.textContent = info.title;
    if (subtitle) subtitle.textContent = info.subtitle;
    
    // Show/hide quick actions
    const headerActions = document.querySelector('.header-actions');
    if (headerActions) {
        headerActions.style.display = info.showQuickActions ? 'flex' : 'none';
    }
    
    currentPage = page;
    
    // Load page-specific content
    loadPageContent(page);
}

function loadPageContent(page) {
    const content = document.querySelector('.content');
    if (!content) return;
    
    switch(page) {
        case 'dashboard':
            loadDashboardContent(content);
            break;
        case 'keys':
            loadKeysContent(content);
            break;
        case 'loans':
            loadLoansContent(content);
            break;
        case 'history':
            loadHistoryContent(content);
            break;
        case 'customers':
            loadCustomersContent(content);
            break;
        case 'sites':
            loadSitesContent(content);
            break;
        case 'reports':
            loadReportsContent(content);
            break;
        case 'settings':
            loadSettingsContent(content);
            break;
		case 'technicians':
            loadTechniciansContent(content);
            break;
		    case 'keycabinet':
            loadKeyCabinetContent(content);
            break;
    }
}
function loadKeyCabinetContent(content) {
    const cabinets = appData.cabinets || [];
    const keys = appData.keys;
    
    // Calculate statistics
    let totalCapacity = 0;
    let totalKeysStored = 0;
    cabinets.forEach(cabinet => {
        totalCapacity += cabinet.capacity || 50;
        totalKeysStored += keys.filter(k => k.location === cabinet.name).length;
    });
    
    // If no cabinets exist, show empty state with add button
    if (cabinets.length === 0) {
        content.innerHTML = `
            <!-- Cabinet Statistics -->
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <span>üóÑÔ∏è</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Total Cabinets</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <span>üîë</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Keys Stored</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon yellow">
                        <span>üìä</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Total Capacity</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">
                        <span>üìà</span>
                    </div>
                    <div class="stat-details">
                        <div class="stat-value">0%</div>
                        <div class="stat-label">Utilization</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Key Cabinet Management</div>
                    <button class="btn btn-primary btn-sm" onclick="showAddCabinetModal()">
                        <span>‚ûï</span> Add First Cabinet
                    </button>
                </div>
                <div class="card-body">
                    <div class="empty-state">
                        <div class="empty-icon">üóÑÔ∏è</div>
                        <div class="empty-text">No cabinets configured</div>
                        <div class="empty-subtext">Add your first cabinet to start organizing keys</div>
                    </div>
                </div>
            </div>
        `;
        return;
    }
    
    // Show cabinets if they exist
    content.innerHTML = `
        <!-- Cabinet Statistics -->
        <div class="stats-grid" style="margin-bottom: 20px;">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <span>üóÑÔ∏è</span>
                </div>
                <div class="stat-details">
                    <div class="stat-value">${cabinets.length}</div>
                    <div class="stat-label">Total Cabinets</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">
                    <span>üîë</span>
                </div>
                <div class="stat-details">
                    <div class="stat-value">${totalKeysStored}</div>
                    <div class="stat-label">Keys Stored</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon yellow">
                    <span>üìä</span>
                </div>
                <div class="stat-details">
                    <div class="stat-value">${totalCapacity}</div>
                    <div class="stat-label">Total Capacity</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon ${totalCapacity > 0 && totalKeysStored/totalCapacity > 0.8 ? 'red' : 'green'}">
                    <span>üìà</span>
                </div>
                <div class="stat-details">
                    <div class="stat-value">${totalCapacity > 0 ? Math.round((totalKeysStored/totalCapacity) * 100) : 0}%</div>
                    <div class="stat-label">Utilization</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <div class="card-title">Key Cabinet Overview</div>
		
                <button class="btn btn-primary btn-sm" onclick="showAddCabinetModal()">
                    <span>‚ûï</span> Add Cabinet
                </button>
				
            </div>
            <div class="card-body">
                <!-- Cabinet Visual Overview -->
                <div class="tabs-container" style="margin-bottom: 30px;">
                    <div class="tabs-header">
                        ${cabinets.map((cab, index) => `
                            <button class="tab-button ${index === 0 ? 'active' : ''}" 
                                    data-tab="cabinet-${cab.id}">
                                ${cab.name}
                            </button>
                        `).join('')}
                    </div>
                    <div class="tab-content">
                        ${cabinets.map((cabinet, index) => {
                            const cabinetKeys = keys.filter(k => k.location === cabinet.name);
                            const maxSlots = cabinet.capacity || 50;
                            
                            return `
                            <div class="tab-panel ${index === 0 ? 'active' : ''}" id="cabinet-${cabinet.id}-panel">
								<div style="margin-bottom: 20px;">
									<div class="cabinet-info-row">
										<span><strong>Location:</strong> ${cabinet.location}</span>
										<span style="margin-left: 20px;"><strong>Capacity:</strong> ${cabinetKeys.length}/${maxSlots}</span>
										<span style="margin-left: 20px;"><strong>Last Audit:</strong> ${cabinet.lastAudit || 'Never'}</span>
									</div>
								</div>
                                
                                <div class="cabinet-visual">
                                    ${Array.from({length: Math.min(maxSlots, 50)}, (_, i) => {
                                        const slotNumber = i + 1;
                                        const keyInSlot = cabinetKeys.find(k => 
                                            k.locationNumber === `Hook ${String(slotNumber).padStart(2, '0')}`
                                        );
                                        
                                        if (keyInSlot) {
                                            const isOnLoan = !keyInSlot.available;
                                            return `
                                                <div class="cabinet-slot ${isOnLoan ? 'on-loan' : 'occupied'}" 
                                                     onclick="showKeyDetails('${keyInSlot.id}')"
                                                     title="${keyInSlot.id} - ${keyInSlot.description}">
                                                    <span class="slot-number">#${slotNumber}</span>
                                                    <div class="slot-key-icon">üîë</div>
                                                    <div class="slot-key-id">${keyInSlot.id}</div>
                                                    <div class="slot-status">${isOnLoan ? 'On Loan' : 'Available'}</div>
                                                </div>
                                            `;
                                        } else {
                                            return `
                                                <div class="cabinet-slot empty" 
         onclick="quickAddKeyToSlot('${cabinet.id}', '${cabinet.name}', ${slotNumber})"
         style="cursor: pointer;"
         title="Click to add key to this slot">
        <span class="slot-number">#${slotNumber}</span>
        <div class="slot-key-icon" style="opacity: 0.3;">üîì</div>
        <div class="slot-status">Empty</div>
        <div style="font-size: 0.7em; margin-top: 2px; opacity: 0.5;">Click to add</div>
    </div>
                                            `;
											
                                        }
                                    }).join('')}
                                </div>
                                
                                <div style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
									<button class="btn btn-primary btn-sm" onclick="showAddKeyToCabinet('${cabinet.id}', '${cabinet.name}')">
											<span>‚ûï</span> Add Key to Cabinet
									</button>
									<button class="btn btn-secondary btn-sm" onclick="editCabinet('${cabinet.id}')">Edit Cabinet</button>
									<button class="btn btn-primary btn-sm" onclick="auditCabinet('${cabinet.id}')">Perform Audit</button>
									<button class="btn btn-danger btn-sm" onclick="deleteCabinet('${cabinet.id}')">Delete Cabinet</button>
								</div>
								
                            </div>
							
                            `;
                        }).join('')}
						
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Setup tab switching for cabinets
    setupCabinetTabs();

    // Setup tab switching for cabinets
	//if (cabinets.length > 0) {
   //     setupCabinetTabs();
   // setupCabinetTabs();
}
function quickAddKeyToSlot(cabinetId, cabinetName, slotNumber) {
    document.getElementById('keylocation').value = cabinetName;
    document.getElementById('keylocationNumber').value = `Hook ${String(slotNumber).padStart(2, '0')}`;
    document.getElementById('addKeyModal').classList.add('show');
    
    const modalTitle = document.querySelector('#addKeyModal .modal-title');
    if (modalTitle) {
        modalTitle.textContent = `Add Key to ${cabinetName} - Slot #${slotNumber}`;
    }
}
function showAddKeyToCabinet(cabinetId, cabinetName) {
    // Pre-fill the location field with the selected cabinet
    document.getElementById('keylocation').value = cabinetName;
    
    // Get next available hook number for this cabinet
    const keys = getKeys();
    const cabinetKeys = keys.filter(k => k.location === cabinetName);
    const cabinet = appData.cabinets.find(c => c.id === cabinetId);
    
    if (cabinet && cabinetKeys.length >= cabinet.capacity) {
        showAlert(`Cabinet ${cabinetName} is at full capacity (${cabinet.capacity} keys)`, 'error');
        return;
    }
    
    // Suggest next available hook number
    const usedHooks = cabinetKeys.map(k => {
        const match = k.locationNumber ? k.locationNumber.match(/\d+/) : null;
        return match ? parseInt(match[0]) : 0;
    }).filter(n => n > 0);
    
    const nextHookNumber = findNextAvailableNumber(usedHooks, cabinet.capacity);
    document.getElementById('keylocationNumber').value = `Hook ${String(nextHookNumber).padStart(2, '0')}`;
    
    // Open the add key modal
    document.getElementById('addKeyModal').classList.add('show');
    
    // Update modal title to indicate cabinet context
    const modalTitle = document.querySelector('#addKeyModal .modal-title');
    if (modalTitle) {
        modalTitle.textContent = `Add New Key to ${cabinetName}`;
    }
}

function findNextAvailableNumber(usedNumbers, maxCapacity) {
    const sorted = [...new Set(usedNumbers)].sort((a, b) => a - b);
    
    // Find first gap in sequence
    for (let i = 1; i <= maxCapacity; i++) {
        if (!sorted.includes(i)) {
            return i;
        }
    }
    
    return sorted.length + 1;
}


// Content loading functions
function loadDashboardContent(content) {
    const keys = getKeys();
    const loans = getLoans();
    
    content.innerHTML = `
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <span>üîë</span>
                </div>
                <div class="stat-details">
                    <div class="stat-value" id="totalKeys">${keys.length}</div>
                    <div class="stat-label">Total Keys</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">
                    <span>‚úÖ</span>
                </div>
                <div class="stat-details">
                    <div class="stat-value" id="availableKeys">${keys.filter(k => k.available).length}</div>
                    <div class="stat-label">Available</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon yellow">
                    <span>üìã</span>
                </div>
                <div class="stat-details">
                    <div class="stat-value" id="loanedKeys">${loans.filter(l => l.status === 'active').length}</div>
                    <div class="stat-label">On Loan</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon red">
                    <span>‚ö†Ô∏è</span>
                </div>
                <div class="stat-details">
                    <div class="stat-value" id="overdueKeys">${getOverdueLoans().length}</div>
                    <div class="stat-label">Overdue</div>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <input type="text" class="search-input" id="globalSearch" placeholder="Search keys, customers, sites...">
        </div>

        <!-- Overdue Alert -->
        <div class="overdue-section" id="overdueAlert">
            <div class="overdue-header">
                <span style="font-size: 1.5em;">üö®</span>
                <div class="overdue-title">Overdue Keys - Action Required</div>
            </div>
            <div id="overdueList"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-button active" data-tab="available">Available Keys</button>
                <button class="tab-button" data-tab="loans">Active Loans</button>
                <button class="tab-button" data-tab="history">Recent History</button>
            </div>
            <div class="tab-content">
                <div class="tab-panel active" id="available-panel">
                    <div id="availableList"></div>
                </div>
                <div class="tab-panel" id="loans-panel">
                    <div id="loansList"></div>
                </div>
                <div class="tab-panel" id="history-panel">
                    <div id="historyList"></div>
                </div>
            </div>
        </div>
    `;
    
    // Re-setup tab listeners and search
    setupDashboardListeners();
    updateDisplay();
}

function loadKeysContent(content) {
    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <div class="card-title">All Keys</div>
                <button class="btn btn-primary btn-sm" onclick="showAddKeyModal()">
                    <span>‚ûï</span> Add Key
                </button>
            </div>
            <div class="card-body">
                <div class="search-section" style="margin-bottom: 20px;">
                    <input type="text" class="search-input" id="keySearch" placeholder="Search keys..." onkeyup="filterKeys(this.value)">
                </div>
                <div id="allKeysList"></div>
            </div>
        </div>
    `;
    displayAllKeys();
}

function loadLoansContent(content) {
    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <div class="card-title">Active Loans</div>
                <button class="btn btn-primary btn-sm" onclick="showQuickLoan()">
                    <span>‚ö°</span> New Loan
                </button>
            </div>
            <div class="card-body">
                <div id="activeLoansFullList"></div>
            </div>
        </div>
    `;
    displayActiveLoans();
}

function loadHistoryContent(content) {
    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <div class="card-title">Complete Loan History</div>
            </div>
            <div class="card-body">
                <div id="completeHistoryList"></div>
            </div>
        </div>
    `;
    displayCompleteHistory();
}

function loadCustomersContent(content) {
    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <div class="card-title">Customer Database</div>
            </div>
            <div class="card-body">
                <div id="customersList"></div>
            </div>
        </div>
    `;
    displayCustomers();
}

function loadSitesContent(content) {
    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <div class="card-title">Site Locations</div>
            </div>
            <div class="card-body">
                <div id="sitesList"></div>
            </div>
        </div>
    `;
    displaySites();
}

function loadReportsContent(content) {
    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <div class="card-title">Reports & Analytics</div>
            </div>
            <div class="card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="stat-card" style="cursor: pointer;" onclick="generateReport('monthly')">
                        <div class="stat-icon blue"><span>üìä</span></div>
                        <div class="stat-details">
                            <div class="stat-label">Monthly Report</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Generate monthly activity report</div>
                        </div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="generateReport('overdue')">
                        <div class="stat-icon red"><span>‚ö†Ô∏è</span></div>
                        <div class="stat-details">
                            <div class="stat-label">Overdue Report</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">View all overdue items</div>
                        </div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="generateReport('customer')">
                        <div class="stat-icon green"><span>üë•</span></div>
                        <div class="stat-details">
                            <div class="stat-label">Customer Report</div>
                            <div style="font-size: 0.9em; color: var(--text-secondary);">Customer loan history</div>
                        </div>
                    </div>
                </div>
                <div id="reportOutput" style="margin-top: 30px;"></div>
            </div>
        </div>
    `;
}

function loadSettingsContent(content) {
    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <div class="card-title">System Settings</div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-sm btn-success" onclick="quickSaveAll()">üíæ Save Now</button>
                    <button class="btn btn-sm btn-primary" onclick="createBackup('manual')">üì¶ Create Backup</button>
                    <button class="btn btn-sm btn-secondary" onclick="clearStorage()">üóëÔ∏è Clear Storage</button>
                </div>
            </div>
            <div class="card-body">
                <!-- Storage Status -->
                <div class="form-section">
                    <div class="form-section-title">üíæ Storage Status</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                            <strong>Data Size:</strong><br>
                            <span style="font-size: 1.5em; color: var(--primary);">${(JSON.stringify(appData).length / 1024).toFixed(2)} KB</span>
                        </div>
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                            <strong>Last Save:</strong><br>
                            <span style="font-size: 0.9em;">${appData.metadata.lastModified ? new Date(appData.metadata.lastModified).toLocaleString() : 'Never'}</span>
                        </div>
                        <div style="padding: 15px; background: var(--bg-secondary); border-radius: 8px;">
                            <strong>Last Backup:</strong><br>
                            <span style="font-size: 0.9em;">${appData.metadata.lastBackup ? new Date(appData.metadata.lastBackup).toLocaleString() : 'Never'}</span>
                        </div>
                    </div>
                    
                    <div id="fileSystemStatus">
                        ${fileSystemSupported ? `
                            <div class="file-manager-status ${appData.settings.fileSystemEnabled ? 'connected' : 'disconnected'}">
                                ${appData.settings.fileSystemEnabled && appData.metadata.autoSaveFile ? 
                                    `<strong>‚úÖ File System Connected</strong><br>
                                     Auto-save file: ${appData.metadata.autoSaveFile}<br>
                                     <button class="btn btn-sm btn-secondary" onclick="disconnectFileSystem()">Disconnect</button>` :
                                    `<strong>File System Available</strong><br>
                                     <button class="btn btn-sm btn-primary" onclick="selectAutoSaveFile()">Select Auto-Save File</button>`
                                }
                            </div>
                        ` : `
                            <div class="file-manager-status disconnected">
                                <strong>‚ö†Ô∏è File System Not Available</strong><br>
                                <small>Use Chrome or Edge for file system support</small>
                            </div>
                        `}
                    </div>
                </div>

                <!-- Auto-Save Settings -->
                <div class="form-section">
                    <div class="form-section-title">‚è±Ô∏è Auto-Save Settings</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Auto-Save Interval (minutes)</label>
                            <input type="number" id="autoSaveInterval" class="form-input" value="${appData.settings.autoSaveInterval}" min="1" max="60" style="max-width: 100px;">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Auto-Save Status</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label class="switch">
                                    <input type="checkbox" id="autoSaveToggle" ${autoSaveEnabled ? 'checked' : ''} onchange="toggleAutoSave()">
                                    <span style="margin-left: 5px;">${autoSaveEnabled ? 'Enabled' : 'Disabled'}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup Settings -->
                <div class="form-section">
                    <div class="form-section-title">üì¶ Backup Settings</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Backup Frequency</label>
                            <select id="backupFrequency" class="form-select" style="max-width: 200px;">
                                <option value="hourly" ${appData.settings.backupFrequency === 'hourly' ? 'selected' : ''}>Hourly</option>
                                <option value="daily" ${appData.settings.backupFrequency === 'daily' ? 'selected' : ''}>Daily</option>
                                <option value="weekly" ${appData.settings.backupFrequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                                <option value="monthly" ${appData.settings.backupFrequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                                <option value="manual" ${appData.settings.backupFrequency === 'manual' ? 'selected' : ''}>Manual Only</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Auto-Backup to Excel</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label class="switch">
                                    <input type="checkbox" id="autoBackupEnabled" ${appData.settings.autoBackupEnabled ? 'checked' : ''}>
                                    <span style="margin-left: 5px;">${appData.settings.autoBackupEnabled ? 'Enabled' : 'Disabled'}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backup History -->
                    <div style="margin-top: 20px;">
                        <h4>Recent Backups (${appData.backups.length})</h4>
                        <div id="backupList" style="max-height: 200px; overflow-y: auto;">
                            ${appData.backups.length > 0 ? appData.backups.map(backup => `
                                <div class="backup-item">
                                    <div class="backup-info">
                                        <div class="backup-name">${backup.id}</div>
                                        <div class="backup-meta">
                                            ${new Date(backup.timestamp).toLocaleString()} | 
                                            Type: ${backup.type} | 
                                            Size: ${(backup.size / 1024).toFixed(2)} KB
                                        </div>
                                    </div>
                                    <div class="backup-actions">
                                        <button class="btn btn-sm btn-secondary" onclick="restoreBackup('${backup.id}')">Restore</button>
                                        <button class="btn btn-sm btn-primary" onclick="exportBackupToExcel(appData.backups.find(b => b.id === '${backup.id}'))">Export</button>
                                    </div>
                                </div>
                            `).join('') : '<p style="color: var(--text-secondary);">No backups yet</p>'}
                        </div>
                    </div>
                </div>

                <!-- General Settings -->
                <div class="form-section">
                    <div class="form-section-title">‚öôÔ∏è General Settings</div>
                    <div class="form-group">
                        <label class="form-label">Default Loan Duration (days)</label>
                        <input type="number" id="defaultLoanDuration" class="form-input" value="${appData.settings.defaultLoanDuration}" style="max-width: 200px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Overdue Warning Threshold (days)</label>
                        <input type="number" id="overdueThreshold" class="form-input" value="${appData.settings.overdueThreshold}" style="max-width: 200px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Maximum Loan Extensions</label>
                        <input type="number" id="maxExtensions" class="form-input" value="${appData.settings.maxExtensions}" style="max-width: 200px;">
                    </div>
                </div>

                <!-- Export/Import Options -->
                <div class="form-section">
                    <div class="form-section-title">üì§ Export Options</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <button class="btn btn-primary" onclick="exportData('excel')">üìä Export Excel</button>
                        <button class="btn btn-secondary" onclick="exportData('json')">üìÑ Export JSON</button>
                        <button class="btn btn-secondary" onclick="createBackup('manual')">üì¶ Create Backup</button>
                        <button class="btn btn-warning" onclick="exportSettings()">‚öôÔ∏è Export Settings</button>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveSettings()">Save All Settings</button>
            </div>
        </div>
    `;
}

function setupDashboardListeners() {
    // Tab buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            const tab = this.getAttribute('data-tab');
            switchTab(tab);
        });
    });
    
    // Search
    const searchInput = document.getElementById('globalSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            performSearch(e.target.value);
        });
    }
}

// Display functions
function displayAllKeys() {
    const keys = getKeys();
    const container = document.getElementById('allKeysList');
    if (!container) return;
    
    container.innerHTML = keys.map(key => `
        <div class="key-item">
            <div class="key-header">
                <div>
                    <div class="key-id">${key.id}</div>
                    <div class="key-details">${key.description}</div>
                    <div class="key-meta">
                        <span>üìç ${key.location}</span>
                        ${key.locationNumber && key.locationNumber !== 'Unspecified' ? 
                            `<span>üìç Hook: ${key.locationNumber}</span>` : ''}
                    </div>
                    ${(key.keyNumber && key.keyNumber !== 'Unspecified') || 
                      (key.keySN && key.keySN !== 'Unspecified') ? 
                        `<div class="key-details">
                            ${key.keyNumber && key.keyNumber !== 'Unspecified' ? 
                                `Key #: ${key.keyNumber}` : ''}
                            ${key.keySN && key.keySN !== 'Unspecified' ? 
                                ` | SN: ${key.keySN}` : ''}
                        </div>` : ''}
                    
                    <!-- NEW: Display Technician Information -->
                    ${key.assignedTechnician && key.assignedTechnician !== 'Unassigned' ? 
                        `<div style="margin-top: 8px; padding: 6px 10px; background: rgba(59, 130, 246, 0.1); 
                                    border-radius: 6px; font-size: 0.85em;">
                            <span style="color: var(--primary);">
                                üë∑ <strong>Assigned to:</strong> ${key.assignedTechnician}
                                ${key.assignedDate ? ` | <strong>Since:</strong> ${new Date(key.assignedDate).toLocaleDateString()}` : ''}
                            </span>
                        </div>` : 
                        `<div style="margin-top: 8px; padding: 6px 10px; background: rgba(107, 114, 128, 0.1); 
                                    border-radius: 6px; font-size: 0.85em;">
                            <span style="color: var(--text-secondary);">
                                üë∑ Unassigned
                            </span>
                        </div>`
                    }
                </div>
                <span class="badge ${key.available ? 'badge-success' : 'badge-warning'}">
                    ${key.available ? 'Available' : 'On Loan'}
                </span>
            </div>
            ${key.available ? `
                <div class="key-actions">
                    <button class="btn btn-sm btn-primary" onclick="quickLoanKey('${key.id}')">Quick Loan</button>
        ${key.assignedTechnician && key.assignedTechnician !== 'Unassigned' ? 
            `<button class="btn btn-sm btn-secondary" onclick="reassignTechnician('${key.id}')">Reassign</button>
             <button class="btn btn-sm btn-warning" onclick="unassignKeyFromTechnician('${key.id}')">Return to Cabinet</button>` : 
            `<button class="btn btn-sm btn-secondary" onclick="assignTechnicianFromDB('${key.id}')">Assign Tech</button>`
        }
                </div>
            ` : ''}
        </div>
    `).join('');
	
	
}

function displayActiveLoans() {
    const loans = getLoans();
    const keys = getKeys();
    const activeLoans = loans.filter(l => l.status === 'active');
    const container = document.getElementById('activeLoansFullList');
    
    if (!container) return;
    
    if (activeLoans.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">No active loans</div></div>';
        return;
    }
    
    container.innerHTML = activeLoans.map(loan => {
        const key = keys.find(k => k.id === loan.keyId);
        const today = new Date().toISOString().split('T')[0];
        const isOverdue = loan.expectedReturnDate < today;
        const daysOverdue = isOverdue ? Math.floor((new Date(today) - new Date(loan.expectedReturnDate)) / (1000 * 60 * 60 * 24)) : 0;
        
        return `
            <div class="key-item">
                <div class="key-header">
                    <div>
                        <div class="key-id">${loan.keyId} - ${key ? key.description : 'Unknown'}</div>
                        <div class="key-details">
                            <strong>Customer:</strong> ${loan.customerName}<br>
                            <strong>Site:</strong> ${loan.siteName} (${loan.siteNumber})<br>
                            <strong>Loan Date:</strong> ${loan.loanDate}<br>
                            <strong>Due Date:</strong> ${loan.expectedReturnDate}
                            ${isOverdue ? `<br><span style="color: var(--danger);"><strong>‚ö†Ô∏è ${daysOverdue} days overdue</strong></span>` : ''}
                        </div>
                    </div>
                    <span class="badge ${isOverdue ? 'badge-danger' : 'badge-warning'}">
                        ${isOverdue ? 'Overdue' : 'Active'}
                    </span>
                </div>
                <div class="key-actions">
                    ${isOverdue ? `<button class="btn btn-sm btn-danger" onclick="sendReminder('${loan.id}')">Send Reminder</button>` : ''}
                    <button class="btn btn-sm btn-warning" onclick="showExtendModal('${loan.id}')">Extend</button>
                    <button class="btn btn-sm btn-success" onclick="showReturnModal('${loan.id}')">Return</button>
                </div>
            </div>
        `;
    }).join('');
}

function displayCompleteHistory() {
    const loans = getLoans();
    const keys = getKeys();
    const container = document.getElementById('completeHistoryList');
    
    if (!container) return;
    
    if (loans.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìö</div><div class="empty-text">No loan history</div></div>';
        return;
    }
    
    container.innerHTML = loans.map(loan => {
        const key = keys.find(k => k.id === loan.keyId);
        const statusBadge = loan.status === 'returned' ? 'badge-info' : 
                          loan.expectedReturnDate < new Date().toISOString().split('T')[0] ? 'badge-danger' : 'badge-warning';
        const statusText = loan.status === 'returned' ? 'Returned' : 
                         loan.expectedReturnDate < new Date().toISOString().split('T')[0] ? 'Overdue' : 'Active';
        
        return `
            <div class="key-item">
                <div class="key-header">
                    <div>
                        <div class="key-id">${loan.keyId} - ${key ? key.description : 'Unknown'}</div>
                        <div class="key-details">
                            <strong>Customer:</strong> ${loan.customerName}<br>
                            <strong>Period:</strong> ${loan.loanDate} ‚Üí ${loan.actualReturnDate || 'Not returned'}<br>
                            <strong>Site:</strong> ${loan.siteName}
                        </div>
                    </div>
                    <span class="badge ${statusBadge}">${statusText}</span>
                </div>
            </div>
        `;
    }).join('');
}

function displayCustomers() {
    const loans = getLoans();
    // Get unique customers from loans
    const customers = {};
    loans.forEach(loan => {
        if (!customers[loan.customerEmail]) {
            customers[loan.customerEmail] = {
                name: loan.customerName,
                email: loan.customerEmail,
                phone: loan.customerPhone,
                company: loan.customerCompany || 'N/A',
                loans: []
            };
        }
        customers[loan.customerEmail].loans.push(loan);
    });
    
    const container = document.getElementById('customersList');
    if (!container) return;
    
    const customerArray = Object.values(customers);
    
    if (customerArray.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-text">No customers yet</div></div>';
        return;
    }
    
    container.innerHTML = customerArray.map(customer => `
        <div class="key-item">
            <div class="key-header">
                <div>
                    <div class="key-id">${customer.name}</div>
                    <div class="key-details">
                        <strong>Email:</strong> ${customer.email}<br>
                        <strong>Phone:</strong> ${customer.phone}<br>
                        <strong>Company:</strong> ${customer.company}
                    </div>
                    <div class="key-meta">
                        <span>üìã ${customer.loans.length} loan(s)</span>
                        <span>‚úÖ ${customer.loans.filter(l => l.status === 'returned').length} returned</span>
                        <span>‚ö†Ô∏è ${customer.loans.filter(l => l.status === 'active').length} active</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function displaySites() {
    const loans = getLoans();
    // Get unique sites from loans
    const sites = {};
    loans.forEach(loan => {
        const siteKey = loan.siteNumber;
        if (!sites[siteKey]) {
            sites[siteKey] = {
                name: loan.siteName,
                number: loan.siteNumber,
                loans: []
            };
        }
        sites[siteKey].loans.push(loan);
    });
    
    const container = document.getElementById('sitesList');
    if (!container) return;
    
    const siteArray = Object.values(sites);
    
    if (siteArray.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üè¢</div><div class="empty-text">No sites recorded</div></div>';
        return;
    }
    
    container.innerHTML = siteArray.map(site => `
        <div class="key-item">
            <div class="key-header">
                <div>
                    <div class="key-id">${site.name}</div>
                    <div class="key-details">
                        <strong>Site Number:</strong> ${site.number}
                    </div>
                    <div class="key-meta">
                        <span>üîë ${site.loans.length} key loan(s)</span>
                        <span>üìÖ Last activity: ${site.loans[site.loans.length - 1].loanDate}</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function generateReport(type) {
    const output = document.getElementById('reportOutput');
    if (!output) return;
    
    const loans = getLoans();
    
    switch(type) {
        case 'monthly':
            const currentMonth = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            output.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Monthly Report - ${currentMonth}</div>
                    </div>
                    <div class="card-body">
                        <p><strong>Total Loans:</strong> ${loans.length}</p>
                        <p><strong>Active Loans:</strong> ${loans.filter(l => l.status === 'active').length}</p>
                        <p><strong>Returned Loans:</strong> ${loans.filter(l => l.status === 'returned').length}</p>
                        <p><strong>Overdue Loans:</strong> ${getOverdueLoans().length}</p>
                        <hr style="margin: 20px 0;">
                        <button class="btn btn-primary" onclick="window.print()">Print Report</button>
                    </div>
                </div>
            `;
            break;
            
        case 'overdue':
            const overdueLoans = getOverdueLoans();
            output.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Overdue Report</div>
                    </div>
                    <div class="card-body">
                        ${overdueLoans.length === 0 ? '<p>No overdue loans</p>' : 
                          overdueLoans.map(loan => {
                            const daysOverdue = Math.floor((new Date() - new Date(loan.expectedReturnDate)) / (1000 * 60 * 60 * 24));
                            return `
                                <div style="margin-bottom: 15px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                                    <strong>${loan.keyId}</strong> - ${loan.customerName}<br>
                                    Days Overdue: ${daysOverdue}<br>
                                    Contact: ${loan.customerEmail} | ${loan.customerPhone}
                                </div>
                            `;
                          }).join('')}
                    </div>
                </div>
            `;
            break;
            
        case 'customer':
            output.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Customer Activity Report</div>
                    </div>
                    <div class="card-body">
                        <p>Report generated with ${loans.length} total loan records</p>
                        <button class="btn btn-primary" onclick="exportData()">Export to Excel</button>
                    </div>
                </div>
            `;
            break;
    }
}
// Show add technician modal
function showAddTechnicianModal() {
    document.getElementById('technicianModalTitle').textContent = 'Add Technician';
    document.getElementById('technicianEditId').value = '';
    clearForm(['techName', 'techEmployeeId', 'techEmail', 'techPhone', 
               'techDepartment', 'techStatus', 'techHireDate', 'techCertLevel',
               'techSkills', 'techAreas', 'techNotes']);
    document.getElementById('techStatus').value = 'Active';
    document.getElementById('technicianModal').classList.add('show');
}
// Show edit technician modal
function editTechnician(techId) {
    const technicians = getTechnicians();
    const tech = technicians.find(t => t.id === techId);
    if (!tech) return;
    
    document.getElementById('technicianModalTitle').textContent = 'Edit Technician';
    document.getElementById('technicianEditId').value = tech.id;
    document.getElementById('techName').value = tech.name || '';
    document.getElementById('techEmployeeId').value = tech.employeeId || '';
    document.getElementById('techEmail').value = tech.email || '';
    document.getElementById('techPhone').value = tech.phone || '';
    document.getElementById('techDepartment').value = tech.department || '';
    document.getElementById('techStatus').value = tech.status || 'Active';
    document.getElementById('techHireDate').value = tech.hireDate || '';
    document.getElementById('techCertLevel').value = tech.certLevel || '';
    document.getElementById('techSkills').value = tech.skills || '';
    document.getElementById('techAreas').value = tech.areas || '';
    document.getElementById('techNotes').value = tech.notes || '';
    
    document.getElementById('technicianModal').classList.add('show');
}
// Save technician (add or update)
function saveTechnician() {
    const editId = document.getElementById('technicianEditId').value;
    const name = document.getElementById('techName').value.trim();
    const employeeId = document.getElementById('techEmployeeId').value.trim();
    const email = document.getElementById('techEmail').value.trim();
    const phone = document.getElementById('techPhone').value.trim();
    
    if (!name || !employeeId || !email || !phone) {
        showAlert('Please fill in all required fields', 'error');
        return;
    }
    
    const technicians = getTechnicians();
    
    // Check for duplicate employee ID (except when editing same technician)
    const duplicate = technicians.find(t => 
        t.employeeId === employeeId && t.id !== editId
    );
    if (duplicate) {
        showAlert('Employee ID already exists', 'error');
        return;
    }
    
    if (editId) {
        // Update existing technician
        const index = technicians.findIndex(t => t.id === editId);
        if (index !== -1) {
            technicians[index] = {
                ...technicians[index],
                name: name,
                employeeId: employeeId,
                email: email,
                phone: phone,
                department: document.getElementById('techDepartment').value,
                status: document.getElementById('techStatus').value,
                hireDate: document.getElementById('techHireDate').value,
                certLevel: document.getElementById('techCertLevel').value,
                skills: document.getElementById('techSkills').value.trim(),
                areas: document.getElementById('techAreas').value.trim(),
                notes: document.getElementById('techNotes').value.trim()
            };
            showAlert('Technician updated successfully', 'success');
        }
    } else {
        // Add new technician
        const newTech = {
            id: 'TECH-' + Date.now(),
            employeeId: employeeId,
            name: name,
            email: email,
            phone: phone,
            department: document.getElementById('techDepartment').value,
            status: document.getElementById('techStatus').value,
            hireDate: document.getElementById('techHireDate').value,
            certLevel: document.getElementById('techCertLevel').value,
            skills: document.getElementById('techSkills').value.trim(),
            areas: document.getElementById('techAreas').value.trim(),
            notes: document.getElementById('techNotes').value.trim(),
            assignedKeys: 0
        };
        
        technicians.push(newTech);
        showAlert('Technician added successfully', 'success');
    }
    
    markDataChanged();
    closeModal('technicianModal');
    
    // Refresh display if on technicians page
    if (currentPage === 'technicians') {
        loadTechniciansContent(document.querySelector('.content'));
    }
}

// Delete technician
function deleteTechnician(techId) {
    if (!confirm('Are you sure you want to delete this technician?')) return;
    
    const technicians = getTechnicians();
    const index = technicians.findIndex(t => t.id === techId);
    
    if (index !== -1) {
        // Check if technician has assigned keys
        const keys = getKeys();
        const assignedKeys = keys.filter(k => k.assignedTechnician === technicians[index].name);
        
        if (assignedKeys.length > 0) {
            if (!confirm(`This technician has ${assignedKeys.length} assigned keys. Deletion will unassign these keys. Continue?`)) {
                return;
            }
            // Unassign keys
            assignedKeys.forEach(key => {
                key.assignedTechnician = 'Unassigned';
                key.assignedDate = null;
            });
        }
        
        technicians.splice(index, 1);
        markDataChanged();
        showAlert('Technician deleted successfully', 'success');
        
        if (currentPage === 'technicians') {
            loadTechniciansContent(document.querySelector('.content'));
        }
    }
}

// Load technicians page content
function loadTechniciansContent(content) {
    const technicians = getTechnicians();
    
    // Update assigned keys count
    const keys = getKeys();
    technicians.forEach(tech => {
        tech.assignedKeys = keys.filter(k => k.assignedTechnician === tech.name).length;
    });
    
    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <div class="card-title">Technician Database</div>
                <button class="btn btn-primary btn-sm" onclick="showAddTechnicianModal()">
                    <span>+</span> Add Technician
                </button>
            </div>
            <div class="card-body">
                <div class="search-section" style="margin-bottom: 20px;">
                    <input type="text" class="search-input" id="techSearch" 
                           placeholder="Search technicians..." 
                           onkeyup="filterTechnicians(this.value)">
                </div>
                <div id="techniciansList">
                    ${technicians.length === 0 ? 
                        '<div class="empty-state"><div class="empty-icon">TECH</div><div class="empty-text">No technicians yet</div><div class="empty-subtext">Add technicians to manage key assignments</div></div>' :
                        technicians.map(tech => `
                            <div class="key-item">
                                <div class="key-header">
                                    <div>
                                        <div class="key-id">${tech.name}</div>
                                        <div class="key-details">
                                            <strong>Employee ID:</strong> ${tech.employeeId}<br>
                                            <strong>Email:</strong> ${tech.email}<br>
                                            <strong>Phone:</strong> ${tech.phone}<br>
                                            <strong>Department:</strong> ${tech.department || 'N/A'} | 
                                            <strong>Level:</strong> ${tech.certLevel || 'N/A'}
                                        </div>
                                        ${tech.skills ? `<div class="key-meta" style="margin-top: 8px;">
                                            <span>Skills: ${tech.skills}</span>
                                        </div>` : ''}
                                        ${tech.areas ? `<div class="key-meta">
                                            <span>Areas: ${tech.areas}</span>
                                        </div>` : ''}
                                        <div style="margin-top: 8px;">
                                            <span class="badge ${tech.status === 'Active' ? 'badge-success' : 
                                                               tech.status === 'On Leave' ? 'badge-warning' : 
                                                               'badge-danger'}">${tech.status}</span>
                                            <span class="badge badge-info" style="margin-left: 8px;">
                                                ${tech.assignedKeys} Keys Assigned
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="key-actions">
                                    <button class="btn btn-sm btn-primary" onclick="editTechnician('${tech.id}')">Edit</button>
									<button class="btn btn-sm btn-secondary" onclick="viewTechnicianKeys('${tech.id}')">View Keys</button>
									${tech.assignedKeys > 0 ? 
										`<button class="btn btn-sm btn-warning" onclick="unassignAllKeysFromTechnician('${tech.id}')">Unassign All Keys</button>` : 
										''}
									<button class="btn btn-sm btn-danger" onclick="deleteTechnician('${tech.id}')">Delete</button>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
        </div>
    `;
	
	
}
// Filter technicians
function filterTechnicians(searchTerm) {
    const technicians = getTechnicians();
    const filtered = technicians.filter(tech => 
        tech.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        tech.employeeId.toLowerCase().includes(searchTerm.toLowerCase()) ||
        tech.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (tech.department && tech.department.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (tech.skills && tech.skills.toLowerCase().includes(searchTerm.toLowerCase()))
    );
    
    const container = document.getElementById('techniciansList');
    if (!container) return;
    
    // Update assigned keys count
    const keys = getKeys();
    filtered.forEach(tech => {
        tech.assignedKeys = keys.filter(k => k.assignedTechnician === tech.name).length;
    });
    
    container.innerHTML = filtered.length === 0 ? 
        '<div class="empty-state"><div class="empty-icon">SEARCH</div><div class="empty-text">No technicians found</div></div>' :
        filtered.map(tech => `
            <div class="key-item">
                <div class="key-header">
                    <div>
                        <div class="key-id">${tech.name}</div>
                        <div class="key-details">
                            <strong>Employee ID:</strong> ${tech.employeeId}<br>
                            <strong>Email:</strong> ${tech.email}<br>
                            <strong>Phone:</strong> ${tech.phone}<br>
                            <strong>Department:</strong> ${tech.department || 'N/A'} | 
                            <strong>Level:</strong> ${tech.certLevel || 'N/A'}
                        </div>
                        ${tech.skills ? `<div class="key-meta" style="margin-top: 8px;">
                            <span>Skills: ${tech.skills}</span>
                        </div>` : ''}
                        <div style="margin-top: 8px;">
                            <span class="badge ${tech.status === 'Active' ? 'badge-success' : 
                                               tech.status === 'On Leave' ? 'badge-warning' : 
                                               'badge-danger'}">${tech.status}</span>
                            <span class="badge badge-info" style="margin-left: 8px;">
                                ${tech.assignedKeys} Keys Assigned
                            </span>
                        </div>
                    </div>
                </div>
                <div class="key-actions">
                    <button class="btn btn-sm btn-primary" onclick="editTechnician('${tech.id}')">Edit</button>
                    <button class="btn btn-sm btn-secondary" onclick="viewTechnicianKeys('${tech.id}')">View Keys</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteTechnician('${tech.id}')">Delete</button>
                </div>
            </div>
        `).join('');
}

// View keys assigned to a technician
function viewTechnicianKeys(techId) {
    const technicians = getTechnicians();
    const tech = technicians.find(t => t.id === techId);
    if (!tech) return;
    
    const keys = getKeys();
    const assignedKeys = keys.filter(k => k.assignedTechnician === tech.name);
    
    if (assignedKeys.length === 0) {
        showAlert('No keys assigned to this technician', 'info');
        return;
    }
    
    // Navigate to keys page with filter
    navigateToPage('keys');
    setTimeout(() => {
        const searchInput = document.getElementById('keySearch');
        if (searchInput) {
            searchInput.value = tech.name;
            filterKeys(tech.name);
        }
    }, 100);
}

// Updated assignTechnician function to use technician database
function assignTechnicianFromDB(keyId) {
    const technicians = getTechnicians().filter(t => t.status === 'Active');
    
    if (technicians.length === 0) {
        showAlert('No active technicians available. Please add technicians first.', 'warning');
        return;
    }
    
    // Create select options
    const options = technicians.map(tech => 
        `<option value="${tech.name}">${tech.name} - ${tech.department || 'N/A'}</option>`
    ).join('');
    
    // Create a temporary modal for selection
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Assign Technician to Key ${keyId}</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">X</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Technician</label>
                    <select id="tempTechSelect" class="form-select">
                        <option value="">Choose technician...</option>
                        ${options}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmTechAssignment('${keyId}')">Assign</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
function unassignAllKeysFromTechnician(techId) {
    const technicians = getTechnicians();
    const tech = technicians.find(t => t.id === techId);
    if (!tech) return;
    
    const keys = getKeys();
    const assignedKeys = keys.filter(k => k.assignedTechnician === tech.name && k.available);
    
    if (assignedKeys.length === 0) {
        showAlert('No keys assigned to this technician', 'info');
        return;
    }
    
    if (!confirm(`Unassign all ${assignedKeys.length} keys from ${tech.name}? Keys will need to be reassigned to cabinets.`)) {
        return;
    }
    
    // Unassign all keys
    assignedKeys.forEach(key => {
        key.assignedTechnician = 'Unassigned';
        key.assignedDate = null;
        // Keep location if it exists, otherwise set to Unassigned
        if (!key.location || key.location === '') {
            key.location = 'Unassigned';
            key.locationNumber = 'Unassigned';
        }
    });
    
    markDataChanged();
    showAlert(`${assignedKeys.length} keys unassigned from ${tech.name}`, 'success');
    
    // Refresh display
    if (currentPage === 'technicians') {
        loadTechniciansContent(document.querySelector('.content'));
    } else {
        updateDisplay();
    }
}

function confirmTechAssignment(keyId) {
    const select = document.getElementById('tempTechSelect');
    const techName = select ? select.value : null;
    
    if (!techName) {
        showAlert('Please select a technician', 'error');
        return;
    }
    
    const keys = getKeys();
    const key = keys.find(k => k.id === keyId);
    if (key) {
        key.assignedTechnician = techName;
        key.assignedDate = new Date().toISOString().split('T')[0];
        markDataChanged();
        showAlert(`Technician ${techName} assigned to key ${keyId}`, 'success');
        
        // Remove temporary modal
        const modal = select.closest('.modal');
        if (modal) modal.remove();
        
        // Refresh display
        updateDisplay();
        if (currentPage === 'keys') {
            displayAllKeys();
        }
    }
}




// Key Management Functions
function showAddKeyModal() {
    document.getElementById('addKeyModal').classList.add('show');
}

function showQuickLoan() {
    updateLoanKeyOptions();
    const loanModal = document.getElementById('loanModal');
    if (loanModal) {
        loanModal.classList.add('show');
    }
}

function quickLoanKey(keyId) {
    const key = getKeys().find(k => k.id === keyId);
    if (!key) {
        showAlert('Key not found', 'error');
        return;
    }
    if (!key.available) {
        showAlert('Key is not available for loan', 'error');
        return;
    }
    updateLoanKeyOptions();
    const loanKeySelect = document.getElementById('loanKeyId');
    if (loanKeySelect) {
        loanKeySelect.value = keyId;
    }
    const loanModal = document.getElementById('loanModal');
    if (loanModal) {
        loanModal.classList.add('show');
    }
}



function filterKeys(searchTerm) {
    const keys = getKeys();
    const filtered = keys.filter(key => 
        key.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
        key.description.toLowerCase().includes(searchTerm.toLowerCase()) ||
        key.location.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (key.locationNumber && key.locationNumber.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (key.keyNumber && key.keyNumber.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (key.keySN && key.keySN.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (key.assignedTechnician && key.assignedTechnician.toLowerCase().includes(searchTerm.toLowerCase()))
    );
    
    const container = document.getElementById('allKeysList');
    if (!container) return;
    
    container.innerHTML = filtered.map(key => `
        <div class="key-item">
            <div class="key-header">
                <div>
                    <div class="key-id">${key.id}</div>
                    <div class="key-details">${key.description}</div>
                    <div class="key-meta">
                        <span>üìç ${key.location}</span>
                        ${key.locationNumber && key.locationNumber !== 'Unspecified' ? 
                            `<span>üìç Hook: ${key.locationNumber}</span>` : ''}
                    </div>
                    ${(key.keyNumber && key.keyNumber !== 'Unspecified') || 
                      (key.keySN && key.keySN !== 'Unspecified') ? 
                        `<div class="key-details">
                            ${key.keyNumber && key.keyNumber !== 'Unspecified' ? 
                                `Key #: ${key.keyNumber}` : ''}
                            ${key.keySN && key.keySN !== 'Unspecified' ? 
                                ` | SN: ${key.keySN}` : ''}
                        </div>` : ''}
                    
                    <!-- Display Technician Information -->
                    ${key.assignedTechnician && key.assignedTechnician !== 'Unassigned' ? 
                        `<div style="margin-top: 8px; padding: 6px 10px; background: rgba(59, 130, 246, 0.1); 
                                    border-radius: 6px; font-size: 0.85em;">
                            <span style="color: var(--primary);">
                                üë∑ <strong>Assigned to:</strong> ${key.assignedTechnician}
                                ${key.assignedDate ? ` | <strong>Since:</strong> ${new Date(key.assignedDate).toLocaleDateString()}` : ''}
                            </span>
                        </div>` : 
                        `<div style="margin-top: 8px; padding: 6px 10px; background: rgba(107, 114, 128, 0.1); 
                                    border-radius: 6px; font-size: 0.85em;">
                            <span style="color: var(--text-secondary);">
                                üë∑ Unassigned
                            </span>
                        </div>`
                    }
                </div>
                <span class="badge ${key.available ? 'badge-success' : 'badge-warning'}">
                    ${key.available ? 'Available' : 'On Loan'}
                </span>
            </div>
            ${key.available ? `
                <div class="key-actions">
                    <button class="btn btn-sm btn-primary" onclick="quickLoanKey('${key.id}')">Quick Loan</button>
                    ${key.assignedTechnician && key.assignedTechnician !== 'Unassigned' ? 
                        `<button class="btn btn-sm btn-secondary" onclick="reassignTechnician('${key.id}')">Reassign</button>` : 
                        `<button class="btn btn-sm btn-secondary" onclick="assignTechnician('${key.id}')">Assign Tech</button>`
                    }
                </div>
            ` : ''}
        </div>
    `).join('');
}


// UPDATE 6: New functions to assign/reassign technicians
function assignTechnician(keyId) {
    const technician = prompt('Enter technician name:');
    if (technician && technician.trim()) {
        const keys = getKeys();
        const key = keys.find(k => k.id === keyId);
        if (key) {
            key.assignedTechnician = technician.trim();
            key.assignedDate = new Date().toISOString().split('T')[0];
            markDataChanged();
            showAlert(`Technician ${technician} assigned to key ${keyId}`, 'success');
            updateDisplay();
            if (currentPage === 'keys') {
                displayAllKeys();
            }
        }
    }
}

function reassignTechnician(keyId) {
    const keys = getKeys();
    const key = keys.find(k => k.id === keyId);
    if (key) {
        const currentTech = key.assignedTechnician;
        const newTechnician = prompt(`Current technician: ${currentTech}\nEnter new technician name:`);
        if (newTechnician && newTechnician.trim()) {
            key.assignedTechnician = newTechnician.trim();
            key.assignedDate = new Date().toISOString().split('T')[0];
            markDataChanged();
            showAlert(`Key ${keyId} reassigned from ${currentTech} to ${newTechnician}`, 'success');
            updateDisplay();
            if (currentPage === 'keys') {
                displayAllKeys();
            }
        }
    }
}

// UPDATE 7: Add updateKeysDisplay function to show technician info in dashboard
function updateKeysDisplay(keysToShow) {
    const container = document.getElementById('availableList');
    if (!container) return;
    
    if (keysToShow.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üîë</div><div class="empty-text">No available keys</div></div>';
        return;
    }

    container.innerHTML = keysToShow.map(key => `
        <div class="key-item">
            <div class="key-header">
                <div>
                    <div class="key-id">${key.id}</div>
                    <div class="key-details">${key.description}</div>
                    <div class="key-meta">
                        <span>üìç ${key.location}</span>
                        ${key.assignedTechnician && key.assignedTechnician !== 'Unassigned' ? 
                            `<span>üë∑ ${key.assignedTechnician}</span>` : ''}
                    </div>
                </div>
                <span class="badge badge-success">Available</span>
            </div>
        </div>
    `).join('');
}





function switchTab(tab) {
    // Update buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = document.querySelector(`[data-tab="${tab}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    
    // Update panels
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    const activePanel = document.getElementById(`${tab}-panel`);
    if (activePanel) {
        activePanel.classList.add('active');
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
    }
}

function addKey() {
    const keyId = document.getElementById('keyId').value.trim();
    const description = document.getElementById('keyDesc').value.trim();
    const location = document.getElementById('keylocation').value.trim();
    const keyNumber = document.getElementById('keyNumber').value.trim();
    const keySN = document.getElementById('keySN').value.trim();
    const locationNumber = document.getElementById('keylocationNumber').value.trim();
    const assignedTechnician = document.getElementById('assignedTechnician').value.trim();
    const assignedDate = document.getElementById('assignedDate').value;	

	if (location && location !== 'Unspecified') {
        const cabinet = appData.cabinets.find(c => c.name === location);
        if (cabinet) {
            const keysInCabinet = appData.keys.filter(k => k.location === cabinet.name);
            if (keysInCabinet.length >= cabinet.capacity) {
                showAlert(`Cabinet ${cabinet.name} is at full capacity`, 'error');
                return;
				}
			}
		}

    if (!keyId || !description) {
        showAlert('Please fill in required fields', 'error');
        return;
    }

    const keys = getKeys();
    if (keys.find(k => k.id === keyId)) {
        showAlert('Key ID already exists', 'error');
        return;
    }

    appData.keys.push({
        id: keyId,
        description: description,
        location: location || 'Unspecified',
        locationNumber: locationNumber || 'Unspecified',
        keyNumber: keyNumber || 'Unspecified',
        keySN: keySN || 'Unspecified',
        assignedTechnician: assignedTechnician || 'Unassigned',
        assignedDate: assignedDate || null,
        available: true
    });

    markDataChanged();
    showAlert('Key added successfully', 'success');
    closeModal('addKeyModal');
	clearForm(['keyId', 'keyDesc', 'keyLocation', 'keyNumber', 'keySN', 'keylocationNumber', 'assignedTechnician', 'assignedDate']);
    updateDisplay();
}

function updateLoanKeyOptions() {
    const keys = getKeys();
    const select = document.getElementById('loanKeyId');
    if (!select) return;
    
    // Clear existing options
    select.innerHTML = '<option value="">Choose a key...</option>';
    
    // Add available keys only
    keys.filter(k => k.available).forEach(key => {
        const option = document.createElement('option');
        option.value = key.id;
        option.textContent = `${key.id} - ${key.description}`;
        select.appendChild(option);
    });
}

function loanKey() {
    const keyId = document.getElementById('loanKeyId').value;
    const customerName = document.getElementById('customerName').value.trim();
    const customerEmail = document.getElementById('customerEmail').value.trim();
    const customerPhone = document.getElementById('customerPhone').value.trim();
    const siteName = document.getElementById('siteName').value.trim();
    const siteNumber = document.getElementById('siteNumber').value.trim();
    const siteAccessRequestNumber = document.getElementById('siteAccessRequestNumber').value.trim();
    const accessPurpose = document.getElementById('accessPurpose').value.trim();
    const loanType = document.getElementById('loanType').value;
    const expectedReturnDate = document.getElementById('expectedReturnDate').value;

    if (!keyId || !customerName || !customerEmail || !customerPhone || 
        !siteName || !siteNumber || !siteAccessRequestNumber || !accessPurpose ||
        !loanType || !expectedReturnDate) {
        showAlert('Please fill in all required fields', 'error');
        return;
    }

    const keys = getKeys();
    const key = keys.find(k => k.id === keyId);
    if (!key || !key.available) {
        showAlert('Selected key is not available', 'error');
        return;
    }

    const loan = {
        id: 'LOAN-' + Date.now(),
        keyId: keyId,
        customerName: customerName,
        customerCompany: document.getElementById('customerCompany').value.trim(),
        customerEmail: customerEmail,
        customerPhone: customerPhone,
        siteName: siteName,
        siteNumber: siteNumber,
        siteAccessRequestNumber: siteAccessRequestNumber,
        accessPurpose: accessPurpose,
        loanType: loanType,
        loanDate: new Date().toISOString().split('T')[0],
        expectedReturnDate: expectedReturnDate,
        loanComments: document.getElementById('loanComments').value.trim(),
        status: 'active'
    };

    appData.loans.push(loan);
    key.available = false;

    markDataChanged();
    showAlert(`Key ${keyId} loaned to ${customerName}`, 'success');
    closeModal('loanModal');
    clearForm(['loanKeyId', 'customerName', 'customerCompany', 'customerEmail', 
              'customerPhone', 'siteName', 'siteNumber', 'siteAccessRequestNumber', 
              'accessPurpose', 'loanType', 'expectedReturnDate', 'loanComments']);
    updateDisplay();
}

function showReturnModal(loanId) {
    const loans = getLoans();
    const loan = loans.find(l => l.id === loanId);
    if (!loan) return;
    
    currentReturnLoan = loan;
    const keys = getKeys();
    const key = keys.find(k => k.id === loan.keyId);
    
    const returnInfo = document.getElementById('returnInfo');
    if (returnInfo) {
        returnInfo.innerHTML = `
            <strong>Key:</strong> ${loan.keyId} - ${key ? key.description : 'Unknown'}<br>
            <strong>Customer:</strong> ${loan.customerName}<br>
            <strong>Loan Date:</strong> ${loan.loanDate}<br>
            <strong>Expected Return:</strong> ${loan.expectedReturnDate}
        `;
    }
    
    document.getElementById('returnModal').classList.add('show');
}

function processReturn() {
    if (!currentReturnLoan) return;

    const returnDate = document.getElementById('returnDate').value;
    const returnToName = document.getElementById('returnToName').value.trim();
    const returnLocation = document.getElementById('returnLocation').value.trim();

    if (!returnDate || !returnToName || !returnLocation) {
        showAlert('Please fill in all required fields', 'error');
        return;
    }

    currentReturnLoan.actualReturnDate = returnDate;
    currentReturnLoan.returnToName = returnToName;
    currentReturnLoan.returnLocation = returnLocation;
    currentReturnLoan.returnNotes = document.getElementById('returnNotes').value.trim();
    currentReturnLoan.status = 'returned';

    const keys = getKeys();
    const key = keys.find(k => k.id === currentReturnLoan.keyId);
    if (key) {
        key.available = true;
    }

    markDataChanged();
    showAlert('Key returned successfully', 'success');
    closeModal('returnModal');
    clearForm(['returnDate', 'returnToName', 'returnLocation', 'returnNotes']);
    updateDisplay();
}

function performSearch(query) {
    const lowerQuery = query.toLowerCase();
    
    if (!query) {
        updateDisplay();
        return;
    }

    const keys = getKeys();
    const loans = getLoans();
    
    const filteredKeys = keys.filter(key => 
        key.id.toLowerCase().includes(lowerQuery) ||
        key.description.toLowerCase().includes(lowerQuery) ||
        key.location.toLowerCase().includes(lowerQuery)
    );

    const filteredLoans = loans.filter(loan =>
        loan.customerName.toLowerCase().includes(lowerQuery) ||
        loan.siteName.toLowerCase().includes(lowerQuery)
    );

    updateKeysDisplay(filteredKeys.filter(k => k.available));
    updateLoansDisplay(filteredLoans.filter(l => l.status === 'active'));
}

function updateDisplay() {
    updateStats();
    const keys = getKeys();
    const loans = getLoans();
    updateKeysDisplay(keys.filter(k => k.available));
    updateLoansDisplay(loans.filter(l => l.status === 'active'));
    updateHistoryDisplay();
    updateOverdueAlert();
	// Handle different pages
    if (currentPage === 'keycabinet') {
        // Reload the Key Cabinet content
        loadKeyCabinetContent(document.querySelector('.content'));
    } else if (currentPage === 'dashboard') {
        const keys = getKeys();
        const loans = getLoans();
        updateKeysDisplay(keys.filter(k => k.available));
        updateLoansDisplay(loans.filter(l => l.status === 'active'));
        updateHistoryDisplay();
        updateOverdueAlert();
    }
}

function updateStats() {
    const keys = getKeys();
    const loans = getLoans();
    const totalKeys = keys.length;
    const availableKeys = keys.filter(k => k.available).length;
    const activeLoans = loans.filter(l => l.status === 'active').length;
    const overdueLoans = getOverdueLoans().length;

    const totalKeysEl = document.getElementById('totalKeys');
    const availableKeysEl = document.getElementById('availableKeys');
    const loanedKeysEl = document.getElementById('loanedKeys');
    const overdueKeysEl = document.getElementById('overdueKeys');
    
    if (totalKeysEl) totalKeysEl.textContent = totalKeys;
    if (availableKeysEl) availableKeysEl.textContent = availableKeys;
    if (loanedKeysEl) loanedKeysEl.textContent = activeLoans;
    if (overdueKeysEl) overdueKeysEl.textContent = overdueLoans;
}

function updateKeysDisplay(keysToShow) {
    const container = document.getElementById('availableList');
    if (!container) return;
    
    if (keysToShow.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üîë</div><div class="empty-text">No available keys</div></div>';
        return;
    }

    container.innerHTML = keysToShow.map(key => `
        <div class="key-item">
            <div class="key-header">
                <div>
                    <div class="key-id">${key.id}</div>
                    <div class="key-details">${key.description}</div>
                    <div class="key-meta">
                        <span>üìç ${key.location}</span>
                    </div>
                </div>
                <span class="badge badge-success">Available</span>
            </div>
        </div>
    `).join('');
}

function updateLoansDisplay(loansToShow) {
    const container = document.getElementById('loansList');
    if (!container) return;
    
    if (loansToShow.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><div class="empty-text">No active loans</div></div>';
        return;
    }

    const today = new Date().toISOString().split('T')[0];
    const keys = getKeys();

    container.innerHTML = loansToShow.map(loan => {
        const isOverdue = loan.expectedReturnDate < today;
        const key = keys.find(k => k.id === loan.keyId);
        const isCollected = loan.keyCollectedBy && loan.keyCollectionDate;
        const daysOverdue = isOverdue ? Math.floor((new Date(today) - new Date(loan.expectedReturnDate)) / (1000 * 60 * 60 * 24)) : 0;
        
        return `
            <div class="key-item">
                <div class="key-header">
                    <div>
                        <div class="key-id">${loan.keyId} - ${key ? key.description : 'Unknown'}</div>
                        <div class="key-details">
                            <strong>Customer:</strong> ${loan.customerName}<br>
                            <strong>Site:</strong> ${loan.siteName} (${loan.siteNumber})<br>
                            <strong>Due:</strong> ${loan.expectedReturnDate}
                            ${isOverdue ? `<br><span style="color: var(--danger);"><strong>‚ö†Ô∏è ${daysOverdue} days overdue</strong></span>` : ''}
                            ${loan.reminderCount ? `<br><span style="color: var(--text-secondary);">üìß ${loan.reminderCount} reminder(s) sent</span>` : ''}
                        </div>
                        <div class="key-meta">
                            <span>üìß ${loan.customerEmail}</span>
                            <span>üì± ${loan.customerPhone}</span>
                        </div>
                        ${isCollected ? `
                            <div style="margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                                ‚úÖ <strong>Collected by:</strong> ${loan.keyCollectedBy}<br>
                                <small>${new Date(loan.keyCollectionDate).toLocaleString()}</small>
                            </div>
                        ` : `
                            <div style="margin-top: 8px; padding: 8px; background: rgba(245, 158, 11, 0.1); border-radius: 6px;">
                                ‚ö†Ô∏è <strong>Awaiting Collection</strong>
                            </div>
                        `}
                    </div>
                    <span class="badge ${isOverdue ? 'badge-danger' : 'badge-warning'}">
                        ${isOverdue ? 'Overdue' : 'Active'}
                    </span>
                </div>
                <div class="key-actions">
                    ${!isCollected ? `
                        <button class="btn btn-sm btn-primary" onclick="showCollectionModal('${loan.id}')">Mark Collected</button>
                    ` : ''}
                    ${isOverdue ? `
                        <button class="btn btn-sm btn-danger" onclick="sendReminder('${loan.id}')">Send Reminder</button>
                    ` : ''}
                    <button class="btn btn-sm btn-warning" onclick="showExtendModal('${loan.id}')">Extend</button>
                    <button class="btn btn-sm btn-success" onclick="showReturnModal('${loan.id}')">Return</button>
                </div>
            </div>
        `;
    }).join('');
}

function updateHistoryDisplay() {
    const container = document.getElementById('historyList');
    if (!container) return;
    
    const loans = getLoans();
    const completedLoans = loans.filter(l => l.status === 'returned');
    
    if (completedLoans.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìö</div><div class="empty-text">No history yet</div></div>';
        return;
    }

    container.innerHTML = completedLoans.map(loan => `
        <div class="key-item">
            <div class="key-header">
                <div>
                    <div class="key-id">${loan.keyId}</div>
                    <div class="key-details">
                        <strong>Customer:</strong> ${loan.customerName}<br>
                        <strong>Period:</strong> ${loan.loanDate} ‚Üí ${loan.actualReturnDate}
                    </div>
                </div>
                <span class="badge badge-info">Returned</span>
            </div>
        </div>
    `).join('');
}

function updateOverdueAlert() {
    const overdueLoans = getOverdueLoans();
    const alert = document.getElementById('overdueAlert');
    const list = document.getElementById('overdueList');

    if (!alert || !list) return;

    if (overdueLoans.length === 0) {
        alert.classList.remove('show');
        return;
    }

    const keys = getKeys();
    list.innerHTML = overdueLoans.map(loan => {
        const daysOverdue = Math.floor((new Date() - new Date(loan.expectedReturnDate)) / (1000 * 60 * 60 * 24));
        const key = keys.find(k => k.id === loan.keyId);
        return `
            <div class="overdue-item">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <strong style="font-size: 1.1em;">${loan.keyId}</strong> - ${key ? key.description : 'Unknown'}<br>
                        <strong>Customer:</strong> ${loan.customerName}<br>
                        <strong>Email:</strong> ${loan.customerEmail}<br>
                        <strong>Phone:</strong> ${loan.customerPhone}<br>
                        <strong>Site:</strong> ${loan.siteName} (${loan.siteNumber})<br>
                        <span style="color: var(--danger); font-weight: 600;">
                            ‚ö†Ô∏è ${daysOverdue} days overdue (Due: ${loan.expectedReturnDate})
                        </span>
                        ${loan.reminderCount ? `
                            <div style="margin-top: 5px; font-size: 0.9em; color: var(--text-secondary);">
                                üìß ${loan.reminderCount} reminder(s) sent | Last: ${new Date(loan.lastReminderDate).toLocaleDateString()}
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-danger btn-sm" onclick="sendReminder('${loan.id}')">
                        üìß Send Reminder ${loan.reminderCount ? `(#${loan.reminderCount + 1})` : ''}
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="showExtendModal('${loan.id}')">üìÖ Extend</button>
                    <button class="btn btn-success btn-sm" onclick="showReturnModal('${loan.id}')">üîÑ Return</button>
                </div>
            </div>
        `;
    }).join('');

    alert.classList.add('show');
}

function getOverdueLoans() {
    const today = new Date().toISOString().split('T')[0];
    const loans = getLoans();
    return loans.filter(l => l.status === 'active' && l.expectedReturnDate < today);
}

// Additional Features Functions
function sendReminder(loanId) {
    const loans = getLoans();
    const loan = loans.find(l => l.id === loanId);
    if (!loan) return;

    // Update reminder count
    loan.reminderCount = (loan.reminderCount || 0) + 1;
    loan.lastReminderDate = new Date().toISOString();

    // Calculate days overdue
    const daysOverdue = Math.floor((new Date() - new Date(loan.expectedReturnDate)) / (1000 * 60 * 60 * 24));
    
    // Email details
    const subject = `URGENT: Overdue Key Return Required - ${loan.keyId} - ${daysOverdue} Days Overdue`;
    const body = `Dear ${loan.customerName},

This is reminder #${loan.reminderCount} regarding the overdue key that needs to be returned immediately.

KEY DETAILS:
- Key ID: ${loan.keyId}
- Site: ${loan.siteName} (${loan.siteNumber})
- Access Request: ${loan.siteAccessRequestNumber}
- Due Date: ${loan.expectedReturnDate}
- Days Overdue: ${daysOverdue}

IMMEDIATE ACTION REQUIRED:
Please return the key immediately to avoid:
‚Ä¢ Additional fees and penalties
‚Ä¢ Legal action
‚Ä¢ Suspension of future access privileges

If you need to extend the loan period or have any questions, please contact us immediately.

Best regards,
BAI Communications Site Management Team

This is an automated reminder. Failure to return the key may result in further action.`;

    // Open email client
    const mailtoLink = `mailto:${loan.customerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(mailtoLink, '_blank');

    markDataChanged();
    showAlert(`Reminder #${loan.reminderCount} sent to ${loan.customerName}`, 'success');
    updateDisplay();
}

function showExtendModal(loanId) {
    const loans = getLoans();
    const loan = loans.find(l => l.id === loanId);
    if (!loan) return;
    
    currentExtendLoan = loan;
    const keys = getKeys();
    const key = keys.find(k => k.id === loan.keyId);
    
    const extendInfo = document.getElementById('extendInfo');
    if (extendInfo) {
        extendInfo.innerHTML = `
            <strong>Key:</strong> ${loan.keyId} - ${key ? key.description : 'Unknown'}<br>
            <strong>Customer:</strong> ${loan.customerName}<br>
            <strong>Site:</strong> ${loan.siteName} (${loan.siteNumber})<br>
            <strong>Current Due Date:</strong> ${loan.expectedReturnDate}
        `;
    }
    
    const currentDueDate = document.getElementById('currentDueDate');
    if (currentDueDate) {
        currentDueDate.value = loan.expectedReturnDate;
    }
    
    // Set minimum date to tomorrow
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const newDueDate = document.getElementById('newDueDate');
    if (newDueDate) {
        newDueDate.min = tomorrow.toISOString().split('T')[0];
        
        // Suggest 7 days extension by default
        const suggestedDate = new Date(loan.expectedReturnDate);
        suggestedDate.setDate(suggestedDate.getDate() + 7);
        newDueDate.value = suggestedDate.toISOString().split('T')[0];
    }
    
    document.getElementById('extendModal').classList.add('show');
}

function setExtension(days) {
    if (!currentExtendLoan) return;
    const newDate = new Date(currentExtendLoan.expectedReturnDate);
    newDate.setDate(newDate.getDate() + days);
    const newDueDateEl = document.getElementById('newDueDate');
    if (newDueDateEl) {
        newDueDateEl.value = newDate.toISOString().split('T')[0];
    }
}

function processExtend() {
    if (!currentExtendLoan) return;

    const newDueDate = document.getElementById('newDueDate').value;
    const extensionReason = document.getElementById('extensionReason').value.trim();

    if (!newDueDate) {
        showAlert('Please select a new due date', 'error');
        return;
    }

    if (newDueDate <= currentExtendLoan.expectedReturnDate) {
        showAlert('New due date must be after current due date', 'error');
        return;
    }

    // Initialize extension history if it doesn't exist
    if (!currentExtendLoan.extensionHistory) {
        currentExtendLoan.extensionHistory = [];
    }

    // Record the extension
    currentExtendLoan.extensionHistory.push({
        oldDueDate: currentExtendLoan.expectedReturnDate,
        newDueDate: newDueDate,
        reason: extensionReason || 'No reason provided',
        extendedOn: new Date().toISOString().split('T')[0]
    });

    // Update the due date
    currentExtendLoan.expectedReturnDate = newDueDate;

    markDataChanged();
    showAlert(`Due date extended to ${newDueDate}`, 'success');
    closeModal('extendModal');
    clearForm(['extensionReason']);
    updateDisplay();
}

function showCollectionModal(loanId) {
    const loans = getLoans();
    const loan = loans.find(l => l.id === loanId);
    if (!loan) return;
    
    currentCollectionLoan = loan;
    const keys = getKeys();
    const key = keys.find(k => k.id === loan.keyId);
    
    const collectionInfo = document.getElementById('collectionInfo');
    if (collectionInfo) {
        collectionInfo.innerHTML = `
            <strong>Key:</strong> ${loan.keyId} - ${key ? key.description : 'Unknown'}<br>
            <strong>Customer:</strong> ${loan.customerName}<br>
            <strong>Email:</strong> ${loan.customerEmail}<br>
            <strong>Phone:</strong> ${loan.customerPhone}<br>
            <strong>Site:</strong> ${loan.siteName} (${loan.siteNumber})<br>
            <strong>Access Request:</strong> ${loan.siteAccessRequestNumber}
        `;
    }
    
    // Set current date and time as default
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    const keyCollectionDate = document.getElementById('keyCollectionDate');
    if (keyCollectionDate) {
        keyCollectionDate.value = localDateTime;
    }
    
    // Default to customer name
    const keyCollectedBy = document.getElementById('keyCollectedBy');
    if (keyCollectedBy) {
        keyCollectedBy.value = loan.customerName;
    }
    
    document.getElementById('collectionModal').classList.add('show');
}

function processCollection() {
    if (!currentCollectionLoan) return;

    const collectionDate = document.getElementById('keyCollectionDate').value;
    const collectedBy = document.getElementById('keyCollectedBy').value.trim();
    const collectionNotes = document.getElementById('keyCollectionNotes').value.trim();
    const sendEmail = document.getElementById('sendCollectionEmail').checked;
    const printReceipt = document.getElementById('printCollectionReceipt').checked;

    if (!collectionDate || !collectedBy) {
        showAlert('Please fill in all required fields', 'error');
        return;
    }

    // Update loan with collection details
    currentCollectionLoan.keyCollectionDate = collectionDate;
    currentCollectionLoan.keyCollectedBy = collectedBy;
    currentCollectionLoan.keyCollectionNotes = collectionNotes;

    // Send email if requested
    if (sendEmail) {
        sendCollectionEmail(currentCollectionLoan);
    }

    // Print receipt if requested
    if (printReceipt) {
        printCollectionReceipt(currentCollectionLoan);
    }

    markDataChanged();
    showAlert(`Key collection confirmed for ${collectedBy}`, 'success');
    closeModal('collectionModal');
    clearForm(['keyCollectedBy', 'keyCollectionNotes']);
    updateDisplay();
}

function sendCollectionEmail(loan) {
    const keys = getKeys();
    const key = keys.find(k => k.id === loan.keyId);
    const subject = `BAI Communications - Key Collection Confirmation - ${loan.keyId}`;
    
    const emailBody = `Dear ${loan.customerName},

This email confirms that the following key has been collected:

KEY DETAILS:
- Key ID: ${loan.keyId}
- Description: ${key ? key.description : 'N/A'}
- Location: ${key ? key.location : 'N/A'}

COLLECTION DETAILS:
- Collected By: ${loan.keyCollectedBy}
- Collection Date: ${new Date(loan.keyCollectionDate).toLocaleString()}
- Site: ${loan.siteName} (${loan.siteNumber})
- Access Request: ${loan.siteAccessRequestNumber}
${loan.keyCollectionNotes ? `- Notes: ${loan.keyCollectionNotes}` : ''}

LOAN DETAILS:
- Loan Type: ${loan.loanType || 'Temporary'}
- Expected Return Date: ${loan.expectedReturnDate}

IMPORTANT REMINDERS:
‚Ä¢ Please return the key by the due date
‚Ä¢ Keep this key secure at all times
‚Ä¢ Do not duplicate or share this key
‚Ä¢ Report any loss or damage immediately
‚Ä¢ Follow all site safety and security procedures

TERMS & CONDITIONS:
By collecting this key, you agree to:
1. Use the key only for authorized purposes
2. Return the key in the same condition as received
3. Accept liability for any loss or damage
4. Comply with all site regulations and safety requirements

If you need to extend the return date or have any questions, please contact us immediately.

Thank you for your cooperation.

Best regards,
BAI Communications Site Management Team

----------------------------------
BAI Communications | www.baicommunications.com
This is an automated confirmation. Please keep this email for your records.
Reference: ${loan.id}`;

    // Create mailto link
    const mailtoLink = `mailto:${loan.customerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
    
    // Open email client
    window.open(mailtoLink, '_blank');
    
    console.log('Collection email prepared for:', loan.customerEmail);
}

function printCollectionReceipt(loan) {
    const keys = getKeys();
    const key = keys.find(k => k.id === loan.keyId);
    const collectionDateTime = new Date(loan.keyCollectionDate).toLocaleString();
    
    const receiptHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Key Collection Receipt - ${loan.keyId}</title>
            <style>
                @page { 
                    size: A4; 
                    margin: 10mm;
                }
                body { 
                    font-family: -apple-system, Arial, sans-serif; 
                    font-size: 10px;
                    line-height: 1.3; 
                    color: #333;
                    max-width: 190mm;
                    margin: 0 auto;
                    padding: 0;
                }
                .header {
                    text-align: center;
                    border-bottom: 2px solid #3b82f6;
                    padding-bottom: 8px;
                    margin-bottom: 12px;
                }
                .logo {
                    display: inline-block;
                    background: #3b82f6;
                    color: white;
                    padding: 6px 12px;
                    border-radius: 4px;
                    font-weight: bold;
                    font-size: 14px;
                    margin-bottom: 6px;
                }
                h1 {
                    color: #1f2937;
                    margin: 6px 0;
                    font-size: 18px;
                }
                .receipt-num {
                    font-size: 9px;
                    color: #6b7280;
                }
                .info-grid {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 10px;
                    margin: 12px 0;
                }
                .info-box {
                    border: 1px solid #e5e7eb;
                    padding: 8px;
                    border-radius: 4px;
                    background: #f9fafb;
                }
                .info-box h3 {
                    color: #3b82f6;
                    margin: 0 0 6px 0;
                    font-size: 10px;
                    text-transform: uppercase;
                    border-bottom: 1px solid #e5e7eb;
                    padding-bottom: 3px;
                }
                .info-row {
                    margin: 4px 0;
                    font-size: 9px;
                    line-height: 1.2;
                }
                .label {
                    font-weight: 600;
                    display: inline;
                }
                .terms {
                    background: #fffbeb;
                    border: 1px solid #fbbf24;
                    padding: 8px;
                    margin: 12px 0;
                    border-radius: 4px;
                }
                .terms h3 {
                    color: #92400e;
                    margin: 0 0 6px 0;
                    font-size: 10px;
                    text-transform: uppercase;
                }
                .terms-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 8px;
                    font-size: 8px;
                    line-height: 1.3;
                }
                .term-item {
                    display: flex;
                    gap: 4px;
                }
                .term-item strong {
                    flex-shrink: 0;
                }
                .signature-section {
                    border: 1px solid #3b82f6;
                    padding: 10px;
                    margin: 12px 0;
                    border-radius: 4px;
                    background: #eff6ff;
                }
                .agreement-text {
                    font-size: 9px;
                    font-weight: 600;
                    margin-bottom: 8px;
                }
                .signature-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    margin-top: 10px;
                }
                .signature-field {
                    text-align: center;
                }
                .signature-line {
                    border-bottom: 1px solid #3b82f6;
                    height: 25px;
                    margin-bottom: 3px;
                }
                .signature-label {
                    font-size: 8px;
                    color: #6b7280;
                    line-height: 1.2;
                }
                .footer {
                    text-align: center;
                    font-size: 8px;
                    color: #6b7280;
                    margin-top: 12px;
                    padding-top: 8px;
                    border-top: 1px solid #e5e7eb;
                }
                .important {
                    background: #fee;
                    border-left: 3px solid #ef4444;
                    padding: 6px 8px;
                    margin: 10px 0;
                    font-size: 9px;
                    font-weight: 600;
                }
                .compact-row {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">BAI COMMUNICATIONS</div>
                <h1>KEY COLLECTION RECEIPT</h1>
                <div class="receipt-num">Receipt #: ${loan.id} | Date: ${collectionDateTime}</div>
            </div>

            <div class="info-grid">
                <div class="info-box">
                    <h3>KEY DETAILS</h3>
                    <div class="info-row"><span class="label">ID:</span> ${loan.keyId}</div>
                    <div class="info-row"><span class="label">Desc:</span> ${key ? key.description : 'N/A'}</div>
                    <div class="info-row"><span class="label">Loc:</span> ${key ? key.location : 'N/A'}</div>
                </div>
                
                <div class="info-box">
                    <h3>CUSTOMER</h3>
                    <div class="info-row"><span class="label">Name:</span> ${loan.customerName}</div>
                    <div class="info-row"><span class="label">Phone:</span> ${loan.customerPhone}</div>
                    <div class="info-row"><span class="label">Email:</span> ${loan.customerEmail}</div>
                </div>
                
                <div class="info-box">
                    <h3>SITE INFO</h3>
                    <div class="info-row"><span class="label">Site:</span> ${loan.siteName}</div>
                    <div class="info-row"><span class="label">Site #:</span> ${loan.siteNumber}</div>
                    <div class="info-row"><span class="label">SAR:</span> ${loan.siteAccessRequestNumber}</div>
                </div>
            </div>

            <div class="compact-row">
                <div class="info-box">
                    <h3>COLLECTION</h3>
                    <div class="info-row"><span class="label">By:</span> ${loan.keyCollectedBy}</div>
                    <div class="info-row"><span class="label">Date:</span> ${collectionDateTime}</div>
                </div>
                
                <div class="info-box">
                    <h3>LOAN DETAILS</h3>
                    <div class="info-row"><span class="label">Type:</span> ${loan.loanType || 'Temporary'}</div>
                    <div class="info-row"><span class="label">Return:</span> <strong>${loan.expectedReturnDate}</strong></div>
                </div>
            </div>

            <div class="terms">
                <h3>TERMS AND CONDITIONS</h3>
                <div class="terms-grid">
                    <div class="term-item">
                        <strong>1.</strong> 
                        <span>Key for authorized purposes only</span>
                    </div>
                    <div class="term-item">
                        <strong>2.</strong> 
                        <span>No duplication or sharing permitted</span>
                    </div>
                    <div class="term-item">
                        <strong>3.</strong> 
                        <span>Liable for loss/damage costs</span>
                    </div>
                    <div class="term-item">
                        <strong>4.</strong> 
                        <span>Must return by due date</span>
                    </div>
                    <div class="term-item">
                        <strong>5.</strong> 
                        <span>Follow all site safety rules</span>
                    </div>
                    <div class="term-item">
                        <strong>6.</strong> 
                        <span>Access designated areas only</span>
                    </div>
                    <div class="term-item">
                        <strong>7.</strong> 
                        <span>Report loss immediately</span>
                    </div>
                    <div class="term-item">
                        <strong>8.</strong> 
                        <span>Access can be revoked anytime</span>
                    </div>
                </div>
            </div>

            <div class="important">
                IMPORTANT: Non-compliance will result in penalties and possible legal action
            </div>

            <div class="signature-section">
                <div class="agreement-text">
                    ACKNOWLEDGMENT: I agree to comply with all terms and conditions
                </div>
                <div class="signature-grid">
                    <div class="signature-field">
                        <div class="signature-line"></div>
                        <div class="signature-label">
                            <strong>Key Recipient</strong><br>
                            ${loan.keyCollectedBy} | ${new Date().toLocaleDateString()}
                        </div>
                    </div>
                    <div class="signature-field">
                        <div class="signature-line"></div>
                        <div class="signature-label">
                            <strong>BAI Representative</strong><br>
                            ${new Date().toLocaleDateString()}
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <strong>BAI Communications</strong> | www.baicommunications.com | Keep for your records
            </div>

            <div class="no-print" style="text-align: center; margin-top: 20px;">
                <button onclick="window.print()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                    Print Receipt
                </button>
            </div>
        </body>
        </html>
    `;

    // Open print window
    const printWindow = window.open('', '_blank', 'width=800,height=900');
    printWindow.document.write(receiptHTML);
    printWindow.document.close();
    printWindow.focus();
    
    // Auto-trigger print dialog after content loads
    printWindow.onload = function() {
        printWindow.print();
    };
}

// Settings Functions
function saveSettings() {
    // Get values from form
    const autoSaveIntervalEl = document.getElementById('autoSaveInterval');
    const backupFrequencyEl = document.getElementById('backupFrequency');
    const autoBackupEnabledEl = document.getElementById('autoBackupEnabled');
    const defaultLoanDurationEl = document.getElementById('defaultLoanDuration');
    const overdueThresholdEl = document.getElementById('overdueThreshold');
    const maxExtensionsEl = document.getElementById('maxExtensions');
    
    if (autoSaveIntervalEl) {
        appData.settings.autoSaveInterval = parseInt(autoSaveIntervalEl.value) || appData.settings.autoSaveInterval;
    }
    if (backupFrequencyEl) {
        appData.settings.backupFrequency = backupFrequencyEl.value || appData.settings.backupFrequency;
    }
    if (autoBackupEnabledEl) {
        appData.settings.autoBackupEnabled = autoBackupEnabledEl.checked;
    }
    if (defaultLoanDurationEl) {
        appData.settings.defaultLoanDuration = parseInt(defaultLoanDurationEl.value) || appData.settings.defaultLoanDuration;
    }
    if (overdueThresholdEl) {
        appData.settings.overdueThreshold = parseInt(overdueThresholdEl.value) || appData.settings.overdueThreshold;
    }
    if (maxExtensionsEl) {
        appData.settings.maxExtensions = parseInt(maxExtensionsEl.value) || appData.settings.maxExtensions;
    }
    
    // Restart auto-save with new interval
    if (autoSaveEnabled) {
        startAutoSave();
    }
    
    // Restart auto-backup with new settings
    startAutoBackup();
    
    markDataChanged();
    showAlert('Settings saved successfully', 'success');
}

function exportSettings() {
    try {
        const settingsData = {
            settings: appData.settings,
            exportDate: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(settingsData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `settings-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        showAlert('Settings exported successfully', 'success');
    } catch (error) {
        console.error('Export settings error:', error);
        showAlert('Failed to export settings: ' + error.message, 'error');
    }
}

function toggleAutoSave() {
    const autoSaveToggle = document.getElementById('autoSaveToggle');
    autoSaveEnabled = autoSaveToggle ? autoSaveToggle.checked : true;
    
    if (autoSaveEnabled) {
        startAutoSave();
    } else if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
        autoSaveInterval = null;
    }
}

function quickSaveAll() {
    saveAllDataToStorage();
    showAlert('All data saved successfully', 'success');
}

function clearStorage() {
    if (confirm('‚ö†Ô∏è WARNING: This will delete ALL data including keys, loans, history, and settings. Are you sure?')) {
        if (confirm('This action CANNOT be undone. Are you absolutely sure you want to delete everything?')) {
            localStorage.clear();
            appData = {
                version: '2.0.0',
                metadata: {
                    lastModified: null,
                    lastBackup: null,
                    backupCount: 0,
                    fileHandle: null,
                    autoSaveFile: null
                },
                keys: [],
                loans: [],
                sites: [],
                settings: {
                    dbLocation: 'Browser Storage',
                    backupFrequency: 'daily',
                    autoSaveInterval: 5,
                    defaultLoanDuration: 7,
                    overdueThreshold: 2,
                    maxExtensions: 3,
                    autoReminders: true,
                    collectionEmails: true,
                    returnConfirmations: true,
                    autoBackupEnabled: true,
                    fileSystemEnabled: false,
                    termsText: appData.settings.termsText,
                    legalText: appData.settings.legalText
                },
                backups: []
            };
            showAlert('All data cleared', 'success');
            navigateToPage('dashboard');
        }
    }
}

// Utility Functions
function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    if (!alertContainer) return;
    
    const alertId = 'alert-' + Date.now();
    
    const alert = document.createElement('div');
    alert.id = alertId;
    alert.className = `alert alert-${type} show`;
    alert.textContent = message;
    
    alertContainer.appendChild(alert);
    
    setTimeout(() => {
        const element = document.getElementById(alertId);
        if (element) {
            element.classList.remove('show');
            setTimeout(() => element.remove(), 300);
        }
    }, 3000);
}

function clearForm(fieldIds) {
    fieldIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.value = '';
        }
    });
}

// Make functions globally accessible
window.showReturnModal = showReturnModal;
window.showExtendModal = showExtendModal;
window.showCollectionModal = showCollectionModal;
window.sendReminder = sendReminder;
window.setExtension = setExtension;
window.closeModal = closeModal;
window.showAddKeyModal = showAddKeyModal;
window.showQuickLoan = showQuickLoan;
window.quickLoanKey = quickLoanKey;
window.updateLoanKeyOptions = updateLoanKeyOptions;
window.filterKeys = filterKeys;
window.generateReport = generateReport;
window.exportData = exportData;
window.saveSettings = saveSettings;
window.exportSettings = exportSettings;
window.clearStorage = clearStorage;
window.quickSaveAll = quickSaveAll;
window.toggleAutoSave = toggleAutoSave;
window.createBackup = createBackup;
window.restoreBackup = restoreBackup;
window.selectAutoSaveFile = selectAutoSaveFile;
window.disconnectFileSystem = disconnectFileSystem;
window.exportBackupToExcel = exportBackupToExcel;
window.showExportOptions = showExportOptions;
window.assignTechnician = assignTechnician;
window.reassignTechnician = reassignTechnician;
window.showAddTechnicianModal = showAddTechnicianModal;
window.editTechnician = editTechnician;
window.saveTechnician = saveTechnician;
window.deleteTechnician = deleteTechnician;
window.viewTechnicianKeys = viewTechnicianKeys;
window.filterTechnicians = filterTechnicians;
window.assignTechnicianFromDB = assignTechnicianFromDB;
window.confirmTechAssignment = confirmTechAssignment;
window.showAddCabinetModal = showAddCabinetModal;
window.addCabinet = addCabinet;
window.editCabinet = editCabinet;
window.updateCabinet = updateCabinet;
window.auditCabinet = auditCabinet;
window.showKeyDetails = showKeyDetails;
window.deleteCabinet = deleteCabinet;
window.unassignKeyFromTechnician = unassignKeyFromTechnician;
window.confirmUnassignment = confirmUnassignment;
window.unassignAllKeysFromTechnician = unassignAllKeysFromTechnician;
window.setupCabinetTabs = setupCabinetTabs;
window.showAddKeyToCabinet = showAddKeyToCabinet;
window.findNextAvailableNumber = findNextAvailableNumber;
window.quickAddKeyToSlot = quickAddKeyToSlot;
	
	</script>
</body>
</html>
