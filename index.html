<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAI Sites Hazard Monitor - Pro</title>

```
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; }
    
    #header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 15px 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    #header h1 { font-size: 1.5rem; font-weight: 600; }
    .header-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    
    .btn {
        padding: 8px 14px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
        color: white;
        font-weight: 500;
    }
    
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background-color: #4CAF50; }
    .btn-primary:hover:not(:disabled) { background-color: #45a049; }
    .btn-secondary { background-color: #2196F3; }
    .btn-secondary:hover:not(:disabled) { background-color: #0b7dda; }
    .btn-info { background-color: #9C27B0; }
    .btn-info:hover:not(:disabled) { background-color: #7B1FA2; }
    .btn-success { background-color: #00897B; }
    .btn-success:hover:not(:disabled) { background-color: #00695C; }
    .btn-warning { background-color: #ff9800; }
    .btn-warning:hover:not(:disabled) { background-color: #f57c00; }
    .btn-danger { background-color: #f44336; }
    .btn-danger:hover:not(:disabled) { background-color: #da190b; }
    
    #file-input, #hazard-file-input { display: none; }
    #main-container { display: flex; height: calc(100vh - 80px); }
    #map { flex: 1; height: 100%; position: relative; }
    
    #sidebar {
        width: 420px;
        background: white;
        box-shadow: -2px 0 8px rgba(0,0,0,0.1);
        overflow-y: auto;
        padding: 20px;
    }
    
    .section {
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .section:last-child { border-bottom: none; }
    .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 12px; color: #1e3c72; }
    
    .layer-control {
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 8px;
        background: #f5f5f5;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .layer-control:hover { background: #e8e8e8; }
    .layer-control input[type="checkbox"] { margin-right: 10px; cursor: pointer; width: 18px; height: 18px; }
    .layer-label { flex: 1; font-size: 14px; }
    .layer-count { background: #2196F3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .hazard-count { background: #f44336; }
    .warning-badge { background: #ff9800; }
    .hotspot-badge { background: #9C27B0; }
    
    .info-box { background: #e3f2fd; padding: 12px; border-radius: 5px; margin-top: 10px; font-size: 13px; border-left: 4px solid #2196F3; }
    .info-box a { color: #0b7dda; text-decoration: none; font-weight: 600; }
    .info-box a:hover { text-decoration: underline; }
    
    .error-box { background: #ffebee; padding: 12px; border-radius: 5px; margin-top: 10px; font-size: 13px; border-left: 4px solid #f44336; }
    .success-box { background: #e8f5e9; padding: 12px; border-radius: 5px; margin-top: 10px; font-size: 13px; border-left: 4px solid #4CAF50; }
    .warning-box { background: #fff3e0; padding: 12px; border-radius: 5px; margin-top: 10px; font-size: 13px; border-left: 4px solid #ff9800; }
    
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .stat-item { background: #f5f5f5; padding: 10px; border-radius: 5px; text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #1e3c72; }
    .stat-label { font-size: 12px; color: #666; margin-top: 4px; }
    
    .btn-group {
        display: flex;
        gap: 5px;
        margin-top: 10px;
    }
    
    .btn-small {
        flex: 1;
        padding: 6px 10px;
        font-size: 12px;
    }
    
    select, input[type="number"], input[type="text"], input[type="password"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    input[type="color"] {
        width: 100%;
        height: 40px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .proximity-alert {
        background: #fff3e0;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        border-left: 4px solid #ff9800;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .alert-item {
        margin-top: 8px;
        padding: 8px;
        background: rgba(255,255,255,0.5);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .alert-item:hover {
        background: rgba(255,255,255,0.9);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transform: translateX(2px);
    }
    
    .legend {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        font-size: 13px;
        transition: all 0.3s ease;
    }
    
    .legend.minimized {
        padding: 8px 12px;
    }
    
    .legend.minimized .legend-content {
        display: none;
    }
    
    .legend-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .legend-minimize-btn {
        background: #2196F3;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
    }
    
    .legend-minimize-btn:hover {
        background: #1976D2;
    }
    
    .legend-title { font-weight: 600; color: #1e3c72; }
    .legend-item { display: flex; align-items: center; margin-bottom: 8px; }
    .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.3); }
    
    /* Settings Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 10001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
    }
    
    .modal.active {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .modal-content {
        background-color: white;
        border-radius: 12px;
        width: 90%;
        max-width: 900px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        padding: 20px;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-header h2 {
        font-size: 1.5rem;
        margin: 0;
    }
    
    .close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 28px;
        cursor: pointer;
        line-height: 1;
        padding: 0 10px;
    }
    
    .close-btn:hover {
        opacity: 0.8;
    }
    
    .modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }
    
    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    /* Tabs */
    .tabs {
        display: flex;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 20px;
    }
    
    .tab {
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
    }
    
    .tab:hover {
        color: #1e3c72;
        background: #f5f5f5;
    }
    
    .tab.active {
        color: #1e3c72;
        border-bottom-color: #2196F3;
        font-weight: 600;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* Sites Table */
    .sites-table-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    
    .sites-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    
    .sites-table thead {
        position: sticky;
        top: 0;
        background: #1e3c72;
        color: white;
        z-index: 10;
    }
    
    .sites-table th {
        padding: 10px 8px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #ddd;
        cursor: pointer;
        user-select: none;
    }
    
    .sites-table th:hover {
        background: #2a5298;
    }
    
    .sites-table th.sortable:after {
        content: ' ‚áÖ';
        opacity: 0.3;
    }
    
    .sites-table th.sorted-asc:after {
        content: ' ‚Üë';
        opacity: 1;
    }
    
    .sites-table th.sorted-desc:after {
        content: ' ‚Üì';
        opacity: 1;
    }
    
    .sites-table tbody tr {
        border-bottom: 1px solid #e0e0e0;
        transition: background 0.2s;
    }
    
    .sites-table tbody tr:hover {
        background: #f5f5f5;
    }
    
    .sites-table tbody tr.at-risk {
        background: #fff3e0;
    }
    
    .sites-table td {
        padding: 8px;
    }
    
    .site-action-btn {
        padding: 4px 8px;
        font-size: 11px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        background: #2196F3;
        color: white;
        transition: background 0.2s;
    }
    
    .site-action-btn:hover {
        background: #0b7dda;
    }
    
    .site-color-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: inline-block;
        border: 2px solid white;
        box-shadow: 0 0 3px rgba(0,0,0,0.3);
        cursor: pointer;
    }
    
    .color-config-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-top: 15px;
    }
    
    .color-config-item {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
    
    .color-config-label {
        font-size: 14px;
        font-weight: 600;
        color: #1e3c72;
        margin-bottom: 10px;
        display: block;
    }
    
    .color-picker-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .color-preview {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .saved-indicator {
        display: inline-block;
        padding: 3px 8px;
        background: #4CAF50;
        color: white;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 10px;
    }
    
    .api-indicator {
        display: inline-block;
        padding: 3px 8px;
        background: #9C27B0;
        color: white;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 5px;
    }
    
    /* Highlighted marker animation */
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.3);
            opacity: 0.7;
        }
    }
    
    .highlighted-marker {
        animation: pulse 1.5s ease-in-out 3;
    }
    
    /* Emergency Warning - Continuous Pulse */
    .emergency-pulse {
        animation: pulse 2s ease-in-out infinite !important;
    }
    
    /* Custom Alert Level Marker Shapes */
    .hazard-marker {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        color: white;
        text-shadow: 0 0 3px rgba(0,0,0,0.5);
        font-weight: bold;
    }
    
    .emergency-marker {
        width: 0;
        height: 0;
        border-left: 12px solid transparent;
        border-right: 12px solid transparent;
        border-bottom: 20px solid #D32F2F;
        position: relative;
        animation: pulse 2s ease-in-out infinite;
    }
    
    .emergency-marker::after {
        content: '‚ö†';
        position: absolute;
        bottom: -18px;
        left: -8px;
        font-size: 14px;
        color: white;
    }
    
    .watch-marker {
        width: 18px;
        height: 18px;
        background: #F57C00;
        transform: rotate(45deg);
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        position: relative;
    }
    
    .watch-marker::after {
        content: '‚ö†';
        position: absolute;
        top: 0px;
        left: 2px;
        transform: rotate(-45deg);
        font-size: 12px;
        color: white;
    }
    
    .advice-marker {
        width: 14px;
        height: 14px;
        background: #FFA726;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.85);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    }
    
    .loading-overlay.active { display: flex; }
    
    .loading-content {
        background: white;
        padding: 40px;
        border-radius: 12px;
        text-align: center;
        max-width: 450px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .spinner {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #2196F3;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .progress-bar {
        width: 100%;
        height: 10px;
        background: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 20px;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #2196F3, #4CAF50);
        width: 0%;
        transition: width 0.3s ease;
    }
    
    .manual-point-form { background: #f9f9f9; padding: 12px; border-radius: 5px; margin-top: 10px; }
    .refresh-time { font-size: 11px; color: #666; margin-top: 5px; }
    
    .source-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 10px;
    }
    
    .source-item {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
        font-size: 12px;
    }
    
    .source-name {
        font-weight: 600;
        color: #1e3c72;
        margin-bottom: 4px;
    }
    
    .source-status {
        font-size: 11px;
        color: #666;
    }
    
    .source-success { color: #4CAF50; font-weight: 600; }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin-bottom: 5px;
        background: #f9f9f9;
        border-radius: 4px;
    }
    
    .checkbox-item input[type="checkbox"] {
        margin-right: 10px;
        width: 16px;
        height: 16px;
    }
    
    .checkbox-item label {
        font-size: 13px;
        cursor: pointer;
        flex: 1;
    }
    
    .search-box {
        width: 100%;
        padding: 10px;
        border: 2px solid #2196F3;
        border-radius: 5px;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    .table-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        gap: 10px;
    }
    
    .leaflet-popup-content {
        margin: 15px;
        min-width: 280px;
    }
    
    .popup-header {
        font-size: 16px;
        font-weight: 700;
        color: #1e3c72;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e0e0e0;
    }
    
    .popup-field {
        margin-bottom: 8px;
        padding: 6px;
        background: #f9f9f9;
        border-radius: 4px;
    }
    
    .popup-label {
        font-size: 11px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .popup-value {
        font-size: 13px;
        color: #333;
        margin-top: 2px;
    }
    
    .alert-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 8px;
    }
    
    .alert-advice { background: #fff3e0; color: #e65100; }
    .alert-watch { background: #ffe0b2; color: #ef6c00; }
    .alert-warning { background: #ffcdd2; color: #c62828; }
    .alert-emergency { background: #ff5252; color: white; }
    
    .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 600;
        margin-top: 4px;
    }
    
    .status-controlled { background: #c8e6c9; color: #2e7d32; }
    .status-responding { background: #fff9c4; color: #f57f17; }
    .status-out { background: #ffccbc; color: #d84315; }
    
    .popup-link {
        display: inline-block;
        margin-top: 10px;
        padding: 6px 12px;
        background: #2196F3;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .popup-link:hover {
        background: #0b7dda;
    }
    
    .settings-section {
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .settings-section:last-child {
        border-bottom: none;
    }
    
    .settings-section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1e3c72;
        margin-bottom: 15px;
    }
</style>
```

</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loading-text" style="font-size: 18px; font-weight: 700; margin-bottom: 10px; color: #1e3c72;">Loading...</div>
            <div id="loading-details" style="font-size: 14px; color: #666; margin-bottom: 20px;">Processing</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
    </div>

```
<!-- Settings Modal -->
<div class="modal" id="settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚öôÔ∏è Settings & Configuration</h2>
            <button class="close-btn" id="close-settings">&times;</button>
        </div>
        <div class="modal-body">
            <div class="tabs">
                <button class="tab active" data-tab="general">General</button>
                <button class="tab" data-tab="sites">Sites Table</button>
                <button class="tab" data-tab="colors">Site Colors</button>
                <button class="tab" data-tab="icons">Alert Icons</button>
                <button class="tab" data-tab="bushfire">Bushfire.io API</button>
            </div>
            
            <!-- General Tab -->
            <div class="tab-content active" id="tab-general">
                <div class="settings-section">
                    <div class="settings-section-title">üó∫Ô∏è Base Map Layer</div>
                    
                    <label style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 8px;">Map Style:</label>
                    <select id="basemap-selector" style="width: 100%; padding: 10px; border-radius: 5px; border: 2px solid #2196F3;">
                        <option value="osm">üó∫Ô∏è OpenStreetMap (Default)</option>
                        <option value="satellite">üõ∞Ô∏è Satellite (Esri World Imagery)</option>
                        <option value="topo">üèîÔ∏è Topographic</option>
                        <option value="dark">üåô Dark Mode</option>
                        <option value="streets">üöó Streets</option>
                    </select>
                    
                    <div class="info-box" style="margin-top: 10px;">
                        <strong>üõ∞Ô∏è Satellite View:</strong> Best for visualizing terrain and fire spread<br>
                        <strong>üó∫Ô∏è OpenStreetMap:</strong> Best for roads and built areas<br>
                        <strong>üåô Dark Mode:</strong> Easier on eyes at night
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-section-title">üå¶Ô∏è Weather & Wind Data</div>
                    
                    <div class="info-box" style="margin-top: 0;">
                        <strong>üìç Weather Data Location</strong><br>
                        Weather layers (wind, temperature, radar) are available via external professional services.<br>
                        Quick-access links are provided in the sidebar's "üå¶Ô∏è Weather Data" section.
                    </div>
                    
                    <div style="margin-top: 15px; background: #fff; padding: 15px; border-radius: 5px; border-left: 4px solid #4CAF50;">
                        <strong style="color: #4CAF50;">‚úÖ Recommended: Windy.com</strong><br>
                        <div style="margin-top: 10px; font-size: 12px;">
                            ‚Ä¢ Animated wind direction & speed<br>
                            ‚Ä¢ Temperature maps<br>
                            ‚Ä¢ Weather radar<br>
                            ‚Ä¢ 10-day forecasts<br>
                            ‚Ä¢ Fire weather index<br>
                            ‚Ä¢ Free to use!
                        </div>
                        <a href="https://www.windy.com/?-27.470,133.252,5,m:wind" target="_blank" class="btn btn-success" style="margin-top: 12px; width: 100%;">üåç Open Windy.com ‚Üí</a>
                    </div>
                    
                    <div style="margin-top: 15px; background: #fff; padding: 15px; border-radius: 5px; border-left: 4px solid #FF9800;">
                        <strong style="color: #FF9800;">üá¶üá∫ Official: Bureau of Meteorology</strong><br>
                        <div style="margin-top: 10px; font-size: 12px;">
                            ‚Ä¢ Official Australian weather data<br>
                            ‚Ä¢ Temperature, wind, radar<br>
                            ‚Ä¢ Fire danger ratings<br>
                            ‚Ä¢ Regional forecasts
                        </div>
                        <a href="http://www.bom.gov.au/australia/meteye/" target="_blank" class="btn btn-warning" style="margin-top: 12px; width: 100%;">üå°Ô∏è Open BOM MetEye ‚Üí</a>
                    </div>
                    
                    <div class="success-box" style="margin-top: 15px;">
                        <strong>üí° Dual-Screen Workflow:</strong><br>
                        1. BAI Monitor (this) ‚Üí Fire locations & sites<br>
                        2. Windy.com (link above) ‚Üí Wind direction & weather<br>
                        3. Position side-by-side ‚Üí Complete monitoring!
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-section-title">üé® Map Display</div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="setting-clustering">
                        <label for="setting-clustering">Enable marker clustering</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="setting-auto-zoom" checked>
                        <label for="setting-auto-zoom">Auto-zoom to sites on load</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="setting-satellite" checked>
                        <label for="setting-satellite">Show satellite hotspots (WMS)</label>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-section-title">‚ö†Ô∏è Alert Settings</div>
                    
                    <label style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 8px;">Default Proximity Distance:</label>
                    <input type="number" id="setting-proximity" value="10" min="1" max="100">
                    
                    <div class="checkbox-item" style="margin-top: 10px;">
                        <input type="checkbox" id="setting-alert-sound" disabled>
                        <label for="setting-alert-sound">Alert sound (future feature)</label>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-section-title">üíæ Storage</div>
                    
                    <div id="storage-info" style="background: #f5f5f5; padding: 12px; border-radius: 5px; font-size: 13px;">
                        Calculating...
                    </div>
                    
                    <div class="btn-group" style="margin-top: 10px;">
                        <button class="btn btn-danger btn-small" id="clear-all-storage">Clear All Storage</button>
                        <button class="btn btn-warning btn-small" id="export-settings">Export Settings</button>
                    </div>
                </div>
            </div>
            
            <!-- Sites Table Tab -->
            <div class="tab-content" id="tab-sites">
                <div class="table-toolbar">
                    <input type="text" id="site-search" class="search-box" placeholder="üîç Search sites by name, number, or status...">
                    <button class="btn btn-success btn-small" id="export-sites-btn">üìä Export CSV</button>
                </div>
                
                <div class="sites-table-container">
                    <table class="sites-table">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="name">Name</th>
                                <th class="sortable" data-sort="category">Category</th>
                                <th class="sortable" data-sort="status">Status</th>
                                <th class="sortable" data-sort="risk">Risk</th>
                                <th>Color</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sites-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: #999;">
                                    No sites loaded. Upload KML files to see sites here.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px; font-size: 12px; color: #666;">
                    <strong>Table Features:</strong>
                    ‚Ä¢ Click column headers to sort
                    ‚Ä¢ Click "Locate" to zoom to site on map
                    ‚Ä¢ Change color per site
                    ‚Ä¢ Sites at risk highlighted in orange
                </div>
            </div>
            
            <!-- Site Colors Tab -->
            <div class="tab-content" id="tab-colors">
                <div class="settings-section">
                    <div class="settings-section-title">üé® Site Marker Colors</div>
                    
                    <div class="color-config-grid">
                        <div class="color-config-item">
                            <label class="color-config-label">Default Site Color</label>
                            <div class="color-picker-row">
                                <input type="color" id="color-default-site" value="#4CAF50">
                                <div class="color-preview" id="preview-default-site" style="background-color: #4CAF50;"></div>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 600;">Normal Sites</div>
                                    <div style="font-size: 11px; color: #666;">Sites without any hazard proximity</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="color-config-item">
                            <label class="color-config-label">At-Risk Site Color</label>
                            <div class="color-picker-row">
                                <input type="color" id="color-risk-site" value="#FF9800">
                                <div class="color-preview" id="preview-risk-site" style="background-color: #FF9800;"></div>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 600;">Sites Near Hazards</div>
                                    <div style="font-size: 11px; color: #666;">Sites within proximity alert distance</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="color-config-item">
                            <label class="color-config-label">High Priority Site Color</label>
                            <div class="color-picker-row">
                                <input type="color" id="color-priority-site" value="#2196F3">
                                <div class="color-preview" id="preview-priority-site" style="background-color: #2196F3;"></div>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 600;">High Priority Sites</div>
                                    <div style="font-size: 11px; color: #666;">Set via site table (future feature)</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="color-config-item">
                            <label class="color-config-label">üì° Broadcast Site Color</label>
                            <div class="color-picker-row">
                                <input type="color" id="color-broadcast-site" value="#9C27B0">
                                <div class="color-preview" id="preview-broadcast-site" style="background-color: #9C27B0;"></div>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 600;">Broadcast Sites</div>
                                    <div style="font-size: 11px; color: #666;">Telecommunications broadcast sites</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="color-config-item">
                            <label class="color-config-label">üì∂ PSN Site Color</label>
                            <div class="color-picker-row">
                                <input type="color" id="color-psn-site" value="#00BCD4">
                                <div class="color-preview" id="preview-psn-site" style="background-color: #00BCD4;"></div>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px; font-weight: 600;">PSN Sites</div>
                                    <div style="font-size: 11px; color: #666;">Public Safety Network sites</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="apply-colors-btn" style="width: 100%; margin-top: 20px;">
                        ‚úÖ Apply Color Changes
                    </button>
                </div>
            </div>
            
            <!-- Alert Icons Tab -->
            <div class="tab-content" id="tab-icons">
                <div class="settings-section">
                    <div class="settings-section-title">üé® Customize Alert Level Icons</div>
                    
                    <div class="success-box" style="margin-top: 0;">
                        <strong>‚ú® Icon Customization</strong><br>
                        Customize the appearance of hazard markers for each alert level.
                        Changes apply immediately to the map!
                    </div>
                    
                    <!-- Emergency Warning Editor -->
                    <div class="color-config-item" style="margin-top: 15px;">
                        <label class="color-config-label">üö® Emergency Warning</label>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Icon Style:</label>
                        <select id="icon-style-emergency" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                            <option value="triangle">üî∫ Triangle (Default - Recommended)</option>
                            <option value="square">üü• Square</option>
                            <option value="star">‚≠ê Star</option>
                            <option value="hexagon">‚¨¢ Hexagon</option>
                            <option value="circle">üî¥ Circle</option>
                            <option value="emoji">üò± Emoji</option>
                        </select>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666;">Color:</label>
                        <div class="color-picker-row">
                            <input type="color" id="color-emergency" value="#D32F2F">
                            <div class="color-preview" id="preview-emergency" style="background-color: #D32F2F;"></div>
                        </div>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Size: <span id="size-emergency-label">24</span>px</label>
                        <input type="range" id="size-emergency" min="16" max="40" value="24" step="2" style="width: 100%;">
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Symbol/Emoji:</label>
                        <input type="text" id="symbol-emergency" value="‚ö†" maxlength="2" style="width: 100%; font-size: 24px; text-align: center;">
                        
                        <div class="checkbox-item" style="margin-top: 10px;">
                            <input type="checkbox" id="pulse-emergency" checked>
                            <label for="pulse-emergency">Enable pulsing animation</label>
                        </div>
                    </div>
                    
                    <!-- Watch & Act Editor -->
                    <div class="color-config-item">
                        <label class="color-config-label">‚ö†Ô∏è Watch and Act</label>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Icon Style:</label>
                        <select id="icon-style-watch" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                            <option value="triangle">üî∫ Triangle</option>
                            <option value="square">üüß Square</option>
                            <option value="star">‚≠ê Star</option>
                            <option value="hexagon">‚¨¢ Hexagon</option>
                            <option value="diamond">üî∂ Diamond (Default - Recommended)</option>
                            <option value="circle">üü† Circle</option>
                            <option value="emoji">üî• Emoji</option>
                        </select>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666;">Color:</label>
                        <div class="color-picker-row">
                            <input type="color" id="color-watch" value="#F57C00">
                            <div class="color-preview" id="preview-watch" style="background-color: #F57C00;"></div>
                        </div>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Size: <span id="size-watch-label">20</span>px</label>
                        <input type="range" id="size-watch" min="12" max="32" value="20" step="2" style="width: 100%;">
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Symbol/Emoji:</label>
                        <input type="text" id="symbol-watch" value="‚ö†" maxlength="2" style="width: 100%; font-size: 24px; text-align: center;">
                    </div>
                    
                    <!-- Advice Editor -->
                    <div class="color-config-item">
                        <label class="color-config-label">‚ÑπÔ∏è Advice</label>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Icon Style:</label>
                        <select id="icon-style-advice" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                            <option value="triangle">üî∫ Triangle</option>
                            <option value="square">üü® Square</option>
                            <option value="star">‚≠ê Star</option>
                            <option value="hexagon">‚¨¢ Hexagon</option>
                            <option value="diamond">üî∂ Diamond</option>
                            <option value="circle">üü° Circle (Default - Recommended)</option>
                            <option value="emoji">üí¨ Emoji</option>
                        </select>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666;">Color:</label>
                        <div class="color-picker-row">
                            <input type="color" id="color-advice" value="#FFA726">
                            <div class="color-preview" id="preview-advice" style="background-color: #FFA726;"></div>
                        </div>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Size: <span id="size-advice-label">16</span>px</label>
                        <input type="range" id="size-advice" min="10" max="28" value="16" step="2" style="width: 100%;">
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Symbol/Emoji:</label>
                        <input type="text" id="symbol-advice" value="‚Ñπ" maxlength="2" style="width: 100%; font-size: 24px; text-align: center;">
                    </div>
                    
                    <!-- Hotspot Editor -->
                    <div class="color-config-item">
                        <label class="color-config-label">üõ∞Ô∏è Satellite Hotspot</label>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Icon Style:</label>
                        <select id="icon-style-hotspot" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                            <option value="triangle">üî∫ Triangle</option>
                            <option value="square">üü• Square</option>
                            <option value="star">‚≠ê Star</option>
                            <option value="hexagon">‚¨¢ Hexagon</option>
                            <option value="diamond">üî∂ Diamond (Default - Recommended)</option>
                            <option value="circle">üî¥ Circle</option>
                            <option value="emoji">üõ∞ Emoji</option>
                        </select>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666;">Color:</label>
                        <div class="color-picker-row">
                            <input type="color" id="color-hotspot" value="#FD260F">
                            <div class="color-preview" id="preview-hotspot" style="background-color: #FD260F;"></div>
                        </div>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Size: <span id="size-hotspot-label">10</span>px</label>
                        <input type="range" id="size-hotspot" min="4" max="20" value="10" step="2" style="width: 100%;">
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Symbol/Emoji:</label>
                        <input type="text" id="symbol-hotspot" value="üõ∞" maxlength="2" style="width: 100%; font-size: 24px; text-align: center;">
                    </div>
                    
                    <!-- Other Incident Editor -->
                    <div class="color-config-item">
                        <label class="color-config-label">‚ÑπÔ∏è Other Incident</label>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Icon Style:</label>
                        <select id="icon-style-info" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                            <option value="triangle">üî∫ Triangle</option>
                            <option value="square">‚¨ú Square</option>
                            <option value="star">‚≠ê Star</option>
                            <option value="hexagon">‚¨¢ Hexagon</option>
                            <option value="diamond">üî∂ Diamond</option>
                            <option value="circle">‚ö´ Circle (Default - Recommended)</option>
                            <option value="emoji">‚Ñπ Emoji</option>
                        </select>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666;">Color:</label>
                        <div class="color-picker-row">
                            <input type="color" id="color-info" value="#757575">
                            <div class="color-preview" id="preview-info" style="background-color: #757575;"></div>
                        </div>
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Size: <span id="size-info-label">10</span>px</label>
                        <input type="range" id="size-info" min="4" max="20" value="10" step="2" style="width: 100%;">
                        
                        <label style="font-size: 12px; font-weight: 600; color: #666; margin-top: 10px; display: block;">Symbol/Emoji:</label>
                        <input type="text" id="symbol-info" value="‚Ñπ" maxlength="2" style="width: 100%; font-size: 24px; text-align: center;">
                    </div>
                    
                    <button class="btn btn-primary" id="apply-icons-btn" style="width: 100%; margin-top: 20px; padding: 12px; font-size: 14px;">
                        ‚úÖ Apply Icon Changes
                    </button>
                    
                    <button class="btn btn-warning" id="reset-icons-btn" style="width: 100%; margin-top: 10px;">
                        üîÑ Reset to Defaults
                    </button>
                </div>
            </div>
            
            <!-- Bushfire.io API Tab -->
            <div class="tab-content" id="tab-bushfire">
                <div class="settings-section">
                    <div class="settings-section-title">üåê Bushfire.io API Configuration</div>
                    
                    <div class="warning-box" style="margin-top: 0;">
                        <strong>‚ö†Ô∏è Enterprise Feature</strong><br>
                        Requires Bushfire.io Enterprise license.<br>
                        Contact: <a href="/cdn-cgi/l/email-protection#83ebe6efefecc3e7eaf0e2f0f7e6f1f0e0eae6ede0e6ade0ec"><span class="__cf_email__" data-cfemail="93fbf6fffffcd3f7fae0f2e0e7f6e1e0f0faf6fdf0f6bdf0fc">[email&#160;protected]</span></a>
                    </div>
                    
                    <label style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-top: 15px; margin-bottom: 8px;">API Bearer Token:</label>
                    <input type="password" id="bushfire-api-key" placeholder="Enter your Bushfire.io API key" style="font-family: monospace; font-size: 12px;">
                    
                    <div class="btn-group">
                        <button class="btn btn-success btn-small" id="save-api-key-btn">üíæ Save Key</button>
                        <button class="btn btn-warning btn-small" id="test-api-key-btn">üß™ Test Key</button>
                        <button class="btn btn-danger btn-small" id="clear-api-key-btn">üóëÔ∏è Clear Key</button>
                    </div>
                    
                    <div id="api-status" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; text-align: center; font-size: 12px;">
                        No API key configured
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-section-title">üõ∞Ô∏è NASA FIRMS API (FREE)</div>
                    
                    <div class="success-box" style="margin-top: 0;">
                        <strong>‚úÖ READY TO USE!</strong><br>
                        Your NASA FIRMS API key is already configured and working!<br>
                        Just click the üõ∞Ô∏è NASA FIRMS button to load satellite hotspots.
                    </div>
                    
                    <div class="info-box" style="margin-top: 10px;">
                        <strong>‚úÖ Separate Hotspot Layer</strong><br>
                        NASA FIRMS hotspots now have their own independent layer toggle!<br>
                        Find it in Layers: üõ∞Ô∏è NASA FIRMS<br>
                        Turn hotspots on/off without affecting other fire data.
                    </div>
                    
                    <label style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-top: 15px; margin-bottom: 8px;">NASA FIRMS API Key:</label>
                    <input type="text" id="nasa-firms-key" placeholder="Enter your NASA FIRMS Map Key" style="font-family: monospace; font-size: 12px;">
                    
                    <div class="btn-group">
                        <button class="btn btn-warning btn-small" id="test-nasa-key-btn">üß™ Test Key</button>
                        <button class="btn btn-success btn-small" id="save-nasa-key-btn">üíæ Save Key</button>
                        <button class="btn btn-danger btn-small" id="clear-nasa-key-btn">üóëÔ∏è Clear Key</button>
                    </div>
                    
                    <div id="nasa-status" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; text-align: center; font-size: 12px;">
                        No NASA FIRMS key configured
                    </div>
                    
                    <div class="info-box" style="margin-top: 10px;">
                        <strong>üîë Need a Different API Key?</strong><br>
                        1. Visit <a href="https://firms.modaps.eosdis.nasa.gov/api/map_key/" target="_blank">NASA FIRMS Map Key</a><br>
                        2. Enter your email<br>
                        3. Check email for MAP_KEY<br>
                        4. Paste here and click "üß™ Test Key"<br>
                        5. If valid, click "üíæ Save Key"
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-section-title">üì° Data Sources to Load</div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="bf-warnings" checked>
                        <label for="bf-warnings">üî• Warnings & Incidents (All States)</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="bf-hotspots">
                        <label for="bf-hotspots">üõ∞Ô∏è Satellite Hotspots (Detailed Points)</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="bf-ignitions" checked>
                        <label for="bf-ignitions">‚ö° Fire Ignitions (Predictive)</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="bf-roads">
                        <label for="bf-roads">üöß Road Closures</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="bf-weather">
                        <label for="bf-weather">üå§Ô∏è Weather Observations</label>
                    </div>
                    
                    <div class="checkbox-item">
                        <input type="checkbox" id="bf-lightning">
                        <label for="bf-lightning">‚ö° Lightning Strikes</label>
                    </div>
                    
                    <div class="info-box" style="margin-top: 15px;">
                        <strong>üí° Recommended:</strong><br>
                        ‚Ä¢ Warnings & Incidents (essential)<br>
                        ‚Ä¢ Fire Ignitions (early detection)<br>
                        ‚Ä¢ Road Closures (site access)<br>
                        <br>
                        Hotspots can be 1000s of points (use WMS layer instead for performance)
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="save-settings-btn">üíæ Save All Settings</button>
            <button class="btn btn-primary" id="close-settings-footer">Done</button>
        </div>
    </div>
</div>

<!-- Main UI -->
<div id="header">
    <h1>üó∫Ô∏è BAI Sites Hazard Monitor <span id="saved-badge"></span><span id="api-badge"></span></h1>
    <div class="header-controls">
        <button class="btn btn-primary" id="upload-sites-btn">üìÅ Add Sites</button>
        <button class="btn btn-success" id="export-excel-btn" disabled>üìä Export Excel</button>
        <button class="btn btn-success" id="export-csv-btn" disabled>üìÑ Export CSV</button>
        <button class="btn btn-primary" id="import-btn">üì• Import</button>
        <button class="btn btn-success" id="save-sites-btn" disabled>üíæ Save Sites</button>
        <button class="btn btn-secondary" id="load-manual-btn">üî• Load File</button>
        <button class="btn btn-warning" id="load-bushfire-btn" disabled>üåê Bushfire.io</button>
        <button class="btn btn-info" id="clustering-btn">üî≤ Clustering: OFF</button>
        <button class="btn btn-info" id="settings-btn">‚öôÔ∏è Settings</button>
        <button class="btn btn-danger" id="clear-btn">üóëÔ∏è Clear</button>
        <input type="file" id="file-input" accept=".kmz,.kml" multiple>
        <input type="file" id="import-file-input" accept=".csv,.xlsx,.xls" style="display: none;">
        <input type="file" id="hazard-file-input" accept=".json">
    </div>
</div>

<div id="main-container">
    <div id="map"></div>
    <div id="sidebar">
        <div class="section">
            <div class="section-title">üìä Overview</div>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="site-count">0</div><div class="stat-label">Sites</div></div>
                <div class="stat-item"><div class="stat-value" id="hazard-count">0</div><div class="stat-label">Hazards</div></div>
                <div class="stat-item"><div class="stat-value" id="fire-count">0</div><div class="stat-label">Fires</div></div>
                <div class="stat-item"><div class="stat-value" id="at-risk-count">0</div><div class="stat-label">At Risk</div></div>
            </div>
            
            <div style="margin-top: 12px; padding: 10px; background: #f9f9f9; border-radius: 5px; border-left: 4px solid #D32F2F;">
                <div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 8px;">üö® Alert Levels</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; font-size: 11px;">
                    <div style="text-align: center;">
                        <div style="font-size: 16px; font-weight: 700; color: #D32F2F;" id="emergency-count">0</div>
                        <div style="color: #666;">Emergency</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 16px; font-weight: 700; color: #F57C00;" id="watch-count">0</div>
                        <div style="color: #666;">Watch & Act</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 16px; font-weight: 700; color: #FFA726;" id="advice-count">0</div>
                        <div style="color: #666;">Advice</div>
                    </div>
                </div>
            </div>
            
            <div id="load-status"></div>
            
            <div style="margin-top: 15px;">
                <label style="font-size: 13px; font-weight: 600; color: #666; display: block; margin-bottom: 6px;">‚ö†Ô∏è Alert Distance (km):</label>
                <input type="number" id="alert-distance" value="10" min="1" max="100" step="1">
            </div>
            
            <div id="proximity-alerts"></div>
        </div>

        <div class="section">
            <div class="section-title">üîç Search Sites</div>
            <input type="text" id="site-search-map" placeholder="Search sites by name, number..." style="width: 100%; padding: 8px; border: 2px solid #2196F3; border-radius: 5px; font-size: 13px; margin-bottom: 10px;">
            <div id="search-results" style="max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div class="section">
            <div class="section-title">üóÇÔ∏è Layers</div>
            <div class="layer-control" id="toggle-sites">
                <input type="checkbox" id="layer-sites" checked>
                <span class="layer-label">Other Sites</span>
                <span class="layer-count" id="sites-count">0</span>
            </div>
            <div class="layer-control" id="toggle-broadcast">
                <input type="checkbox" id="layer-broadcast" checked>
                <span class="layer-label">üì° Broadcast Sites</span>
                <span class="layer-count" style="background: #9C27B0;" id="broadcast-count">0</span>
            </div>
            <div class="layer-control" id="toggle-psn">
                <input type="checkbox" id="layer-psn" checked>
                <span class="layer-label">üì∂ PSN Sites</span>
                <span class="layer-count" style="background: #00BCD4;" id="psn-count">0</span>
            </div>
            <div class="layer-control" id="toggle-fires">
                <input type="checkbox" id="layer-fires" checked>
                <span class="layer-label">Fires</span>
                <span class="layer-count hazard-count" id="fires-count">0</span>
            </div>
            <div class="layer-control" id="toggle-incidents">
                <input type="checkbox" id="layer-incidents" checked>
                <span class="layer-label">Incidents</span>
                <span class="layer-count warning-badge" id="incidents-count">0</span>
            </div>
            <div class="layer-control" id="toggle-warnings">
                <input type="checkbox" id="layer-warnings" checked>
                <span class="layer-label">Warnings</span>
                <span class="layer-count warning-badge" id="warnings-count">0</span>
            </div>
            <div class="layer-control" id="toggle-hotspots-layer">
                <input type="checkbox" id="layer-hotspots" checked>
                <span class="layer-label">Satellite Hotspots</span>
                <span class="layer-count hotspot-badge">WMS</span>
            </div>
            <div class="layer-control" id="toggle-nasa-layer">
                <input type="checkbox" id="layer-nasa" checked>
                <span class="layer-label">üõ∞Ô∏è NASA FIRMS</span>
                <span class="layer-count" style="background: #FD260F;" id="nasa-count">0</span>
            </div>
            
            <div style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #ddd;">
                <div style="font-size: 11px; font-weight: 600; color: #666; margin-bottom: 8px;">üå¶Ô∏è Weather Data</div>
            </div>
            
            <div style="padding: 10px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid #4CAF50;">
                <div style="font-size: 11px; font-weight: 600; margin-bottom: 8px;">External Weather Services:</div>
                <div style="font-size: 10px; line-height: 1.8;">
                    <a href="https://www.windy.com/?-27.470,133.252,5,m:wind" target="_blank" style="display: block; color: #2196F3; font-weight: 600; margin-bottom: 4px;">üí® Windy.com - Wind Direction ‚Üí</a>
                    <a href="http://www.bom.gov.au/australia/meteye/" target="_blank" style="display: block; color: #2196F3; font-weight: 600; margin-bottom: 4px;">üå°Ô∏è BOM MetEye - Temp/Radar ‚Üí</a>
                    <a href="http://www.bom.gov.au/australia/radar/" target="_blank" style="display: block; color: #2196F3; font-weight: 600;">üåßÔ∏è BOM Radar Network ‚Üí</a>
                </div>
                <div style="font-size: 9px; color: #555; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ccc;">
                    üí° Open in second tab/screen for complete fire + weather monitoring
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üîÑ Live Updates</div>
            
            <div class="checkbox-item">
                <input type="checkbox" id="auto-refresh-enabled">
                <label for="auto-refresh-enabled">Enable Auto-Refresh (5 min)</label>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success btn-small" id="load-nsw-btn">üî• NSW RFS</button>
                <button class="btn btn-success btn-small" id="load-vic-btn">üå≤ VIC Emerg</button>
                <button class="btn btn-success btn-small" id="load-qld-btn">‚òÄÔ∏è QLD Fire</button>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary btn-small" id="load-all-states-btn">üåè All States</button>
                <button class="btn btn-info btn-small" id="load-nasa-btn" disabled>üõ∞Ô∏è NASA FIRMS</button>
            </div>
            
            <div id="last-refresh" class="refresh-time" style="text-align: center;"></div>
            
            <div style="margin-top: 10px; padding: 8px; background: #f5f5f5; border-radius: 5px; font-size: 11px;">
                <div style="font-weight: 600; margin-bottom: 5px; color: #666;">üìä Data Sources Status:</div>
                <div id="source-nsw-status" style="margin-bottom: 3px;">NSW: <span style="color: #999;">Not loaded</span></div>
                <div id="source-vic-status" style="margin-bottom: 3px;">VIC: <span style="color: #999;">Not loaded</span></div>
                <div id="source-qld-status" style="margin-bottom: 3px;">QLD: <span style="color: #999;">Not loaded</span></div>
                <div id="source-nasa-status" style="margin-bottom: 3px;">NASA: <span style="color: #999;">Not configured</span></div>
                <div id="source-wms-status">WMS: <span style="color: #999;">Checking...</span></div>
            </div>
            
            <div class="warning-box" style="margin-top: 10px; font-size: 11px;">
                <strong>‚ö†Ô∏è CORS Limitations:</strong><br>
                If VIC or QLD fail, download manually:<br>
                <a href="https://data.emergency.vic.gov.au/Show?pageId=getIncidentJSON" target="_blank" download>VIC Feed</a> | 
                <a href="https://www.qfes.qld.gov.au/data/alerts/bushfireAlert.json" target="_blank" download>QLD Feed</a><br>
                Then use "üî• Load File" button
            </div>
            
            <div class="source-grid">
                <div class="source-item">
                    <div class="source-name">üìä Data Status</div>
                    <div class="source-status" id="data-status">No hazard data loaded</div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">üéØ Active Alert Icons</div>
            <div id="active-icons-display" style="background: #f9f9f9; padding: 12px; border-radius: 5px; border-left: 4px solid #2196F3;">
                <div style="font-size: 11px; color: #666; text-align: center;">Load fire data to see active icons</div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">‚ûï Manual Hazard</div>
            <div class="manual-point-form">
                <input type="text" id="manual-title" placeholder="Title">
                <input type="text" id="manual-lat" placeholder="Latitude">
                <input type="text" id="manual-lon" placeholder="Longitude">
                <select id="manual-type">
                    <option value="fire">Fire</option>
                    <option value="incident">Incident</option>
                    <option value="warning">Warning</option>
                </select>
                <button class="btn btn-warning" id="add-hazard-btn" style="width: 100%; justify-content: center;">Add Point</button>
            </div>
        </div>
    </div>
</div>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script>
    console.log('üó∫Ô∏è BAI Hazard Monitor v6.1 - FINAL CLEAN VERSION');
    console.log('‚úÖ NASA FIRMS API Key: Pre-configured and ready!');
    console.log('‚úÖ Features: Satellite base map, NASA FIRMS layer, Site search, Icon customization');
    console.log('üå¶Ô∏è Weather: Use external links in sidebar (Windy.com, BOM)');
    
    var map, sitesData = [], hazardsData = { fires: [], incidents: [], warnings: [] };
    var isProcessing = false, clusteringEnabled = false;
    var sitesCluster, firesCluster, incidentsCluster, warningsCluster, nasaHotspotsCluster;
    var broadcastCluster, psnCluster;  // New category clusters
    var sitesLayer, firesLayer, incidentsLayer, warningsLayer, nasaHotspotsLayer;
    var broadcastLayer, psnLayer;  // New category layers
    var allSiteMarkers = [], allFireMarkers = [], allIncidentMarkers = [], allWarningMarkers = [], allNASAMarkers = [];
    var allBroadcastMarkers = [], allPSNMarkers = [];  // New category marker arrays
    var siteMarkerMap = new Map(); // Map site name to marker for quick lookup
    var gaHotspotsWMS = null;
    var sitesSaved = false;
    var bushfireApiKey = '';
    var bushfireEnabled = false;
    var highlightedMarker = null;
    var currentSort = { column: 'name', direction: 'asc' };
    
    // Base map layers
    var currentBaseLayer = null;
    var baseLayers = {};
    // Weather data via external links (Windy.com, BOM) - see sidebar
    
    var siteColors = {
        default: '#4CAF50',
        atRisk: '#FF9800',
        priority: '#2196F3',
        broadcast: '#9C27B0',  // Purple for Broadcast
        psn: '#00BCD4'         // Cyan for PSN
    };
    
    var iconConfig = {
        emergency: { style: 'triangle', color: '#D32F2F', size: 24, symbol: '‚ö†', pulse: true },
        watch: { style: 'diamond', color: '#F57C00', size: 20, symbol: '‚ö†', pulse: false },
        advice: { style: 'circle', color: '#FFA726', size: 16, symbol: '‚Ñπ', pulse: false },
        hotspot: { style: 'diamond', color: '#FD260F', size: 10, symbol: 'üõ∞', pulse: false },  // Red diamond for NASA FIRMS
        info: { style: 'circle', color: '#757575', size: 10, symbol: '‚Ñπ', pulse: false }
    };

    function initMap() {
        map = L.map('map').setView([-27.5, 133], 5);
        
        // Define all available base map layers
        baseLayers = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 19
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri',
                maxZoom: 19
            }),
            topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap',
                maxZoom: 17
            }),
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© CartoDB',
                maxZoom: 19
            }),
            streets: L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap, HOT',
                maxZoom: 19
            })
        };
        
        // Add default base layer (OpenStreetMap)
        currentBaseLayer = baseLayers.osm;
        currentBaseLayer.addTo(map);

        sitesCluster = L.markerClusterGroup({ maxClusterRadius: 80, chunkedLoading: true });
        broadcastCluster = L.markerClusterGroup({ maxClusterRadius: 80, chunkedLoading: true });
        psnCluster = L.markerClusterGroup({ maxClusterRadius: 80, chunkedLoading: true });
        firesCluster = L.markerClusterGroup({ maxClusterRadius: 100, chunkedLoading: true });
        incidentsCluster = L.markerClusterGroup({ maxClusterRadius: 80, chunkedLoading: true });
        warningsCluster = L.markerClusterGroup({ maxClusterRadius: 80, chunkedLoading: true });
        nasaHotspotsCluster = L.markerClusterGroup({ maxClusterRadius: 60, chunkedLoading: true });  // Separate NASA layer

        sitesLayer = L.layerGroup();
        broadcastLayer = L.layerGroup();
        psnLayer = L.layerGroup();
        firesLayer = L.layerGroup();
        incidentsLayer = L.layerGroup();
        warningsLayer = L.layerGroup();
        nasaHotspotsLayer = L.layerGroup();  // Separate NASA layer

        // Add regular layers by default (clustering OFF)
        map.addLayer(sitesLayer);
        map.addLayer(broadcastLayer);
        map.addLayer(psnLayer);
        map.addLayer(firesLayer);
        map.addLayer(incidentsLayer);
        map.addLayer(warningsLayer);
        map.addLayer(nasaHotspotsLayer);  // NASA hotspots separate and toggleable

        gaHotspotsWMS = L.tileLayer.wms('https://hotspots.dea.ga.gov.au/geoserver/public/wms', {
            layers: 'public:hotspots_last_72hrs',
            format: 'image/png',
            transparent: true,
            opacity: 0.7,
            attribution: '¬© Geoscience Australia DEA Hotspots'
        });
        
        // Add error handling for WMS layer (suppress repetitive errors)
        var wmsErrorCount = 0;
        gaHotspotsWMS.on('tileerror', function(error) {
            wmsErrorCount++;
            if (wmsErrorCount === 1) {
                console.warn('‚ö†Ô∏è WMS Hotspot tiles not loading - Geoscience Australia service may be unavailable');
                status('‚ö†Ô∏è Satellite WMS layer unavailable (use NASA FIRMS instead)', 'warning');
            }
            // Don't spam console with errors
        });
        
        gaHotspotsWMS.on('tileload', function() {
            if (wmsErrorCount === 0) {
                console.log('‚úÖ WMS Hotspots tile loaded successfully');
            }
        });
        
        map.addLayer(gaHotspotsWMS);
        console.log('‚úÖ Geoscience Australia WMS hotspot layer added to map');

        var legend = L.control({ position: 'bottomright' });
        legend.onAdd = function() {
            var div = L.DomUtil.create('div', 'legend');
            div.id = 'map-legend';
            div.innerHTML = 
                '<div class="legend-header">' +
                '<div class="legend-title" style="margin-bottom: 0;">Legend</div>' +
                '<button class="legend-minimize-btn" id="legend-minimize-btn" onclick="toggleLegend()">‚àí</button>' +
                '</div>' +
                '<div class="legend-content" id="legend-content">' +
                '<div class="legend-title" style="margin-top: 10px; font-size: 12px;">Sites</div>' +
                '<div class="legend-item"><div class="legend-color" id="legend-default-color" style="background: #4CAF50;"></div><span>Other Sites</span></div>' +
                '<div class="legend-item"><div class="legend-color" id="legend-broadcast-color" style="background: #9C27B0;"></div><span>Broadcast Sites</span></div>' +
                '<div class="legend-item"><div class="legend-color" id="legend-psn-color" style="background: #00BCD4;"></div><span>PSN Sites</span></div>' +
                '<div class="legend-item"><div class="legend-color" id="legend-risk-color" style="background: #FF9800;"></div><span>At-Risk Sites</span></div>' +
                '<div class="legend-title" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">Alert Levels</div>' +
                // Emergency - Triangle
                '<div class="legend-item">' +
                '<div style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">' +
                '<div class="emergency-marker" style="border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 14px solid #D32F2F; animation: pulse 2s infinite;"></div>' +
                '</div>' +
                '<span>üö® Emergency</span></div>' +
                // Watch & Act - Diamond
                '<div class="legend-item">' +
                '<div style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">' +
                '<div style="width: 12px; height: 12px; background: #F57C00; transform: rotate(45deg); border: 1px solid white;"></div>' +
                '</div>' +
                '<span>‚ö†Ô∏è Watch & Act</span></div>' +
                // Advice - Circle
                '<div class="legend-item">' +
                '<div style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">' +
                '<div style="width: 10px; height: 10px; background: #FFA726; border-radius: 50%; border: 1px solid white;"></div>' +
                '</div>' +
                '<span>‚ÑπÔ∏è Advice</span></div>' +
                // NASA FIRMS Hotspot - Red Diamond
                '<div class="legend-item">' +
                '<div style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">' +
                '<div id="legend-hotspot-icon" style="width: 8px; height: 8px; background: #FD260F; transform: rotate(45deg); border: 1px solid white;"></div>' +
                '</div>' +
                '<span>üõ∞Ô∏è NASA Hotspot</span></div>' +
                // Other Incident - Tiny Gray Circle
                '<div class="legend-item">' +
                '<div style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">' +
                '<div id="legend-info-icon" style="width: 6px; height: 6px; background: #757575; border-radius: 50%; border: 1px solid white;"></div>' +
                '</div>' +
                '<span>‚ÑπÔ∏è Other</span></div>' +
                '</div>';  // Close legend-content
            return div;
        };
        legend.addTo(map);
        
        loadSavedColors();
        loadSavedIcons();      // Load custom icon preferences
        loadSavedSites();
        loadSavedApiKey();
        loadSettings();
        setupIconEditorHandlers();  // Setup icon editor UI handlers
    }

    function show(t, d) {
        document.getElementById('loading-overlay').classList.add('active');
        document.getElementById('loading-text').textContent = t || 'Loading...';
        document.getElementById('loading-details').textContent = d || '';
        document.getElementById('progress-fill').style.width = '0%';
    }

    function hide() { document.getElementById('loading-overlay').classList.remove('active'); }
    
    function prog(p, d) {
        document.getElementById('progress-fill').style.width = p + '%';
        if (d) document.getElementById('loading-details').textContent = d;
    }

    // Settings Modal Functions
    document.getElementById('settings-btn').onclick = function() {
        document.getElementById('settings-modal').classList.add('active');
        updateStorageInfo();
        populateSitesTable();
    };

    document.getElementById('close-settings').onclick = function() {
        document.getElementById('settings-modal').classList.remove('active');
    };

    document.getElementById('close-settings-footer').onclick = function() {
        document.getElementById('settings-modal').classList.remove('active');
    };

    // Tab switching
    var tabs = document.querySelectorAll('.tab');
    tabs.forEach(function(tab) {
        tab.onclick = function() {
            var tabName = this.getAttribute('data-tab');
            
            tabs.forEach(function(t) { t.classList.remove('active'); });
            this.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(function(content) {
                content.classList.remove('active');
            });
            document.getElementById('tab-' + tabName).classList.add('active');
            
            if (tabName === 'sites') {
                populateSitesTable();
            }
        };
    });

    // Color picker updates
    document.getElementById('color-default-site').oninput = function() {
        document.getElementById('preview-default-site').style.backgroundColor = this.value;
    };

    document.getElementById('color-risk-site').oninput = function() {
        document.getElementById('preview-risk-site').style.backgroundColor = this.value;
    };

    document.getElementById('color-priority-site').oninput = function() {
        document.getElementById('preview-priority-site').style.backgroundColor = this.value;
    };
    
    document.getElementById('color-broadcast-site').oninput = function() {
        document.getElementById('preview-broadcast-site').style.backgroundColor = this.value;
    };
    
    document.getElementById('color-psn-site').oninput = function() {
        document.getElementById('preview-psn-site').style.backgroundColor = this.value;
    };

    document.getElementById('apply-colors-btn').onclick = function() {
        try {
            siteColors.default = document.getElementById('color-default-site').value;
            siteColors.atRisk = document.getElementById('color-risk-site').value;
            siteColors.priority = document.getElementById('color-priority-site').value;
            siteColors.broadcast = document.getElementById('color-broadcast-site').value;
            siteColors.psn = document.getElementById('color-psn-site').value;
            
            localStorage.setItem('site_colors', JSON.stringify(siteColors));
            console.log('‚úÖ Colors saved:', siteColors);
            
            // Update legend colors
            updateLegendColors();
            
            // Update marker colors
            applyColorChangesToMarkers();
            
            status('‚úÖ Site colors and legend updated!', 'success');
        } catch (error) {
            console.error('Error applying colors:', error);
            status('‚ùå Failed to apply colors: ' + error.message, 'error');
        }
    };

    function loadSavedColors() {
        try {
            var saved = localStorage.getItem('site_colors');
            if (saved) {
                var savedColors = JSON.parse(saved);
                siteColors = Object.assign(siteColors, savedColors);  // Merge with defaults
                console.log('‚úÖ Colors loaded from storage:', siteColors);
                
                // Safely update color pickers
                var elements = {
                    'color-default-site': siteColors.default,
                    'color-risk-site': siteColors.atRisk,
                    'color-priority-site': siteColors.priority,
                    'color-broadcast-site': siteColors.broadcast,
                    'color-psn-site': siteColors.psn,
                    'preview-default-site': siteColors.default,
                    'preview-risk-site': siteColors.atRisk,
                    'preview-priority-site': siteColors.priority,
                    'preview-broadcast-site': siteColors.broadcast,
                    'preview-psn-site': siteColors.psn
                };
                
                for (var id in elements) {
                    var el = document.getElementById(id);
                    if (el) {
                        if (id.startsWith('preview-')) {
                            el.style.backgroundColor = elements[id];
                        } else {
                            el.value = elements[id];
                        }
                    }
                }
                
                // Update legend colors
                updateLegendColors();
            } else {
                console.log('‚ÑπÔ∏è No saved colors found, using defaults');
            }
        } catch (error) {
            console.error('Error loading colors:', error);
        }
    }
    
    function updateLegendColors() {
        // Update legend to reflect current color scheme
        var legendElements = {
            'legend-default-color': siteColors.default,
            'legend-broadcast-color': siteColors.broadcast,
            'legend-psn-color': siteColors.psn,
            'legend-risk-color': siteColors.atRisk
        };
        
        for (var id in legendElements) {
            var el = document.getElementById(id);
            if (el) {
                el.style.backgroundColor = legendElements[id];
            }
        }
        
        console.log('‚úÖ Legend colors updated');
    }
    
    function updateLegendIcons() {
        // Update legend alert icons based on current iconConfig
        var hotspotIcon = document.getElementById('legend-hotspot-icon');
        var infoIcon = document.getElementById('legend-info-icon');
        
        // Update NASA FIRMS hotspot icon
        if (hotspotIcon && iconConfig.hotspot) {
            var style = iconConfig.hotspot.style || 'circle';
            var color = iconConfig.hotspot.color;
            var size = iconConfig.hotspot.size;
            
            // Remove old styles
            hotspotIcon.style.borderRadius = '';
            hotspotIcon.style.transform = '';
            
            if (style === 'diamond') {
                hotspotIcon.style.width = size + 'px';
                hotspotIcon.style.height = size + 'px';
                hotspotIcon.style.backgroundColor = color;
                hotspotIcon.style.transform = 'rotate(45deg)';
                hotspotIcon.style.borderRadius = '0';
            } else {
                // Circle or other
                hotspotIcon.style.width = size + 'px';
                hotspotIcon.style.height = size + 'px';
                hotspotIcon.style.backgroundColor = color;
                hotspotIcon.style.borderRadius = '50%';
            }
        }
        
        // Update Other Incident icon
        if (infoIcon && iconConfig.info) {
            var style = iconConfig.info.style || 'circle';
            var color = iconConfig.info.color;
            var size = iconConfig.info.size;
            
            // Remove old styles
            infoIcon.style.borderRadius = '';
            infoIcon.style.transform = '';
            
            if (style === 'diamond') {
                infoIcon.style.width = size + 'px';
                infoIcon.style.height = size + 'px';
                infoIcon.style.backgroundColor = color;
                infoIcon.style.transform = 'rotate(45deg)';
                infoIcon.style.borderRadius = '0';
            } else {
                // Circle or other
                infoIcon.style.width = size + 'px';
                infoIcon.style.height = size + 'px';
                infoIcon.style.backgroundColor = color;
                infoIcon.style.borderRadius = '50%';
            }
        }
        
        console.log('‚úÖ Legend icons updated');
    }
    
    function toggleLegend() {
        var legend = document.getElementById('map-legend');
        var btn = document.getElementById('legend-minimize-btn');
        
        if (legend && btn) {
            if (legend.classList.contains('minimized')) {
                legend.classList.remove('minimized');
                btn.textContent = '‚àí';
            } else {
                legend.classList.add('minimized');
                btn.textContent = '+';
            }
        }
    }
    
    // ========== ICON CONFIGURATION FUNCTIONS ==========
    
    function loadSavedIcons() {
        try {
            var saved = localStorage.getItem('alert_icon_config');
            if (saved) {
                var savedConfig = JSON.parse(saved);
                iconConfig = Object.assign(iconConfig, savedConfig);
                console.log('‚úÖ Icon config loaded from storage:', iconConfig);
                
                // Update UI controls
                updateIconEditorUI();
                updateLegendIcons();  // Update legend to show custom icons
            } else {
                console.log('‚ÑπÔ∏è No saved icon config, using defaults');
                updateLegendIcons();  // Update legend with default icons
            }
        } catch (error) {
            console.error('Error loading icon config:', error);
        }
    }
    
    function updateIconEditorUI() {
        // Update all icon editor controls with current config
        var levels = ['emergency', 'watch', 'advice', 'hotspot', 'info'];
        
        levels.forEach(function(level) {
            if (!iconConfig[level]) return;
            
            var styleSelect = document.getElementById('icon-style-' + level);
            var colorInput = document.getElementById('color-' + level);
            var sizeInput = document.getElementById('size-' + level);
            var symbolInput = document.getElementById('symbol-' + level);
            var previewDiv = document.getElementById('preview-' + level);
            var sizeLabel = document.getElementById('size-' + level + '-label');
            
            if (styleSelect) styleSelect.value = iconConfig[level].style || 'circle';
            if (colorInput) colorInput.value = iconConfig[level].color || '#000000';
            if (sizeInput) sizeInput.value = iconConfig[level].size || 16;
            if (symbolInput) symbolInput.value = iconConfig[level].symbol || '';
            if (previewDiv) previewDiv.style.backgroundColor = iconConfig[level].color;
            if (sizeLabel) sizeLabel.textContent = iconConfig[level].size || 16;
            
            if (level === 'emergency') {
                var pulseCheck = document.getElementById('pulse-emergency');
                if (pulseCheck) pulseCheck.checked = iconConfig[level].pulse !== false;
            }
        });
    }
    
    function saveIconConfig() {
        try {
            var levels = ['emergency', 'watch', 'advice', 'hotspot', 'info'];
            
            levels.forEach(function(level) {
                var styleSelect = document.getElementById('icon-style-' + level);
                var colorInput = document.getElementById('color-' + level);
                var sizeInput = document.getElementById('size-' + level);
                var symbolInput = document.getElementById('symbol-' + level);
                
                if (styleSelect) iconConfig[level].style = styleSelect.value;
                if (colorInput) iconConfig[level].color = colorInput.value;
                if (sizeInput) iconConfig[level].size = parseInt(sizeInput.value);
                if (symbolInput) iconConfig[level].symbol = symbolInput.value;
            });
            
            // Emergency pulse setting
            var pulseCheck = document.getElementById('pulse-emergency');
            if (pulseCheck) iconConfig.emergency.pulse = pulseCheck.checked;
            
            localStorage.setItem('alert_icon_config', JSON.stringify(iconConfig));
            console.log('‚úÖ Icon config saved:', iconConfig);
            status('‚úÖ Icon configuration saved!', 'success');
        } catch (error) {
            console.error('Error saving icon config:', error);
            status('‚ùå Failed to save icon config: ' + error.message, 'error');
        }
    }
    
    function applyIconChanges() {
        try {
            saveIconConfig();
            updateLegendIcons();  // Update legend to show new icons
            
            // Clear and reload all hazard markers to apply new icons
            clearHazards();
            status('üîÑ Icon configuration saved! Click üåè All States to reload with new icons.', 'info');
            
        } catch (error) {
            console.error('Error applying icon changes:', error);
            status('‚ùå Failed to apply icons: ' + error.message, 'error');
        }
    }
    
    function resetIconDefaults() {
        if (!confirm('Reset all icons to default settings?')) return;
        
        iconConfig = {
            emergency: { style: 'triangle', color: '#D32F2F', size: 24, symbol: '‚ö†', pulse: true },
            watch: { style: 'diamond', color: '#F57C00', size: 20, symbol: '‚ö†', pulse: false },
            advice: { style: 'circle', color: '#FFA726', size: 16, symbol: '‚Ñπ', pulse: false },
            hotspot: { style: 'diamond', color: '#FD260F', size: 10, symbol: 'üõ∞', pulse: false },  // Red diamond for NASA FIRMS
            info: { style: 'circle', color: '#757575', size: 10, symbol: '‚Ñπ', pulse: false }
        };
        
        localStorage.setItem('alert_icon_config', JSON.stringify(iconConfig));
        updateIconEditorUI();
        updateLegendIcons();  // Update legend with defaults
        status('‚úÖ Icons reset to defaults', 'success');
        console.log('‚úÖ Icons reset to defaults');
    }
    
    function setupIconEditorHandlers() {
        // Color preview updates
        ['emergency', 'watch', 'advice', 'hotspot', 'info'].forEach(function(level) {
            var colorInput = document.getElementById('color-' + level);
            var preview = document.getElementById('preview-' + level);
            if (colorInput && preview) {
                colorInput.oninput = function() {
                    preview.style.backgroundColor = this.value;
                };
            }
            
            // Size slider updates
            var sizeInput = document.getElementById('size-' + level);
            var sizeLabel = document.getElementById('size-' + level + '-label');
            if (sizeInput && sizeLabel) {
                sizeInput.oninput = function() {
                    sizeLabel.textContent = this.value;
                };
            }
        });
        
        // Apply and reset buttons
        var applyBtn = document.getElementById('apply-icons-btn');
        if (applyBtn) {
            applyBtn.onclick = applyIconChanges;
        }
        
        var resetBtn = document.getElementById('reset-icons-btn');
        if (resetBtn) {
            resetBtn.onclick = resetIconDefaults;
        }
    }
    
    // ========== BASE MAP & WEATHER LAYER FUNCTIONS ==========
    
    function switchBaseMap(mapType) {
        // Remove current base layer
        if (currentBaseLayer) {
            map.removeLayer(currentBaseLayer);
        }
        
        // Add new base layer
        if (baseLayers[mapType]) {
            currentBaseLayer = baseLayers[mapType];
            currentBaseLayer.addTo(map);
            localStorage.setItem('basemap_preference', mapType);
            console.log('‚úÖ Base map switched to:', mapType);
            status('üó∫Ô∏è Map style changed to ' + mapType.toUpperCase(), 'success');
        }
    }
    
    function loadSavedBaseMap() {
        var saved = localStorage.getItem('basemap_preference');
        if (saved && baseLayers[saved]) {
            switchBaseMap(saved);
            var selector = document.getElementById('basemap-selector');
            if (selector) selector.value = saved;
        }
    }

    function applyColorChangesToMarkers() {
        // Update all site markers based on category and risk
        allSiteMarkers.forEach(function(marker) {
            var isAtRisk = marker.siteData && marker.siteData.atRisk;
            var color = isAtRisk ? siteColors.atRisk : siteColors.default;
            marker.setStyle({ fillColor: color });
        });
        
        allBroadcastMarkers.forEach(function(marker) {
            var isAtRisk = marker.siteData && marker.siteData.atRisk;
            var color = isAtRisk ? siteColors.atRisk : siteColors.broadcast;
            marker.setStyle({ fillColor: color });
        });
        
        allPSNMarkers.forEach(function(marker) {
            var isAtRisk = marker.siteData && marker.siteData.atRisk;
            var color = isAtRisk ? siteColors.atRisk : siteColors.psn;
            marker.setStyle({ fillColor: color });
        });
    }

    // Sites Table Functions
    function populateSitesTable() {
        var tbody = document.getElementById('sites-table-body');
        tbody.innerHTML = '';
        
        if (sitesData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">No sites loaded</td></tr>';
            return;
        }
        
        var searchTerm = document.getElementById('site-search').value.toLowerCase();
        var filteredSites = sitesData.filter(function(site) {
            if (!searchTerm) return true;
            var nameMatch = site.name.toLowerCase().includes(searchTerm);
            var statusMatch = (site.extendedData && site.extendedData.Operational_Status_Desc || '').toLowerCase().includes(searchTerm);
            var numberMatch = (site.extendedData && site.extendedData.Site_Number || '').toLowerCase().includes(searchTerm);
            return nameMatch || statusMatch || numberMatch;
        });
        
        // Sort
        filteredSites.sort(function(a, b) {
            var aVal, bVal;
            if (currentSort.column === 'name') {
                aVal = a.name;
                bVal = b.name;
            } else if (currentSort.column === 'category') {
                aVal = a.category || 'Other';
                bVal = b.category || 'Other';
            } else if (currentSort.column === 'status') {
                aVal = a.extendedData && a.extendedData.Operational_Status_Desc || '';
                bVal = b.extendedData && b.extendedData.Operational_Status_Desc || '';
            } else if (currentSort.column === 'risk') {
                aVal = a.atRisk ? 1 : 0;
                bVal = b.atRisk ? 1 : 0;
            }
            
            if (currentSort.direction === 'asc') {
                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            } else {
                return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
            }
        });
        
        filteredSites.forEach(function(site, index) {
            var row = document.createElement('tr');
            if (site.atRisk) row.classList.add('at-risk');
            
            var marker = siteMarkerMap.get(site.name);
            var category = site.category || 'Other';
            
            // Determine color based on risk first, then category
            var siteColor;
            if (site.atRisk) {
                siteColor = siteColors.atRisk;
            } else if (category === 'Broadcast') {
                siteColor = siteColors.broadcast;
            } else if (category === 'PSN') {
                siteColor = siteColors.psn;
            } else {
                siteColor = siteColors.default;
            }
            
            // Category badge with color
            var categoryBadge = '';
            if (category === 'Broadcast') {
                categoryBadge = '<span style="background: #9C27B0; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">üì° Broadcast</span>';
            } else if (category === 'PSN') {
                categoryBadge = '<span style="background: #00BCD4; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">üì∂ PSN</span>';
            } else {
                categoryBadge = '<span style="background: #666; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">Other</span>';
            }
            
            row.innerHTML = '<td><strong>' + site.name + '</strong><br><small>' + 
                            (site.extendedData && site.extendedData.Site_Number || 'N/A') + '</small></td>' +
                            '<td>' + categoryBadge + '</td>' +
                            '<td>' + (site.extendedData && site.extendedData.Operational_Status_Desc || 'Unknown') + '</td>' +
                            '<td>' + (site.atRisk ? '‚ö†Ô∏è At Risk' : '‚úÖ Safe') + '</td>' +
                            '<td><span class="site-color-dot" style="background-color: ' + siteColor + ';" data-site-index="' + index + '"></span></td>' +
                            '<td><button class="site-action-btn" data-site-name="' + site.name + '">üìç Locate</button></td>';
            
            tbody.appendChild(row);
        });
        
        // Add event listeners
        document.querySelectorAll('.site-action-btn').forEach(function(btn) {
            btn.onclick = function() {
                var siteName = this.getAttribute('data-site-name');
                zoomToSite(siteName);
                document.getElementById('settings-modal').classList.remove('active');
            };
        });
        
        // Update sort indicators
        document.querySelectorAll('.sites-table th.sortable').forEach(function(th) {
            th.classList.remove('sorted-asc', 'sorted-desc');
            if (th.getAttribute('data-sort') === currentSort.column) {
                th.classList.add('sorted-' + currentSort.direction);
            }
        });
    }

    document.getElementById('site-search').oninput = function() {
        populateSitesTable();
    };

    // Table sorting
    document.querySelectorAll('.sites-table th.sortable').forEach(function(th) {
        th.onclick = function() {
            var column = this.getAttribute('data-sort');
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            populateSitesTable();
        };
    });

    function exportSitesCSV() {
        if (sitesData.length === 0) {
            status('No sites to export', 'error');
            return;
        }
        
        var csv = 'Name,Latitude,Longitude,Status,Site_Number,GRN_ID,At_Risk\n';
        sitesData.forEach(function(site) {
            var status = site.extendedData && site.extendedData.Operational_Status_Desc || '';
            var siteNum = site.extendedData && site.extendedData.Site_Number || '';
            var grnId = site.extendedData && site.extendedData.GRN_ID || '';
            var atRisk = site.atRisk ? 'Yes' : 'No';
            
            csv += '"' + site.name + '",' + site.lat + ',' + site.lon + ',"' + status + '","' + siteNum + '","' + grnId + '",' + atRisk + '\n';
        });
        
        var blob = new Blob([csv], { type: 'text/csv' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'BAI-Sites-Export-' + new Date().toISOString().split('T')[0] + '.csv';
        a.click();
        
        status('‚úÖ Exported ' + sitesData.length + ' sites to CSV', 'success');
    }

    document.getElementById('export-sites-btn').onclick = exportSitesCSV;

    function zoomToSite(siteName) {
        var site = sitesData.find(function(s) { return s.name === siteName; });
        if (!site) return;
        
        var marker = siteMarkerMap.get(siteName);
        if (!marker) return;
        
        // Zoom to site
        map.setView([site.lat, site.lon], 16, { animate: true });
        
        // Highlight marker
        highlightMarker(marker);
        
        // Open popup after zoom
        setTimeout(function() {
            marker.fire('click');
        }, 500);
    }

    function highlightMarker(marker) {
        if (highlightedMarker) {
            var elem = highlightedMarker.getElement();
            if (elem) elem.classList.remove('highlighted-marker');
        }
        
        highlightedMarker = marker;
        var elem = marker.getElement();
        if (elem) {
            elem.classList.add('highlighted-marker');
            setTimeout(function() {
                elem.classList.remove('highlighted-marker');
                highlightedMarker = null;
            }, 4500);
        }
    }

    // Settings Functions
    function loadSettings() {
        try {
            var clustering = localStorage.getItem('setting_clustering');
            if (clustering !== null) {
                clusteringEnabled = clustering === 'true';
                var clusterCheckbox = document.getElementById('setting-clustering');
                if (clusterCheckbox) clusterCheckbox.checked = clusteringEnabled;
            }
            
            var proximity = localStorage.getItem('setting_proximity');
            if (proximity) {
                var proxInput = document.getElementById('setting-proximity');
                var alertInput = document.getElementById('alert-distance');
                if (proxInput) proxInput.value = proximity;
                if (alertInput) alertInput.value = proximity;
            }
            
            var satellite = localStorage.getItem('setting_satellite');
            if (satellite !== null) {
                var showSatellite = satellite === 'true';
                var satCheckbox = document.getElementById('setting-satellite');
                var hotspotsCheckbox = document.getElementById('layer-hotspots');
                if (satCheckbox) satCheckbox.checked = showSatellite;
                if (hotspotsCheckbox) hotspotsCheckbox.checked = showSatellite;
                if (gaHotspotsWMS) {
                    if (showSatellite) map.addLayer(gaHotspotsWMS);
                    else map.removeLayer(gaHotspotsWMS);
                }
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    }

    function saveAllSettings() {
        try {
            var clustering = document.getElementById('setting-clustering').checked;
            var proximity = document.getElementById('setting-proximity').value;
            var satellite = document.getElementById('setting-satellite').checked;
            
            localStorage.setItem('setting_clustering', clustering);
            localStorage.setItem('setting_proximity', proximity);
            localStorage.setItem('setting_satellite', satellite);
            
            console.log('‚úÖ Settings saved:', { clustering, proximity, satellite });
            
            // Apply clustering setting if different from current state
            if (clustering !== clusteringEnabled) {
                toggleCluster();
            }
            
            // Apply proximity distance
            var alertDistanceInput = document.getElementById('alert-distance');
            if (alertDistanceInput) {
                alertDistanceInput.value = proximity;
            }
            
            // Update alerts with new proximity
            updateAlerts();
            
            // Update legend to reflect any icon changes
            updateLegendIcons();
            
            // Refresh all layers to apply any changes
            refreshAllLayers();
            
            status('‚úÖ All settings saved! Refreshing map...', 'success');
            
            // Close settings modal after brief delay
            setTimeout(function() {
                document.getElementById('settings-modal').classList.remove('active');
                console.log('‚úÖ Settings modal closed');
                
                // Force map refresh
                setTimeout(function() {
                    updateStats();
                    status('‚úÖ Settings applied and map refreshed!', 'success');
                }, 100);
            }, 500);
            
        } catch (error) {
            console.error('‚ùå Settings save error:', error);
            status('‚ùå Failed to save settings: ' + error.message, 'error');
        }
    }

    document.getElementById('save-settings-btn').onclick = saveAllSettings;

    function updateStorageInfo() {
        var sitesData = localStorage.getItem('bai_sites_data');
        var apiKey = localStorage.getItem('bushfire_api_key');
        var colors = localStorage.getItem('site_colors');
        
        var totalSize = 0;
        if (sitesData) totalSize += sitesData.length;
        if (apiKey) totalSize += apiKey.length;
        if (colors) totalSize += colors.length;
        
        var sizeKB = (totalSize / 1024).toFixed(1);
        var limitKB = 5120; // 5MB typical limit
        var percentUsed = ((totalSize / 1024) / limitKB * 100).toFixed(1);
        
        var html = '<strong>Storage Usage:</strong><br>';
        html += 'Total: ' + sizeKB + ' KB / ~5 MB (' + percentUsed + '%)<br><br>';
        
        if (sitesData) {
            html += 'üíæ Sites: ' + (sitesData.length / 1024).toFixed(1) + ' KB<br>';
        }
        if (apiKey) {
            html += 'üîê API Key: Saved<br>';
        }
        if (colors) {
            html += 'üé® Colors: Saved<br>';
        }
        
        document.getElementById('storage-info').innerHTML = html;
    }

    document.getElementById('clear-all-storage').onclick = function() {
        if (!confirm('Clear ALL browser storage? This will delete:\n‚Ä¢ Saved sites\n‚Ä¢ API key\n‚Ä¢ Color settings\n‚Ä¢ All preferences\n\nThis cannot be undone!')) return;
        
        localStorage.clear();
        status('All storage cleared. Refresh page to reset.', 'warning');
        setTimeout(function() {
            location.reload();
        }, 2000);
    };

    // Bushfire.io API Functions
    function loadSavedApiKey() {
        try {
            var saved = localStorage.getItem('bushfire_api_key');
            if (saved) {
                bushfireApiKey = saved;
                document.getElementById('bushfire-api-key').value = bushfireApiKey;
                bushfireEnabled = true;
                document.getElementById('load-bushfire-btn').disabled = false;
                updateApiBadge();
                updateApiStatus('üåê API Enabled - Ready to load', 'success');
            }
        } catch (error) {
            console.error('Error loading API key:', error);
        }
    }

    function saveApiKey() {
        var key = document.getElementById('bushfire-api-key').value.trim();
        if (!key) {
            status('Enter API key first', 'error');
            return;
        }
        
        try {
            localStorage.setItem('bushfire_api_key', key);
            bushfireApiKey = key;
            bushfireEnabled = true;
            document.getElementById('load-bushfire-btn').disabled = false;
            updateApiBadge();
            updateApiStatus('‚úÖ API key saved successfully', 'success');
            status('‚úÖ Bushfire.io API key saved', 'success');
        } catch (error) {
            status('‚ùå Failed to save API key: ' + error.message, 'error');
        }
    }

    function clearApiKey() {
        if (!confirm('Clear Bushfire.io API key from storage?')) return;
        
        localStorage.removeItem('bushfire_api_key');
        bushfireApiKey = '';
        bushfireEnabled = false;
        document.getElementById('bushfire-api-key').value = '';
        document.getElementById('load-bushfire-btn').disabled = true;
        updateApiBadge();
        updateApiStatus('No API key configured', 'default');
        status('Bushfire.io API key cleared', 'success');
    }

    function updateApiBadge() {
        var badge = document.getElementById('api-badge');
        if (bushfireEnabled) {
            badge.innerHTML = '<span class="api-indicator">üåê API</span>';
        } else {
            badge.innerHTML = '';
        }
    }

    function updateApiStatus(message, type) {
        var div = document.getElementById('api-status');
        var colors = {
            success: '#4CAF50',
            error: '#f44336',
            warning: '#ff9800',
            default: '#666'
        };
        div.innerHTML = message;
        div.style.color = colors[type] || colors.default;
    }

    async function testApiKey() {
        if (!bushfireApiKey) {
            updateApiStatus('‚ùå No API key to test', 'error');
            return;
        }
        
        updateApiStatus('üß™ Testing API key...', 'warning');
        
        try {
            var response = await fetch('https://api.bushfire.io/v1/auth/validate', {
                headers: {
                    'Authorization': 'Bearer ' + bushfireApiKey,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                var data = await response.json();
                updateApiStatus('‚úÖ API key valid! User: ' + (data.sub || 'Unknown'), 'success');
                status('‚úÖ API key is valid', 'success');
            } else {
                updateApiStatus('‚ùå API key invalid (HTTP ' + response.status + ')', 'error');
                status('‚ùå API key test failed', 'error');
            }
        } catch (error) {
            updateApiStatus('‚ùå Test failed: ' + error.message, 'error');
            status('‚ùå Could not test API key', 'error');
        }
    }

    document.getElementById('save-api-key-btn').onclick = saveApiKey;
    document.getElementById('clear-api-key-btn').onclick = clearApiKey;
    document.getElementById('test-api-key-btn').onclick = testApiKey;

    async function loadFromBushfireIO() {
        if (!bushfireEnabled || !bushfireApiKey) {
            status('‚ùå Configure Bushfire.io API key in Settings first', 'error');
            document.getElementById('settings-modal').classList.add('active');
            // Switch to Bushfire.io tab
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelector('[data-tab="bushfire"]').classList.add('active');
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            document.getElementById('tab-bushfire').classList.add('active');
            return;
        }
        
        isProcessing = true;
        show('Loading from Bushfire.io...', 'Fetching data from API');
        prog(10);
        clearHazards();
        
        var loadedSources = [];
        var failedSources = [];
        
        try {
            if (document.getElementById('bf-warnings').checked) {
                try {
                    prog(20, 'Loading warnings & incidents...');
                    var response = await fetch('https://api.bushfire.io/v1/data/au/warnings?simple=false', {
                        headers: {
                            'Authorization': 'Bearer ' + bushfireApiKey,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        var data = await response.json();
                        processBushfireWarnings(data);
                        loadedSources.push('Warnings (' + (data.features ? data.features.length : 0) + ')');
                    } else {
                        failedSources.push('Warnings (HTTP ' + response.status + ')');
                    }
                } catch (error) {
                    failedSources.push('Warnings');
                }
            }
            
            if (document.getElementById('bf-ignitions').checked) {
                try {
                    prog(50, 'Loading fire ignitions...');
                    var response = await fetch('https://api.bushfire.io/v1/data/au/ignitions', {
                        headers: {
                            'Authorization': 'Bearer ' + bushfireApiKey,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        var data = await response.json();
                        processBushfireIgnitions(data);
                        loadedSources.push('Ignitions (' + (data.features ? data.features.length : 0) + ')');
                    } else {
                        failedSources.push('Ignitions (HTTP ' + response.status + ')');
                    }
                } catch (error) {
                    failedSources.push('Ignitions');
                }
            }
            
            prog(80);
            updateStats();
        return count;  // Return count for caller
            updateAlerts();
            prog(100);
            
            var resultMsg = '';
            if (loadedSources.length > 0) {
                resultMsg = '‚úÖ Bushfire.io: ' + loadedSources.join(', ');
            }
            if (failedSources.length > 0) {
                resultMsg += (resultMsg ? ' | ' : '') + '‚ö†Ô∏è Failed: ' + failedSources.join(', ');
            }
            
            status(resultMsg || 'No data loaded', loadedSources.length > 0 ? 'success' : 'error');
            
            var tot = hazardsData.fires.length + hazardsData.incidents.length + hazardsData.warnings.length;
            document.getElementById('data-status').innerHTML = '<span class="source-success">‚úÖ Bushfire.io: ' + tot + ' at ' + new Date().toLocaleTimeString() + '</span>';
            
        } catch (error) {
            status('‚ùå Bushfire.io error: ' + error.message, 'error');
        }
        
        setTimeout(hide, 1000);
        isProcessing = false;
    }

    function processBushfireWarnings(data) {
        if (!data || !data.features) return;
        
        for (var i = 0; i < data.features.length; i++) {
            try {
                var feature = data.features[i];
                var props = feature.properties || {};
                var geom = feature.geometry;
                
                if (!geom || !geom.coordinates) continue;
                
                var coords;
                if (geom.type === 'Point') {
                    coords = geom.coordinates;
                } else if (geom.type === 'GeometryCollection' && geom.geometries && geom.geometries.length > 0) {
                    var firstPoint = geom.geometries.find(function(g) { return g.type === 'Point'; });
                    if (firstPoint) coords = firstPoint.coordinates;
                }
                
                if (!coords || coords.length < 2) continue;
                
                var lon = coords[0], lat = coords[1];
                if (isNaN(lat) || isNaN(lon)) continue;
                
                var h = {
                    title: props.title || 'Event',
                    category: props.alertLevel || '',
                    status: props.eventStatus || '',
                    type: props.eventClassification || '',
                    lat: lat,
                    lon: lon,
                    description: props.body || props.bodyPlain || '',
                    link: '',
                    source: 'Bushfire.io'
                };
                
                addHazardMarker(h);
            } catch (error) {}
        }
    }

    function processBushfireIgnitions(data) {
        if (!data || !data.features) return;
        
        for (var i = 0; i < data.features.length; i++) {
            try {
                var feature = data.features[i];
                var props = feature.properties || {};
                var geom = feature.geometry;
                
                if (!geom || !geom.coordinates) continue;
                var coords = geom.coordinates;
                if (!coords || coords.length < 2) continue;
                
                var lon = coords[0], lat = coords[1];
                if (isNaN(lat) || isNaN(lon)) continue;
                
                var h = {
                    title: props.title || 'Fire Ignition',
                    category: 'Watch',
                    status: 'Predicted',
                    type: 'Possible Fire Ignition',
                    lat: lat,
                    lon: lon,
                    description: 'Method: ' + (props.method || 'N/A') + '<br />Hotspots: ' + (props.hotspotCount || 0) + '<br />Lightning: ' + (props.lightningCount || 0),
                    link: '',
                    source: 'Bushfire.io Ignition'
                };
                
                var m = L.circleMarker([lat, lon], {
                    radius: 6,
                    fillColor: '#FF6F00',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.85
                });
                
                m.h = h;
                m.on('click', function() {
                    this.bindPopup(createEnhancedPopup(this.h), { maxWidth: 350 }).openPopup();
                });
                
                allFireMarkers.push(m);
                if (clusteringEnabled) firesCluster.addLayer(m); else firesLayer.addLayer(m);
                hazardsData.fires.push(h);
            } catch (error) {}
        }
    }

    // Site Storage Functions
    function saveSitesToStorage() {
        try {
            var siteData = JSON.stringify(sitesData);
            var sizeKB = (siteData.length / 1024).toFixed(1);
            
            if (siteData.length > 5000000) {
                status('‚ö†Ô∏è Sites data too large (' + sizeKB + 'KB). Limit is ~5MB.', 'warning');
                return;
            }
            
            localStorage.setItem('bai_sites_data', siteData);
            localStorage.setItem('bai_sites_timestamp', new Date().toISOString());
            
            sitesSaved = true;
            updateSavedBadge();
            status('‚úÖ Saved ' + sitesData.length + ' sites (' + sizeKB + 'KB)', 'success');
        } catch (error) {
            status('‚ùå Save failed: ' + error.message, 'error');
        }
    }

    function loadSavedSites() {
        try {
            var saved = localStorage.getItem('bai_sites_data');
            if (saved) {
                sitesData = JSON.parse(saved);
                console.log('Loaded', sitesData.length, 'sites from storage');
                
                displaySavedSites();
                sitesSaved = true;
                updateSavedBadge();
                status('‚úÖ Auto-loaded ' + sitesData.length + ' saved sites', 'success');
            }
        } catch (error) {
            console.error('Load saved sites error:', error);
            localStorage.removeItem('bai_sites_data');
        }
    }

    function displaySavedSites() {
        if (sitesData.length === 0) return;
        
        allSiteMarkers = [];
        siteMarkerMap.clear();
        
        sitesData.forEach(function(s) {
            createSiteMarker(s);
        });

        if (clusteringEnabled) {
            sitesCluster.clearLayers();
            sitesCluster.addLayers(allSiteMarkers);
        } else {
            sitesLayer.clearLayers();
            allSiteMarkers.forEach(function(m) {
                sitesLayer.addLayer(m);
            });
        }

        var b = L.latLngBounds(sitesData.map(function(s) { return [s.lat, s.lon]; }));
        map.fitBounds(b, { padding: [50, 50], maxZoom: 15 });
        
        updateStats();
        return count;  // Return count for caller
        document.getElementById('save-sites-btn').disabled = false;
    }

    function createSiteMarker(siteData) {
        // Detect category if not set
        if (!siteData.category) {
            siteData.category = detectCategory(siteData.name);
        }
        
        var isAtRisk = siteData.atRisk || false;
        var color;
        
        // Color priority: At-Risk > Category > Default
        if (isAtRisk) {
            color = siteColors.atRisk;
        } else if (siteData.category === 'Broadcast') {
            color = siteColors.broadcast;
        } else if (siteData.category === 'PSN') {
            color = siteColors.psn;
        } else {
            color = siteColors.default;
        }
        
        var m = L.circleMarker([siteData.lat, siteData.lon], {
            radius: 6,
            fillColor: color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        });
        
        m.siteData = siteData;
        m.on('click', function() {
            if (!this.getPopup()) {
                var h = '<div class="popup-header">' + this.siteData.name + '</div>';
                
                h += '<div class="popup-field">';
                h += '<div class="popup-label">Category</div>';
                h += '<div class="popup-value">üìÇ ' + (this.siteData.category || 'Other') + '</div></div>';
                
                h += '<div class="popup-field"><div class="popup-label">Coordinates</div>';
                h += '<div class="popup-value">üìç ' + this.siteData.lat.toFixed(5) + ', ' + this.siteData.lon.toFixed(5) + '</div></div>';
                
                if (this.siteData.extendedData && Object.keys(this.siteData.extendedData).length > 0) {
                    for (var k in this.siteData.extendedData) {
                        h += '<div class="popup-field">';
                        h += '<div class="popup-label">' + k + '</div>';
                        h += '<div class="popup-value">' + this.siteData.extendedData[k] + '</div>';
                        h += '</div>';
                    }
                }
                
                if (this.siteData.atRisk && this.siteData.nearestHazard) {
                    h += '<div class="popup-field" style="background: #fff3e0;">';
                    h += '<div class="popup-label">‚ö†Ô∏è Nearest Hazard</div>';
                    h += '<div class="popup-value">' + this.siteData.nearestHazard.title + '<br>';
                    h += '<small>' + this.siteData.nearestHazard.distance.toFixed(1) + 'km away</small></div>';
                    h += '</div>';
                }
                
                this.bindPopup(h, { maxWidth: 350 });
                this.openPopup();
            }
        });
        
        // Add to appropriate category array
        if (siteData.category === 'Broadcast') {
            allBroadcastMarkers.push(m);
            if (clusteringEnabled) {
                broadcastCluster.addLayer(m);
            } else {
                broadcastLayer.addLayer(m);
            }
        } else if (siteData.category === 'PSN') {
            allPSNMarkers.push(m);
            if (clusteringEnabled) {
                psnCluster.addLayer(m);
            } else {
                psnLayer.addLayer(m);
            }
        } else {
            allSiteMarkers.push(m);
            if (clusteringEnabled) {
                sitesCluster.addLayer(m);
            } else {
                sitesLayer.addLayer(m);
            }
        }
        
        siteMarkerMap.set(siteData.name, m);
        return m;
    }

    function clearSavedSites() {
        if (!confirm('Delete saved sites from browser storage?')) return;
        
        localStorage.removeItem('bai_sites_data');
        localStorage.removeItem('bai_sites_timestamp');
        sitesSaved = false;
        updateSavedBadge();
        status('Cleared saved sites from storage', 'success');
    }

    function updateSavedBadge() {
        var badge = document.getElementById('saved-badge');
        if (sitesSaved && sitesData.length > 0) {
            badge.innerHTML = '<span class="saved-indicator">üíæ Saved</span>';
        } else {
            badge.innerHTML = '';
        }
    }

    function parseDescription(desc) {
        var data = {};
        if (!desc) return data;
        var lines = desc.split('<br />');
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i].trim();
            if (line.includes(':')) {
                var parts = line.split(':');
                var key = parts[0].trim();
                var value = parts.slice(1).join(':').trim();
                data[key] = value;
            }
        }
        return data;
    }

    function createEnhancedPopup(hazard) {
        var details = parseDescription(hazard.description);
        var alertLevel = hazard.alertLabel || details['ALERT LEVEL'] || details['Alert Level'] || hazard.category || 'Unknown';
        var location = details['LOCATION'] || details['Location'] || hazard.title;
        var council = details['COUNCIL AREA'] || details['Council Area'] || details['LGA'] || '';
        var status = details['STATUS'] || details['Status'] || hazard.status || '';
        var type = details['TYPE'] || details['Type'] || hazard.type || '';
        var fireSize = details['SIZE'] || details['Size'] || '';
        var agency = details['RESPONSIBLE AGENCY'] || details['Responsible Agency'] || details['Agency'] || '';
        var updated = details['UPDATED'] || details['Updated'] || '';
        
        var badgeClass = 'alert-advice';
        if (hazard.alertLevel === 'emergency') badgeClass = 'alert-emergency';
        else if (hazard.alertLevel === 'watch') badgeClass = 'alert-watch';
        else if (hazard.alertLevel === 'advice') badgeClass = 'alert-advice';
        else if (alertLevel.toLowerCase().includes('watch')) badgeClass = 'alert-watch';
        else if (alertLevel.toLowerCase().includes('warning')) badgeClass = 'alert-warning';
        else if (alertLevel.toLowerCase().includes('emergency')) badgeClass = 'alert-emergency';
        
        var statusClass = 'status-controlled';
        if (status.toLowerCase().includes('responding') || status.toLowerCase().includes('going') || status.toLowerCase().includes('predicted')) statusClass = 'status-responding';
        if (status.toLowerCase().includes('out of control') || status.toLowerCase().includes('active')) statusClass = 'status-out';
        
        var html = '<div class="popup-header">' + hazard.title + '</div>';
        
        // Show alert level badge prominently
        if (hazard.alertLabel && hazard.alertLabel !== '‚ÑπÔ∏è INFO') {
            html += '<div class="alert-badge ' + badgeClass + '" style="margin: 8px 0; font-size: 13px; font-weight: 700;">' + hazard.alertLabel + '</div>';
        }
        
        if (hazard.source) {
            html += '<div style="font-size: 11px; color: #666; margin-bottom: 8px;">üì° ' + hazard.source + '</div>';
        }
        
        if (alertLevel !== 'Unknown') {
            html += '<div class="alert-badge ' + badgeClass + '">' + alertLevel + '</div><br>';
        }
        
        if (type) {
            html += '<div class="popup-field">';
            html += '<div class="popup-label">Type</div>';
            html += '<div class="popup-value">üî• ' + type + '</div>';
            html += '</div>';
        }
        
        if (status) {
            html += '<div class="popup-field">';
            html += '<div class="popup-label">Status</div>';
            html += '<div class="popup-value"><span class="status-badge ' + statusClass + '">' + status + '</span></div>';
            html += '</div>';
        }
        
        if (location && location !== hazard.title) {
            html += '<div class="popup-field">';
            html += '<div class="popup-label">Location</div>';
            html += '<div class="popup-value">üìç ' + location + '</div>';
            html += '</div>';
        }
        
        if (council) {
            html += '<div class="popup-field">';
            html += '<div class="popup-label">Council Area</div>';
            html += '<div class="popup-value">' + council + '</div>';
            html += '</div>';
        }
        
        if (fireSize) {
            html += '<div class="popup-field">';
            html += '<div class="popup-label">Fire Size</div>';
            html += '<div class="popup-value">üìè ' + fireSize + '</div>';
            html += '</div>';
        }
        
        if (agency) {
            html += '<div class="popup-field">';
            html += '<div class="popup-label">Responsible Agency</div>';
            html += '<div class="popup-value">üöí ' + agency + '</div>';
            html += '</div>';
        }
        
        html += '<div class="popup-field">';
        html += '<div class="popup-label">Coordinates</div>';
        html += '<div class="popup-value">' + hazard.lat.toFixed(5) + ', ' + hazard.lon.toFixed(5) + '</div>';
        html += '</div>';
        
        if (updated) {
            html += '<div class="popup-field">';
            html += '<div class="popup-label">Last Updated</div>';
            html += '<div class="popup-value">üïê ' + updated + '</div>';
            html += '</div>';
        }
        
        if (hazard.link) {
            html += '<a href="' + hazard.link + '" target="_blank" class="popup-link">View Details ‚Üí</a>';
        }
        
        return html;
    }

    // Event Handlers
    document.getElementById('upload-sites-btn').onclick = function() { 
        if (!isProcessing) document.getElementById('file-input').click(); 
    };
    
    document.getElementById('save-sites-btn').onclick = saveSitesToStorage;
    
    document.getElementById('load-manual-btn').onclick = function() { 
        document.getElementById('hazard-file-input').click(); 
    };
    
    document.getElementById('load-bushfire-btn').onclick = loadFromBushfireIO;
    
    document.getElementById('settings-btn').onclick = function() {
        document.getElementById('settings-modal').classList.add('active');
    };
    
    document.getElementById('clear-btn').onclick = clearAll;
    document.getElementById('clustering-btn').onclick = toggleCluster;
    document.getElementById('add-hazard-btn').onclick = addManual;
    document.getElementById('alert-distance').onchange = updateAlerts;
    
    // Site search
    document.getElementById('site-search-map').oninput = searchSites;
    
    // Base map switcher
    document.getElementById('basemap-selector').onchange = function() {
        switchBaseMap(this.value);
    };
    
    // Weather layers: Use external links in sidebar (in-app tiles have API restrictions)
    
    document.getElementById('toggle-sites').onclick = function() { toggle('sites'); };
    document.getElementById('toggle-broadcast').onclick = function() { toggle('broadcast'); };
    document.getElementById('toggle-psn').onclick = function() { toggle('psn'); };
    document.getElementById('toggle-fires').onclick = function() { toggle('fires'); };
    document.getElementById('toggle-incidents').onclick = function() { toggle('incidents'); };
    document.getElementById('toggle-warnings').onclick = function() { toggle('warnings'); };
    document.getElementById('toggle-hotspots-layer').onclick = function() {
        if (gaHotspotsWMS) {
            var cb = document.getElementById('layer-hotspots');
            cb.checked = !cb.checked;
            if (cb.checked) {
                map.addLayer(gaHotspotsWMS);
            } else {
                map.removeLayer(gaHotspotsWMS);
            }
        }
    };
    
    document.getElementById('toggle-nasa-layer').onclick = function() { toggle('nasa'); };
    
    // Export/Import handlers
    document.getElementById('export-csv-btn').onclick = exportToCSV;
    document.getElementById('export-excel-btn').onclick = exportToExcel;
    document.getElementById('import-btn').onclick = importData;
    document.getElementById('import-file-input').onchange = function(e) {
        if (e.target.files && e.target.files[0]) {
            processImportFile(e.target.files[0]);
            e.target.value = '';
        }
    };

    // Site file upload - MULTIPLE FILES SUPPORTED
    document.getElementById('file-input').onchange = function(e) {
        var files = e.target.files;
        if (!files || files.length === 0 || isProcessing) return;
        
        isProcessing = true;
        var totalFiles = files.length;
        var totalNewSites = 0;
        
        show('Reading ' + totalFiles + ' file(s)...', 'Processing KML/KMZ files');
        prog(5);
        
        function processNextFile(index) {
            if (index >= totalFiles) {
                prog(100);
                if (sitesData.length > 0) {
                    var b = L.latLngBounds(sitesData.map(function(s) { return [s.lat, s.lon]; }));
                    map.fitBounds(b, { padding: [50, 50], maxZoom: 15 });
                }
                updateStats();
        return count;  // Return count for caller
                updateAlerts();
                status('‚úÖ Loaded ' + totalNewSites + ' new sites. Total: ' + sitesData.length, 'success');
                document.getElementById('save-sites-btn').disabled = false;
                setTimeout(hide, 500);
                isProcessing = false;
                e.target.value = '';
                return;
            }
            
            var file = files[index];
            prog(5 + (index / totalFiles) * 90, 'File ' + (index + 1) + '/' + totalFiles + ': ' + file.name);
            
            var reader = new FileReader();
            reader.onload = function(ev) {
                if (file.name.toLowerCase().endsWith('.kmz')) {
                    JSZip.loadAsync(ev.target.result).then(function(zip) {
                        var kf = null;
                        for (var n in zip.files) {
                            if (n.toLowerCase().endsWith('.kml')) { kf = n; break; }
                        }
                        if (!kf) {
                            status('‚ö†Ô∏è No KML found in ' + file.name, 'warning');
                            processNextFile(index + 1);
                            return;
                        }
                        zip.files[kf].async('text').then(function(kt) {
                            var newSites = parseKMLToData(kt, file.name);
                            totalNewSites += newSites;
                            processNextFile(index + 1);
                        }).catch(function(error) {
                            status('‚ùå Error extracting ' + file.name + ': ' + error.message, 'error');
                            console.error('KMZ extraction error:', error);
                            processNextFile(index + 1);
                        });
                    }).catch(function(error) {
                        status('‚ùå Error reading ' + file.name + ': ' + error.message, 'error');
                        console.error('KMZ load error:', error);
                        processNextFile(index + 1);
                    });
                } else {
                    var newSites = parseKMLToData(ev.target.result, file.name);
                    totalNewSites += newSites;
                    processNextFile(index + 1);
                }
            };
            
            reader.onerror = function(error) {
                status('‚ùå Error reading ' + file.name, 'error');
                console.error('File read error:', error);
                processNextFile(index + 1);
            };
            
            // CRITICAL FIX: Read KMZ as binary, KML as text
            if (file.name.toLowerCase().endsWith('.kmz')) {
                reader.readAsArrayBuffer(file);  // Binary for ZIP files
            } else {
                reader.readAsText(file);  // Text for KML files
            }
        }
        
        processNextFile(0);
    };

    // Hazard file upload
    document.getElementById('hazard-file-input').onchange = function(e) {
        var file = e.target.files[0];
        if (!file || isProcessing) return;
        
        isProcessing = true;
        show('Loading hazard data...', file.name);
        prog(20);
        
        var reader = new FileReader();
        reader.onload = function(ev) {
            try {
                prog(50);
                var text = ev.target.result;
                var data = JSON.parse(text);
                
                if (data.features) {
                    processNSWData(data);
                } else if (Array.isArray(data) && data.length > 0 && data[0].incidentName) {
                    processVICData(data);
                } else {
                    throw new Error('Unknown JSON format');
                }
                
                prog(100);
                setTimeout(hide, 500);
                isProcessing = false;
                e.target.value = '';
            } catch (err) {
                status('Error: ' + err.message, 'error');
                hide();
                isProcessing = false;
                e.target.value = '';
            }
        };
        reader.readAsText(file);
    };

    function parseKMLToData(kmlText, filename) {
        try {
            var p = new DOMParser();
            var doc = p.parseFromString(kmlText, 'text/xml');
            if (doc.querySelector('parsererror')) return 0;

            var pms = doc.getElementsByTagName('Placemark');
            if (pms.length === 0) return 0;

            var newSites = 0;
            for (var i = 0; i < pms.length; i++) {
                try {
                    var pm = pms[i];
                    var ne = pm.getElementsByTagName('name')[0] || pm.getElementsByTagName('n')[0];
                    var nm = ne ? ne.textContent : 'Site ' + (sitesData.length + 1);
                    var pt = pm.getElementsByTagName('Point')[0];
                    if (!pt) continue;
                    var ce = pt.getElementsByTagName('coordinates')[0];
                    if (!ce) continue;
                    var ct = ce.textContent.trim().split(',');
                    var lon = parseFloat(ct[0]), lat = parseFloat(ct[1]);
                    if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) continue;

                    var ext = { source_file: filename };
                    var ed = pm.getElementsByTagName('ExtendedData')[0];
                    if (ed) {
                        var sds = ed.getElementsByTagName('SimpleData');
                        for (var j = 0; j < sds.length; j++) {
                            var k = sds[j].getAttribute('name');
                            if (k) ext[k] = sds[j].textContent;
                        }
                    }

                    var siteData = { 
                        name: nm, 
                        lat: lat, 
                        lon: lon, 
                        category: detectCategory(nm),  // Auto-detect category
                        extendedData: ext, 
                        atRisk: false 
                    };
                    sitesData.push(siteData);
                    createSiteMarker(siteData);  // This now handles layer assignment
                    newSites++;
                } catch (e) {}
            }

            return newSites;
        } catch (err) {
            console.error('Parse error:', err);
            return 0;
        }
    }

    function processNSWData(data) {
        if (!data.features) {
            console.error('NSW: No features in data');
            return 0;
        }

        clearHazards();
        
        var count = 0;  // Initialize count variable
        for (var i = 0; i < data.features.length; i++) {
            try {
                var f = data.features[i];
                var pr = f.properties || {};
                var co = f.geometry ? f.geometry.coordinates : null;
                if (!co || co.length < 2) continue;

                var lon = co[0], lat = co[1];
                if (isNaN(lat) || isNaN(lon)) continue;

                var h = {
                    title: pr.title || 'Incident',
                    category: pr.category || '',
                    status: pr.status || '',
                    type: pr.type || '',
                    lat: lat,
                    lon: lon,
                    description: pr.description || '',
                    link: pr.link || '',
                    source: 'NSW RFS'
                };

                addHazardMarker(h);
                count++;  // Increment count
            } catch (e) {
                console.error('NSW: Error processing feature', i, e);
            }
        }

        console.log('‚úÖ NSW: Loaded ' + count + ' incidents');
        updateStats();
        updateAlerts();
        
        var tot = hazardsData.fires.length + hazardsData.incidents.length + hazardsData.warnings.length;
        status('‚úÖ Loaded ' + tot + ' NSW incidents', 'success');
        
        return count;  // Return count for caller
    }

    function addHazardMarker(h) {
        var cat = (h.category || '').toLowerCase();
        var typ = (h.type || '').toLowerCase();
        var status = (h.status || '').toLowerCase();
        
        // Determine alert level from category/status
        var alertLevel = 'unknown';
        var alertLabel;
        
        // Emergency Warning (highest priority)
        if (cat.includes('emergency') || status.includes('emergency') || cat.includes('emergency warning')) {
            alertLevel = 'emergency';
            alertLabel = 'üö® EMERGENCY';
        }
        // Watch and Act
        else if (cat.includes('watch and act') || status.includes('watch and act') || 
                 cat.includes('watch & act') || cat.includes('watch&act') ||
                 status.includes('watch') || cat.includes('prepare to evacuate')) {
            alertLevel = 'watch';
            alertLabel = '‚ö†Ô∏è WATCH & ACT';
        }
        // Advice (including "Not Applicable" from NSW RFS)
        else if (cat.includes('advice') || status.includes('advice') || 
                 cat.includes('not applicable') || status.includes('not applicable') ||
                 cat.includes('being controlled') || status.includes('being controlled') ||
                 cat.includes('under control') || status.includes('under control')) {
            alertLevel = 'advice';
            alertLabel = '‚ÑπÔ∏è ADVICE';
        }
        // NASA FIRMS Hotspots
        else if (typ.includes('hotspot') || (h.source && h.source.includes('NASA FIRMS'))) {
            alertLevel = 'hotspot';
            alertLabel = 'üõ∞Ô∏è HOTSPOT';
        }
        // Fire Ignitions
        else if (typ.includes('ignition') || cat.includes('ignition')) {
            alertLevel = 'ignition';
            alertLabel = '‚ö° IGNITION';
        }
        // VIC/QLD specific categories
        else if (cat.includes('fire') || typ.includes('fire') || typ.includes('bush fire') || 
                 typ.includes('grass fire') || typ.includes('structure fire')) {
            alertLevel = 'advice';  // Default fires to advice if no specific alert level
            alertLabel = '‚ÑπÔ∏è ADVICE';
        }
        // Everything else
        else {
            alertLevel = 'info';
            alertLabel = '‚ÑπÔ∏è INFO';
        }
        
        // Store alert level in hazard object
        h.alertLevel = alertLevel;
        h.alertLabel = alertLabel;
        
        // Get icon configuration for this alert level
        var config = iconConfig[alertLevel] || iconConfig.info;
        var iconStyle = config.style || 'circle';
        var iconColor = config.color || '#757575';
        var iconSize = config.size || 10;
        var iconSymbol = config.symbol || '';
        var shouldPulse = config.pulse || false;
        
        // Create marker based on icon style
        var m;
        
        if (iconStyle === 'triangle') {
            var icon = L.divIcon({
                className: 'hazard-marker' + (shouldPulse ? ' emergency-pulse' : ''),
                html: '<div style="width: 0; height: 0; border-left: ' + (iconSize/2) + 'px solid transparent; border-right: ' + (iconSize/2) + 'px solid transparent; border-bottom: ' + iconSize + 'px solid ' + iconColor + '; position: relative;"><span style="position: absolute; bottom: -' + (iconSize-2) + 'px; left: -' + (iconSize/4) + 'px; font-size: ' + (iconSize/2) + 'px; color: white;">' + iconSymbol + '</span></div>',
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize/2, iconSize]
            });
            m = L.marker([h.lat, h.lon], { icon: icon });
        } else if (iconStyle === 'diamond') {
            var icon = L.divIcon({
                className: 'hazard-marker',
                html: '<div style="width: ' + iconSize + 'px; height: ' + iconSize + 'px; background: ' + iconColor + '; transform: rotate(45deg); border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); position: relative;"><span style="position: absolute; top: ' + (iconSize/4-2) + 'px; left: ' + (iconSize/4-2) + 'px; transform: rotate(-45deg); font-size: ' + (iconSize/2) + 'px; color: white;">' + iconSymbol + '</span></div>',
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize/2, iconSize/2]
            });
            m = L.marker([h.lat, h.lon], { icon: icon });
        } else if (iconStyle === 'square') {
            var icon = L.divIcon({
                className: 'hazard-marker',
                html: '<div style="width: ' + iconSize + 'px; height: ' + iconSize + 'px; background: ' + iconColor + '; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: ' + (iconSize/2) + 'px; color: white;">' + iconSymbol + '</div>',
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize/2, iconSize/2]
            });
            m = L.marker([h.lat, h.lon], { icon: icon });
        } else if (iconStyle === 'star') {
            var icon = L.divIcon({
                className: 'hazard-marker',
                html: '<div style="width: ' + iconSize + 'px; height: ' + iconSize + 'px; display: flex; align-items: center; justify-content: center; font-size: ' + iconSize + 'px; color: ' + iconColor + '; text-shadow: 0 0 3px rgba(0,0,0,0.5);">‚≠ê</div>',
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize/2, iconSize/2]
            });
            m = L.marker([h.lat, h.lon], { icon: icon });
        } else if (iconStyle === 'hexagon') {
            var icon = L.divIcon({
                className: 'hazard-marker',
                html: '<div style="width: ' + iconSize + 'px; height: ' + (iconSize*0.87) + 'px; background: ' + iconColor + '; position: relative; margin: ' + (iconSize*0.29) + 'px 0; border-left: ' + (iconSize*0.5) + 'px solid transparent; border-right: ' + (iconSize*0.5) + 'px solid transparent;"></div>',
                iconSize: [iconSize*2, iconSize*2],
                iconAnchor: [iconSize, iconSize]
            });
            m = L.marker([h.lat, h.lon], { icon: icon });
        } else if (iconStyle === 'emoji') {
            var icon = L.divIcon({
                className: 'hazard-marker',
                html: '<div style="width: ' + iconSize + 'px; height: ' + iconSize + 'px; display: flex; align-items: center; justify-content: center; font-size: ' + (iconSize*0.8) + 'px; background: ' + iconColor + '; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">' + iconSymbol + '</div>',
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize/2, iconSize/2]
            });
            m = L.marker([h.lat, h.lon], { icon: icon });
        } else {
            // Default: circle
            m = L.circleMarker([h.lat, h.lon], { 
                radius: iconSize/2, 
                fillColor: iconColor, 
                color: '#fff', 
                weight: 2, 
                opacity: 1, 
                fillOpacity: 0.85,
                className: shouldPulse ? 'emergency-pulse' : ''
            });
        }
        
        m.h = h;
        m.on('click', function() {
            this.bindPopup(createEnhancedPopup(this.h), { maxWidth: 350 }).openPopup();
        });
        
        // Add to appropriate category
        // NASA FIRMS hotspots go to separate layer for independent control
        if (h.source && h.source.includes('NASA FIRMS')) {
            hazardsData.fires.push(h);  // Still count as fire
            allNASAMarkers.push(m);     // But separate marker array
            if (clusteringEnabled) nasaHotspotsCluster.addLayer(m); else nasaHotspotsLayer.addLayer(m);
        } else if (cat.includes('fire') || typ.includes('fire') || typ.includes('hotspot') || typ.includes('ignition')) {
            hazardsData.fires.push(h);
            allFireMarkers.push(m);
            if (clusteringEnabled) firesCluster.addLayer(m); else firesLayer.addLayer(m);
        } else if (typ.includes('warning') || cat.includes('warning') || alertLevel === 'emergency' || alertLevel === 'watch') {
            hazardsData.warnings.push(h);
            allWarningMarkers.push(m);
            if (clusteringEnabled) warningsCluster.addLayer(m); else warningsLayer.addLayer(m);
        } else {
            hazardsData.incidents.push(h);
            allIncidentMarkers.push(m);
            if (clusteringEnabled) incidentsCluster.addLayer(m); else incidentsLayer.addLayer(m);
        }
    }

    function clearHazards() {
        firesCluster.clearLayers();
        incidentsCluster.clearLayers();
        warningsCluster.clearLayers();
        nasaHotspotsCluster.clearLayers();
        firesLayer.clearLayers();
        incidentsLayer.clearLayers();
        warningsLayer.clearLayers();
        nasaHotspotsLayer.clearLayers();
        hazardsData = { fires: [], incidents: [], warnings: [] };
        allFireMarkers = [];
        allIncidentMarkers = [];
        allWarningMarkers = [];
        allNASAMarkers = [];
    }

    function clearSitesOnly() {
        if (!confirm('Clear sites from map?')) return;
        
        sitesCluster.clearLayers();
        broadcastCluster.clearLayers();
        psnCluster.clearLayers();
        sitesLayer.clearLayers();
        broadcastLayer.clearLayers();
        psnLayer.clearLayers();
        sitesData = [];
        allSiteMarkers = [];
        allBroadcastMarkers = [];
        allPSNMarkers = [];
        siteMarkerMap.clear();
        
        updateStats();
        updateAlerts();
        document.getElementById('save-sites-btn').disabled = true;
        status('Sites cleared from map.', 'success');
    }

    function toggleCluster() {
        clusteringEnabled = !clusteringEnabled;
        
        // Update button text
        var btn = document.getElementById('clustering-btn');
        if (btn) {
            btn.textContent = clusteringEnabled ? 'üî≤ Clustering: ON' : 'üî≤ Clustering: OFF';
            btn.className = clusteringEnabled ? 'btn btn-success' : 'btn btn-info';
        }
        
        // Sync with settings checkbox
        var checkbox = document.getElementById('setting-clustering');
        if (checkbox) checkbox.checked = clusteringEnabled;
        
        // Remove all layers
        map.removeLayer(sitesCluster); map.removeLayer(broadcastCluster); map.removeLayer(psnCluster);
        map.removeLayer(firesCluster); map.removeLayer(incidentsCluster); map.removeLayer(warningsCluster);
        map.removeLayer(nasaHotspotsCluster);
        map.removeLayer(sitesLayer); map.removeLayer(broadcastLayer); map.removeLayer(psnLayer);
        map.removeLayer(firesLayer); map.removeLayer(incidentsLayer); map.removeLayer(warningsLayer);
        map.removeLayer(nasaHotspotsLayer);
        
        if (clusteringEnabled) {
            sitesCluster.clearLayers(); broadcastCluster.clearLayers(); psnCluster.clearLayers();
            firesCluster.clearLayers(); incidentsCluster.clearLayers(); warningsCluster.clearLayers();
            nasaHotspotsCluster.clearLayers();
            
            if (allSiteMarkers.length > 0) sitesCluster.addLayers(allSiteMarkers);
            if (allBroadcastMarkers.length > 0) broadcastCluster.addLayers(allBroadcastMarkers);
            if (allPSNMarkers.length > 0) psnCluster.addLayers(allPSNMarkers);
            if (allFireMarkers.length > 0) firesCluster.addLayers(allFireMarkers);
            if (allIncidentMarkers.length > 0) incidentsCluster.addLayers(allIncidentMarkers);
            if (allWarningMarkers.length > 0) warningsCluster.addLayers(allWarningMarkers);
            if (allNASAMarkers.length > 0) nasaHotspotsCluster.addLayers(allNASAMarkers);
            
            map.addLayer(sitesCluster);
            map.addLayer(broadcastCluster);
            map.addLayer(psnCluster);
            map.addLayer(firesCluster);
            map.addLayer(incidentsCluster);
            map.addLayer(warningsCluster);
            map.addLayer(nasaHotspotsCluster);
            
            status('‚úÖ Clustering enabled', 'success');
        } else {
            sitesLayer.clearLayers(); broadcastLayer.clearLayers(); psnLayer.clearLayers();
            firesLayer.clearLayers(); incidentsLayer.clearLayers(); warningsLayer.clearLayers();
            nasaHotspotsLayer.clearLayers();
            
            allSiteMarkers.forEach(function(m) { sitesLayer.addLayer(m); });
            allBroadcastMarkers.forEach(function(m) { broadcastLayer.addLayer(m); });
            allPSNMarkers.forEach(function(m) { psnLayer.addLayer(m); });
            allFireMarkers.forEach(function(m) { firesLayer.addLayer(m); });
            allIncidentMarkers.forEach(function(m) { incidentsLayer.addLayer(m); });
            allWarningMarkers.forEach(function(m) { warningsLayer.addLayer(m); });
            allNASAMarkers.forEach(function(m) { nasaHotspotsLayer.addLayer(m); });
            
            map.addLayer(sitesLayer);
            map.addLayer(broadcastLayer);
            map.addLayer(psnLayer);
            map.addLayer(firesLayer);
            map.addLayer(incidentsLayer);
            map.addLayer(warningsLayer);
            map.addLayer(nasaHotspotsLayer);
            
            status('‚úÖ Clustering disabled', 'success');
        }
    }

    function toggle(n) {
        var cb = document.getElementById('layer-' + n);
        cb.checked = !cb.checked;
        var cm = { 
            sites: sitesCluster, 
            broadcast: broadcastCluster, 
            psn: psnCluster,
            fires: firesCluster, 
            incidents: incidentsCluster, 
            warnings: warningsCluster,
            nasa: nasaHotspotsCluster  // NASA FIRMS separate layer
        };
        var lm = { 
            sites: sitesLayer, 
            broadcast: broadcastLayer, 
            psn: psnLayer,
            fires: firesLayer, 
            incidents: incidentsLayer, 
            warnings: warningsLayer,
            nasa: nasaHotspotsLayer  // NASA FIRMS separate layer
        };
        if (cb.checked) {
            if (clusteringEnabled) map.addLayer(cm[n]); else map.addLayer(lm[n]);
        } else {
            if (clusteringEnabled) map.removeLayer(cm[n]); else map.removeLayer(lm[n]);
        }
    }

    function addManual() {
        var t = document.getElementById('manual-title').value.trim();
        var la = parseFloat(document.getElementById('manual-lat').value);
        var lo = parseFloat(document.getElementById('manual-lon').value);
        var ty = document.getElementById('manual-type').value;
        if (!t || isNaN(la) || isNaN(lo)) { status('Fill all fields', 'error'); return; }

        var h = { title: t, lat: la, lon: lo, type: ty, description: 'Manual entry', source: 'Manual', category: ty };
        addHazardMarker(h);

        updateStats(); updateAlerts();
        document.getElementById('manual-title').value = '';
        document.getElementById('manual-lat').value = '';
        document.getElementById('manual-lon').value = '';
        status('Added "' + t + '"', 'success');
        map.setView([la, lo], 12);
    }

    function dist(la1, lo1, la2, lo2) {
        var R = 6371, dLa = (la2 - la1) * Math.PI / 180, dLo = (lo2 - lo1) * Math.PI / 180;
        var a = Math.sin(dLa/2) * Math.sin(dLa/2) + Math.cos(la1 * Math.PI / 180) * Math.cos(la2 * Math.PI / 180) * Math.sin(dLo/2) * Math.sin(dLo/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function updateAlerts() {
        var ad = parseFloat(document.getElementById('alert-distance').value);
        var div = document.getElementById('proximity-alerts');
        div.innerHTML = '';
        
        if (sitesData.length === 0) return;

        var als = [];
        var all = hazardsData.fires.concat(hazardsData.incidents).concat(hazardsData.warnings);

        // Reset all sites atRisk status
        sitesData.forEach(function(site) {
            site.atRisk = false;
            site.nearestHazard = null;
        });

        for (var i = 0; i < sitesData.length; i++) {
            var s = sitesData[i], nh = null, md = Infinity;
            for (var j = 0; j < all.length; j++) {
                var d = dist(s.lat, s.lon, all[j].lat, all[j].lon);
                if (d <= ad && d < md) { 
                    md = d; 
                    nh = { 
                        title: all[j].title, 
                        distance: d, 
                        type: all[j].type, 
                        source: all[j].source,
                        alertLevel: all[j].alertLevel,
                        alertLabel: all[j].alertLabel,
                        lat: all[j].lat,
                        lon: all[j].lon
                    }; 
                }
            }
            if (nh) {
                s.atRisk = true;
                s.nearestHazard = nh;
                als.push({ site: s, hazard: nh });
            }
        }
        
        // Update marker colors based on risk
        applyColorChangesToMarkers();

        if (als.length > 0) {
            // Sort by alert level priority first, then distance
            als.sort(function(a, b) {
                var priorityA = a.hazard.alertLevel === 'emergency' ? 0 : a.hazard.alertLevel === 'watch' ? 1 : a.hazard.alertLevel === 'advice' ? 2 : 3;
                var priorityB = b.hazard.alertLevel === 'emergency' ? 0 : b.hazard.alertLevel === 'watch' ? 1 : b.hazard.alertLevel === 'advice' ? 2 : 3;
                if (priorityA !== priorityB) return priorityA - priorityB;
                return a.hazard.distance - b.hazard.distance;
            });
            
            var h = '<div class="proximity-alert"><strong>‚ö†Ô∏è ' + als.length + ' site(s) within ' + ad + 'km</strong>';
            for (var i = 0; i < Math.min(10, als.length); i++) {
                var alertBadge = als[i].hazard.alertLabel || '';
                var alertColorStyle = '';
                if (als[i].hazard.alertLevel === 'emergency') alertColorStyle = 'color: #D32F2F; font-weight: 700;';
                else if (als[i].hazard.alertLevel === 'watch') alertColorStyle = 'color: #F57C00; font-weight: 700;';
                else if (als[i].hazard.alertLevel === 'advice') alertColorStyle = 'color: #FFA726; font-weight: 600;';
                else alertColorStyle = 'color: #f44336;';
                
                // Get hazard location from all hazards
                var hazardLat = als[i].hazard.lat || '';
                var hazardLon = als[i].hazard.lon || '';
                
                h += '<div class="alert-item" data-site-name="' + als[i].site.name + '" data-hazard-lat="' + hazardLat + '" data-hazard-lon="' + hazardLon + '">';
                h += '<div onclick="zoomToSiteFromAlert(this.parentElement)" style="cursor: pointer;">';
                h += '<strong>üìç ' + als[i].site.name + '</strong><br>';
                if (alertBadge) h += '<span style="' + alertColorStyle + '">' + alertBadge + '</span><br>';
                h += '<span style="' + alertColorStyle + '">' + als[i].hazard.title + '</span><br>';
                h += '<small>' + (als[i].hazard.source || '') + ' ‚Ä¢ ' + (als[i].hazard.type || 'Incident') + ' ‚Ä¢ ' + als[i].hazard.distance.toFixed(1) + 'km</small>';
                h += '<br><small style="color: #2196F3;">‚ñ∂ Click to locate SITE on map</small>';
                h += '</div>';
                h += '<div onclick="zoomToHazardFromAlert(this.parentElement)" style="cursor: pointer; margin-top: 5px; padding: 5px; background: rgba(244, 67, 54, 0.1); border-radius: 3px;">';
                h += '<small style="color: #f44336; font-weight: 600;">üî• Click to locate HAZARD on map ‚Üí</small>';
                h += '</div>';
                h += '</div>';
            }
            if (als.length > 10) h += '<div style="margin-top: 8px;"><small>...and ' + (als.length - 10) + ' more. View all in Settings ‚Üí Sites Table</small></div>';
            h += '</div>';
            div.innerHTML = h;
        }
        
        document.getElementById('at-risk-count').textContent = als.length;
    }

    function zoomToSiteFromAlert(element) {
        var siteName = element.getAttribute('data-site-name');
        zoomToSite(siteName);
    }
    
    function zoomToHazardFromAlert(element) {
        var lat = parseFloat(element.getAttribute('data-hazard-lat'));
        var lon = parseFloat(element.getAttribute('data-hazard-lon'));
        
        if (!isNaN(lat) && !isNaN(lon)) {
            map.setView([lat, lon], 14);
            console.log('‚úÖ Zoomed to hazard at:', lat, lon);
            status('üìç Located hazard on map', 'success');
        } else {
            status('‚ùå Hazard location not available', 'error');
        }
    }
    
    function searchSites() {
        var searchTerm = document.getElementById('site-search-map').value.toLowerCase().trim();
        var resultsDiv = document.getElementById('search-results');
        
        if (!searchTerm) {
            resultsDiv.innerHTML = '';
            return;
        }
        
        var matches = sitesData.filter(function(site) {
            var nameMatch = site.name.toLowerCase().includes(searchTerm);
            var numberMatch = site.extendedData && site.extendedData.Site_Number && 
                             site.extendedData.Site_Number.toString().includes(searchTerm);
            var categoryMatch = site.category && site.category.toLowerCase().includes(searchTerm);
            return nameMatch || numberMatch || categoryMatch;
        });
        
        if (matches.length === 0) {
            resultsDiv.innerHTML = '<div style="padding: 10px; text-align: center; color: #999; font-size: 12px;">No sites found</div>';
            return;
        }
        
        var html = '';
        for (var i = 0; i < Math.min(10, matches.length); i++) {
            var s = matches[i];
            var categoryColor = s.category === 'Broadcast' ? '#9C27B0' : s.category === 'PSN' ? '#00BCD4' : '#4CAF50';
            var riskBadge = s.atRisk ? '<span style="background: #FF9800; color: white; padding: 2px 5px; border-radius: 3px; font-size: 10px; margin-left: 5px;">‚ö†Ô∏è At Risk</span>' : '';
            
            html += '<div onclick="zoomToSite(\'' + s.name + '\')" style="padding: 8px; margin-bottom: 5px; background: #f9f9f9; border-radius: 5px; cursor: pointer; border-left: 4px solid ' + categoryColor + ';">';
            html += '<div style="font-weight: 600; font-size: 13px;">' + s.name + riskBadge + '</div>';
            html += '<div style="font-size: 11px; color: #666;">' + (s.extendedData && s.extendedData.Site_Number || 'No number') + ' ‚Ä¢ ' + (s.category || 'Other') + '</div>';
            html += '</div>';
        }
        
        if (matches.length > 10) {
            html += '<div style="padding: 8px; text-align: center; font-size: 11px; color: #666;">' + (matches.length - 10) + ' more results...</div>';
        }
        
        resultsDiv.innerHTML = html;
    }

    function updateStats() {
        // Count sites by category
        var broadcastCount = sitesData.filter(function(s) { return s.category === 'Broadcast'; }).length;
        var psnCount = sitesData.filter(function(s) { return s.category === 'PSN'; }).length;
        var otherCount = sitesData.length - broadcastCount - psnCount;
        
        document.getElementById('site-count').textContent = sitesData.length;
        document.getElementById('sites-count').textContent = otherCount;
        document.getElementById('broadcast-count').textContent = broadcastCount;
        document.getElementById('psn-count').textContent = psnCount;
        
        // Count hazards by alert level
        var allHazards = hazardsData.fires.concat(hazardsData.incidents).concat(hazardsData.warnings);
        var emergencyCount = allHazards.filter(function(h) { return h.alertLevel === 'emergency'; }).length;
        var watchCount = allHazards.filter(function(h) { return h.alertLevel === 'watch'; }).length;
        var adviceCount = allHazards.filter(function(h) { return h.alertLevel === 'advice'; }).length;
        var hotspotCount = allHazards.filter(function(h) { return h.alertLevel === 'hotspot'; }).length;
        var otherHazardCount = allHazards.filter(function(h) { return h.alertLevel === 'info'; }).length;
        
        document.getElementById('emergency-count').textContent = emergencyCount;
        document.getElementById('watch-count').textContent = watchCount;
        document.getElementById('advice-count').textContent = adviceCount;
        
        // Update active icons display
        updateActiveIconsDisplay(emergencyCount, watchCount, adviceCount, hotspotCount, otherHazardCount);
        
        var th = hazardsData.fires.length + hazardsData.incidents.length + hazardsData.warnings.length;
        document.getElementById('hazard-count').textContent = th;
        document.getElementById('fire-count').textContent = hazardsData.fires.length;
        document.getElementById('fires-count').textContent = hazardsData.fires.length;
        document.getElementById('warnings-count').textContent = hazardsData.warnings.length;
        document.getElementById('incidents-count').textContent = hazardsData.incidents.length;
        document.getElementById('nasa-count').textContent = allNASAMarkers.length;
        
        // Enable/disable export buttons
        var hasData = sitesData.length > 0;
        document.getElementById('export-excel-btn').disabled = !hasData;
        document.getElementById('export-csv-btn').disabled = !hasData;
        document.getElementById('import-btn').disabled = false; // Always enabled
    }
    
    function updateActiveIconsDisplay(emergency, watch, advice, hotspot, other) {
        var display = document.getElementById('active-icons-display');
        if (!display) return;
        
        var totalHazards = emergency + watch + advice + hotspot + other;
        
        if (totalHazards === 0) {
            display.innerHTML = '<div style="font-size: 11px; color: #666; text-align: center;">No hazards loaded</div>';
            return;
        }
        
        var html = '<div style="font-size: 11px; font-weight: 600; margin-bottom: 8px; color: #1e3c72;">Icons Currently on Map:</div>';
        
        if (emergency > 0) {
            html += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; padding: 5px; background: rgba(211,47,47,0.1); border-radius: 4px;">';
            html += '<div style="width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 14px solid #D32F2F;"></div>';
            html += '<span style="font-size: 12px; font-weight: 600; color: #D32F2F;">' + emergency + ' Emergency</span>';
            html += '</div>';
        }
        
        if (watch > 0) {
            html += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; padding: 5px; background: rgba(245,124,0,0.1); border-radius: 4px;">';
            html += '<div style="width: 12px; height: 12px; background: #F57C00; transform: rotate(45deg); border: 1px solid white;"></div>';
            html += '<span style="font-size: 12px; font-weight: 600; color: #F57C00;">' + watch + ' Watch & Act</span>';
            html += '</div>';
        }
        
        if (advice > 0) {
            html += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; padding: 5px; background: rgba(255,167,38,0.1); border-radius: 4px;">';
            html += '<div style="width: 10px; height: 10px; background: #FFA726; border-radius: 50%; border: 1px solid white;"></div>';
            html += '<span style="font-size: 12px; font-weight: 600; color: #FFA726;">' + advice + ' Advice</span>';
            html += '</div>';
        }
        
        if (hotspot > 0) {
            html += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; padding: 5px; background: rgba(156,39,176,0.1); border-radius: 4px;">';
            html += '<div style="width: 6px; height: 6px; background: #9C27B0; border-radius: 50%; border: 1px solid white;"></div>';
            html += '<span style="font-size: 12px; font-weight: 600; color: #9C27B0;">' + hotspot + ' Hotspots</span>';
            html += '</div>';
        }
        
        if (other > 0) {
            html += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; padding: 5px; background: rgba(117,117,117,0.1); border-radius: 4px;">';
            html += '<div style="width: 6px; height: 6px; background: #757575; border-radius: 50%; border: 1px solid white;"></div>';
            html += '<span style="font-size: 12px; color: #757575;">' + other + ' Other</span>';
            html += '</div>';
        }
        
        display.innerHTML = html;
    }

    function status(m, t) {
        var d = document.getElementById('load-status');
        var c = t === 'error' ? 'error-box' : t === 'success' ? 'success-box' : t === 'warning' ? 'warning-box' : 'info-box';
        d.innerHTML = '<div class="' + c + '">' + m + '</div>';
        if (t === 'success') setTimeout(function() { d.innerHTML = ''; }, 5000);
    }

    function clearAll() {
        if (!confirm('Clear all data from map?')) return;
        
        sitesCluster.clearLayers(); broadcastCluster.clearLayers(); psnCluster.clearLayers();
        firesCluster.clearLayers(); incidentsCluster.clearLayers(); warningsCluster.clearLayers();
        nasaHotspotsCluster.clearLayers();
        sitesLayer.clearLayers(); broadcastLayer.clearLayers(); psnLayer.clearLayers();
        firesLayer.clearLayers(); incidentsLayer.clearLayers(); warningsLayer.clearLayers();
        nasaHotspotsLayer.clearLayers();
        sitesData = []; hazardsData = { fires: [], incidents: [], warnings: [] };
        allSiteMarkers = []; allBroadcastMarkers = []; allPSNMarkers = [];
        allFireMarkers = []; allIncidentMarkers = []; allWarningMarkers = []; allNASAMarkers = [];
        siteMarkerMap.clear();
        
        document.getElementById('proximity-alerts').innerHTML = '';
        document.getElementById('load-status').innerHTML = '';
        document.getElementById('data-status').textContent = 'No hazard data loaded';
        document.getElementById('save-sites-btn').disabled = true;
        document.getElementById('export-excel-btn').disabled = true;
        document.getElementById('export-csv-btn').disabled = true;
        document.getElementById('import-btn').disabled = false;  // Import always available
        
        updateStats();
        status('Map cleared.', 'success');
    }

    // ========== EXPORT/IMPORT FUNCTIONS ==========
    
    function exportToCSV() {
        if (sitesData.length === 0) {
            status('‚ùå No sites to export', 'error');
            return;
        }
        
        var csv = 'Name,Latitude,Longitude,Category,Status,At Risk,Nearest Hazard,Distance (km)\n';
        
        for (var i = 0; i < sitesData.length; i++) {
            var s = sitesData[i];
            var category = s.category || 'Other';
            var atRisk = s.atRisk ? 'Yes' : 'No';
            var hazard = s.nearestHazard ? s.nearestHazard.title : '';
            var distance = s.nearestHazard ? s.nearestHazard.distance.toFixed(2) : '';
            
            csv += '"' + s.name + '",';
            csv += s.lat + ',';
            csv += s.lon + ',';
            csv += category + ',';
            csv += (s.extendedData && s.extendedData.status ? s.extendedData.status : 'Active') + ',';
            csv += atRisk + ',';
            csv += '"' + hazard + '",';
            csv += distance + '\n';
        }
        
        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');
        var url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'BAI_Sites_' + new Date().toISOString().slice(0,10) + '.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        status('‚úÖ Exported ' + sitesData.length + ' sites to CSV', 'success');
    }
    
    function exportToExcel() {
        if (sitesData.length === 0) {
            status('‚ùå No sites to export', 'error');
            return;
        }
        
        try {
            var data = [];
            data.push(['Name', 'Latitude', 'Longitude', 'Category', 'Status', 'At Risk', 'Nearest Hazard', 'Distance (km)', 'Source File']);
            
            for (var i = 0; i < sitesData.length; i++) {
                var s = sitesData[i];
                var category = s.category || 'Other';
                var atRisk = s.atRisk ? 'Yes' : 'No';
                var hazard = s.nearestHazard ? s.nearestHazard.title : '';
                var distance = s.nearestHazard ? s.nearestHazard.distance.toFixed(2) : '';
                var sourceFile = s.extendedData && s.extendedData.source_file ? s.extendedData.source_file : '';
                
                data.push([
                    s.name,
                    s.lat,
                    s.lon,
                    category,
                    (s.extendedData && s.extendedData.status ? s.extendedData.status : 'Active'),
                    atRisk,
                    hazard,
                    distance,
                    sourceFile
                ]);
            }
            
            var ws = XLSX.utils.aoa_to_sheet(data);
            var wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'BAI Sites');
            
            XLSX.writeFile(wb, 'BAI_Sites_' + new Date().toISOString().slice(0,10) + '.xlsx');
            status('‚úÖ Exported ' + sitesData.length + ' sites to Excel', 'success');
        } catch (error) {
            status('‚ùå Excel export failed: ' + error.message, 'error');
            console.error('Excel export error:', error);
        }
    }
    
    function importData() {
        document.getElementById('import-file-input').click();
    }
    
    function processImportFile(file) {
        if (!file) return;
        
        var fileName = file.name.toLowerCase();
        
        if (fileName.endsWith('.csv')) {
            importFromCSV(file);
        } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
            importFromExcel(file);
        } else {
            status('‚ùå Unsupported file type. Use .csv, .xlsx, or .xls', 'error');
        }
    }
    
    function importFromCSV(file) {
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var csv = e.target.result;
                var lines = csv.split('\n');
                
                if (lines.length < 2) {
                    status('‚ùå CSV file is empty', 'error');
                    return;
                }
                
                var headers = lines[0].split(',').map(function(h) { return h.trim().replace(/"/g, ''); });
                var nameIdx = headers.indexOf('Name');
                var latIdx = headers.indexOf('Latitude');
                var lonIdx = headers.indexOf('Longitude');
                var catIdx = headers.indexOf('Category');
                
                if (nameIdx === -1 || latIdx === -1 || lonIdx === -1) {
                    status('‚ùå CSV must have Name, Latitude, Longitude columns', 'error');
                    return;
                }
                
                var imported = 0;
                for (var i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    var cols = lines[i].split(',').map(function(c) { return c.trim().replace(/"/g, ''); });
                    if (cols.length < 3) continue;
                    
                    var name = cols[nameIdx];
                    var lat = parseFloat(cols[latIdx]);
                    var lon = parseFloat(cols[lonIdx]);
                    var category = catIdx !== -1 ? cols[catIdx] : detectCategory(name);
                    
                    if (!name || isNaN(lat) || isNaN(lon)) continue;
                    
                    var siteData = {
                        name: name,
                        lat: lat,
                        lon: lon,
                        category: category,
                        extendedData: { source_file: file.name },
                        atRisk: false
                    };
                    
                    sitesData.push(siteData);
                    createSiteMarker(siteData);
                    imported++;
                }
                
                if (imported > 0) {
                    refreshAllLayers();
                    updateStats();
        return count;  // Return count for caller
                    updateAlerts();
                    document.getElementById('save-sites-btn').disabled = false;
                    document.getElementById('export-excel-btn').disabled = false;
                    document.getElementById('export-csv-btn').disabled = false;
                    
                    var bounds = L.latLngBounds(sitesData.map(function(s) { return [s.lat, s.lon]; }));
                    map.fitBounds(bounds, { padding: [50, 50] });
                    
                    status('‚úÖ Imported ' + imported + ' sites from CSV', 'success');
                } else {
                    status('‚ùå No valid sites found in CSV', 'error');
                }
            } catch (error) {
                status('‚ùå CSV import failed: ' + error.message, 'error');
                console.error('CSV import error:', error);
            }
        };
        reader.readAsText(file);
    }
    
    function importFromExcel(file) {
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = new Uint8Array(e.target.result);
                var workbook = XLSX.read(data, { type: 'array' });
                var sheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[sheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) {
                    status('‚ùå Excel file is empty', 'error');
                    return;
                }
                
                var imported = 0;
                for (var i = 0; i < jsonData.length; i++) {
                    var row = jsonData[i];
                    
                    var name = row.Name || row.name;
                    var lat = parseFloat(row.Latitude || row.latitude || row.lat);
                    var lon = parseFloat(row.Longitude || row.longitude || row.lon);
                    var category = row.Category || row.category || detectCategory(name);
                    
                    if (!name || isNaN(lat) || isNaN(lon)) continue;
                    
                    var siteData = {
                        name: name,
                        lat: lat,
                        lon: lon,
                        category: category,
                        extendedData: { source_file: file.name },
                        atRisk: false
                    };
                    
                    sitesData.push(siteData);
                    createSiteMarker(siteData);
                    imported++;
                }
                
                if (imported > 0) {
                    refreshAllLayers();
                    updateStats();
                    updateAlerts();
                    document.getElementById('save-sites-btn').disabled = false;
                    document.getElementById('export-excel-btn').disabled = false;
                    document.getElementById('export-csv-btn').disabled = false;
                    
                    var bounds = L.latLngBounds(sitesData.map(function(s) { return [s.lat, s.lon]; }));
                    map.fitBounds(bounds, { padding: [50, 50] });
                    
                    status('‚úÖ Imported ' + imported + ' sites from Excel', 'success');
                } else {
                    status('‚ùå No valid sites found in Excel', 'error');
                }
            } catch (error) {
                status('‚ùå Excel import failed: ' + error.message, 'error');
                console.error('Excel import error:', error);
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    function detectCategory(siteName) {
        var name = siteName.toLowerCase();
        if (name.includes('broadcast') || name.includes('bc') || name.includes('tx')) {
            return 'Broadcast';
        } else if (name.includes('psn') || name.includes('public safety')) {
            return 'PSN';
        }
        return 'Other';
    }
    
    function refreshAllLayers() {
        // Clear all layers
        sitesCluster.clearLayers(); broadcastCluster.clearLayers(); psnCluster.clearLayers();
        firesCluster.clearLayers(); incidentsCluster.clearLayers(); warningsCluster.clearLayers();
        nasaHotspotsCluster.clearLayers();
        sitesLayer.clearLayers(); broadcastLayer.clearLayers(); psnLayer.clearLayers();
        firesLayer.clearLayers(); incidentsLayer.clearLayers(); warningsLayer.clearLayers();
        nasaHotspotsLayer.clearLayers();
        
        // Re-add all markers to appropriate layers
        if (clusteringEnabled) {
            if (allSiteMarkers.length > 0) sitesCluster.addLayers(allSiteMarkers);
            if (allBroadcastMarkers.length > 0) broadcastCluster.addLayers(allBroadcastMarkers);
            if (allPSNMarkers.length > 0) psnCluster.addLayers(allPSNMarkers);
            if (allFireMarkers.length > 0) firesCluster.addLayers(allFireMarkers);
            if (allIncidentMarkers.length > 0) incidentsCluster.addLayers(allIncidentMarkers);
            if (allWarningMarkers.length > 0) warningsCluster.addLayers(allWarningMarkers);
            if (allNASAMarkers.length > 0) nasaHotspotsCluster.addLayers(allNASAMarkers);
        } else {
            allSiteMarkers.forEach(function(m) { sitesLayer.addLayer(m); });
            allBroadcastMarkers.forEach(function(m) { broadcastLayer.addLayer(m); });
            allPSNMarkers.forEach(function(m) { psnLayer.addLayer(m); });
            allFireMarkers.forEach(function(m) { firesLayer.addLayer(m); });
            allIncidentMarkers.forEach(function(m) { incidentsLayer.addLayer(m); });
            allWarningMarkers.forEach(function(m) { warningsLayer.addLayer(m); });
            allNASAMarkers.forEach(function(m) { nasaHotspotsLayer.addLayer(m); });
        }
    }

    // ========== LIVE UPDATES INTEGRATION ==========
    var autoRefreshInterval = null;
    var lastRefreshTime = null;
    
    // Multiple CORS Proxies for fallback
    var corsProxies = [
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url=',
        'https://api.codetabs.com/v1/proxy?quest='
    ];
    var currentProxyIndex = 0;
    
    // NASA FIRMS API
    var nasaFirmsKey = '55e60f39b9189c9731430d5bf01907b9';  // Pre-configured API key

    // Load saved NASA FIRMS key
    function loadSavedNASAKey() {
        var saved = localStorage.getItem('bai_nasa_firms_key');
        console.log('NASA FIRMS: Checking saved key...', saved ? 'Found in storage' : 'Using pre-configured key');
        
        // Use saved key or fall back to pre-configured key
        if (saved) {
            nasaFirmsKey = saved;
            console.log('‚úÖ NASA FIRMS key loaded from storage:', saved.substring(0, 8) + '...');
        } else {
            // nasaFirmsKey already set to default value above
            console.log('‚úÖ NASA FIRMS using pre-configured key:', nasaFirmsKey.substring(0, 8) + '...');
        }
        
        // Update UI if key exists
        if (nasaFirmsKey) {
            document.getElementById('nasa-firms-key').value = nasaFirmsKey;
            document.getElementById('nasa-status').innerHTML = '‚úÖ NASA FIRMS key configured and ready';
            document.getElementById('nasa-status').style.background = '#e8f5e9';
            document.getElementById('load-nasa-btn').disabled = false;
            console.log('‚úÖ NASA FIRMS button enabled');
        }
    }

    // Save NASA FIRMS key
    document.getElementById('save-nasa-key-btn').onclick = function() {
        var key = document.getElementById('nasa-firms-key').value.trim();
        if (!key) {
            document.getElementById('nasa-status').innerHTML = '‚ùå Please enter a valid key';
            document.getElementById('nasa-status').style.background = '#ffebee';
            return;
        }
        localStorage.setItem('bai_nasa_firms_key', key);
        nasaFirmsKey = key;
        document.getElementById('nasa-status').innerHTML = '‚úÖ NASA FIRMS key saved!';
        document.getElementById('nasa-status').style.background = '#e8f5e9';
        document.getElementById('load-nasa-btn').disabled = false;
        console.log('‚úÖ NASA FIRMS key saved:', key.substring(0, 8) + '...');
        status('NASA FIRMS key saved successfully', 'success');
    };

    // Clear NASA FIRMS key
    document.getElementById('clear-nasa-key-btn').onclick = function() {
        localStorage.removeItem('bai_nasa_firms_key');
        nasaFirmsKey = '';
        document.getElementById('nasa-firms-key').value = '';
        document.getElementById('nasa-status').innerHTML = 'No NASA FIRMS key configured';
        document.getElementById('nasa-status').style.background = '#f5f5f5';
        document.getElementById('load-nasa-btn').disabled = true;
        console.log('NASA FIRMS key cleared');
        status('NASA FIRMS key cleared', 'info');
    };
    
    // Test NASA FIRMS key button
    document.getElementById('test-nasa-key-btn').onclick = testNASAKey;
    
    // Test NASA FIRMS key
    async function testNASAKey() {
        var key = document.getElementById('nasa-firms-key').value.trim();
        if (!key) {
            document.getElementById('nasa-status').innerHTML = '‚ùå Please enter a key first';
            document.getElementById('nasa-status').style.background = '#ffebee';
            return;
        }
        
        try {
            document.getElementById('nasa-status').innerHTML = 'üîÑ Testing API key...';
            document.getElementById('nasa-status').style.background = '#e3f2fd';
            
            // Test with a small area and 1 day
            var testUrl = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${key}/VIIRS_SNPP_NRT/151,-34,152,-33/1`;
            console.log('Testing NASA FIRMS key...');
            
            var response = await fetch(testUrl);
            console.log('Test response status:', response.status);
            
            if (response.status === 200) {
                document.getElementById('nasa-status').innerHTML = '‚úÖ API key is VALID! Click Save to use it.';
                document.getElementById('nasa-status').style.background = '#e8f5e9';
                console.log('‚úÖ NASA FIRMS key is valid');
            } else if (response.status === 401 || response.status === 403) {
                var errorText = await response.text();
                document.getElementById('nasa-status').innerHTML = '‚ùå Invalid API key. Get one from NASA FIRMS.';
                document.getElementById('nasa-status').style.background = '#ffebee';
                console.error('‚ùå Invalid API key:', errorText);
            } else {
                var errorText = await response.text();
                document.getElementById('nasa-status').innerHTML = '‚ö†Ô∏è Error ' + response.status + ': ' + errorText;
                document.getElementById('nasa-status').style.background = '#fff3e0';
                console.error('NASA FIRMS test error:', response.status, errorText);
            }
        } catch (error) {
            document.getElementById('nasa-status').innerHTML = '‚ùå Test failed: ' + error.message;
            document.getElementById('nasa-status').style.background = '#ffebee';
            console.error('NASA FIRMS test error:', error);
        }
    }

    // Load NASA FIRMS hotspots (last 24 hours for Australia)
    async function loadNASAFIRMS() {
        console.log('üõ∞Ô∏è NASA FIRMS: Function called');
        
        if (!nasaFirmsKey) {
            status('‚ùå NASA FIRMS key not configured. Go to Settings ‚Üí Bushfire.io API tab', 'error');
            updateSourceStatus('nasa', false);
            document.getElementById('settings-modal').classList.add('active');
            // Switch to API tab
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            document.querySelector('.tab[data-tab="bushfire"]').classList.add('active');
            document.getElementById('tab-bushfire').classList.add('active');
            return false;
        }

        try {
            status('üîÑ Loading NASA FIRMS satellite hotspots...', 'info');
            updateSourceStatus('nasa', null);  // Loading state
            console.log('NASA FIRMS: Using API key:', nasaFirmsKey.substring(0, 8) + '...');
            
            // Australia bounding box: west,south,east,north
            var bbox = '113,-44,154,-10';
            var days = 1; // Last 24 hours
            
            // VIIRS for better resolution
            var url = `https://firms.modaps.eosdis.nasa.gov/api/area/csv/${nasaFirmsKey}/VIIRS_SNPP_NRT/${bbox}/${days}`;
            console.log('NASA FIRMS: Fetching from:', url.replace(nasaFirmsKey, 'API_KEY'));
            
            var response = await fetch(url);
            console.log('NASA FIRMS: Response status:', response.status);
            
            if (!response.ok) {
                var errorText = await response.text();
                console.error('NASA FIRMS: Error response:', errorText);
                updateSourceStatus('nasa', false);
                
                if (response.status === 401 || response.status === 403) {
                    throw new Error('Invalid API key. Please check your NASA FIRMS Map Key.');
                } else {
                    throw new Error('API returned error ' + response.status + ': ' + errorText);
                }
            }
            
            var csvText = await response.text();
            console.log('NASA FIRMS: Received data, length:', csvText.length);
            
            var count = processNASAFIRMSData(csvText);
            updateSourceStatus('nasa', true, count);
            updateLastRefresh('NASA FIRMS');
            return true;
        } catch (error) {
            status('‚ùå Failed to load NASA FIRMS: ' + error.message, 'error');
            console.error('NASA FIRMS Error:', error);
            updateSourceStatus('nasa', false);
            return false;
        }
    }

    // Parse NASA FIRMS CSV data
    function processNASAFIRMSData(csvText) {
        try {
            console.log('NASA FIRMS: Processing CSV data...');
            
            // Check if we got an error message instead of CSV
            if (csvText.includes('Invalid MAP_KEY') || csvText.includes('error')) {
                status('‚ùå Invalid NASA FIRMS API key', 'error');
                console.error('NASA FIRMS: Error in response:', csvText.substring(0, 200));
                return;
            }
            
            var lines = csvText.trim().split('\n');
            console.log('NASA FIRMS: Total lines:', lines.length);
            
            if (lines.length < 2) {
                status('‚ÑπÔ∏è No active fires detected in Australia (last 24h)', 'info');
                console.log('NASA FIRMS: No data available');
                return;
            }
            
            // Parse CSV header
            var headers = lines[0].split(',');
            console.log('NASA FIRMS: Headers:', headers);
            
            var latIdx = headers.indexOf('latitude');
            var lonIdx = headers.indexOf('longitude');
            var brightIdx = headers.indexOf('bright_ti4');
            var confIdx = headers.indexOf('confidence');
            var frpIdx = headers.indexOf('frp');
            var dateIdx = headers.indexOf('acq_date');
            var timeIdx = headers.indexOf('acq_time');
            
            if (latIdx === -1 || lonIdx === -1) {
                status('‚ùå Invalid NASA FIRMS data format', 'error');
                console.error('NASA FIRMS: Missing lat/lon columns. Headers:', headers);
                return;
            }
            
            console.log('NASA FIRMS: Column indices - lat:', latIdx, 'lon:', lonIdx);
            
            var count = 0;
            for (var i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                var cols = lines[i].split(',');
                if (cols.length < headers.length) continue;
                
                var lat = parseFloat(cols[latIdx]);
                var lon = parseFloat(cols[lonIdx]);
                if (isNaN(lat) || isNaN(lon)) continue;
                
                var brightness = brightIdx !== -1 ? parseFloat(cols[brightIdx]) : 0;
                var confidence = confIdx !== -1 ? cols[confIdx] : 'unknown';
                var frp = frpIdx !== -1 ? parseFloat(cols[frpIdx]) : 0;
                var date = dateIdx !== -1 ? cols[dateIdx] : '';
                var time = timeIdx !== -1 ? cols[timeIdx] : '';
                
                var h = {
                    title: 'NASA FIRMS Hotspot',
                    category: 'Satellite Detection',
                    status: 'Confidence: ' + confidence,
                    type: 'hotspot',  // Changed from 'fire' to 'hotspot' for correct categorization
                    lat: lat,
                    lon: lon,
                    description: 'Brightness: ' + brightness.toFixed(1) + 'K, FRP: ' + frp.toFixed(1) + 'MW<br>Detected: ' + date + ' ' + time,
                    source: 'NASA FIRMS VIIRS',
                    link: 'https://firms.modaps.eosdis.nasa.gov/'
                };
                
                addHazardMarker(h);
                count++;
            }
            
            console.log('‚úÖ NASA FIRMS: Loaded ' + count + ' hotspots');
            updateStats();
            updateAlerts();
            
            if (count > 0) {
                status('‚úÖ Loaded ' + count + ' NASA FIRMS hotspots', 'success');
            } else {
                status('‚ÑπÔ∏è NASA FIRMS: No hotspots detected (last 24h)', 'info');
            }
            
            return count;  // Return count for caller
        } catch (error) {
            console.error('NASA FIRMS parsing error:', error);
            status('‚ùå Error parsing NASA FIRMS data', 'error');
        }
    }

    // Update data source status indicators
    function updateSourceStatus(source, success, count) {
        var statusEl = document.getElementById('source-' + source + '-status');
        if (!statusEl) return;
        
        var sourceName = source.toUpperCase();
        if (source === 'nasa') sourceName = 'NASA';
        if (source === 'wms') sourceName = 'WMS';
        
        if (success) {
            statusEl.innerHTML = sourceName + ': <span style="color: #4CAF50; font-weight: 600;">‚úÖ ' + (count !== undefined ? count + ' loaded' : 'Active') + '</span>';
        } else {
            statusEl.innerHTML = sourceName + ': <span style="color: #f44336; font-weight: 600;">‚ùå Failed</span>';
        }
    }

    async function loadNSWRFS() {
        try {
            status('üîÑ Loading NSW RFS data...', 'info');
            updateSourceStatus('nsw', null);  // Loading state
            
            const response = await fetch('https://www.rfs.nsw.gov.au/feeds/majorIncidents.json');
            
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            
            const data = await response.json();
            
            if (!data.features || !Array.isArray(data.features)) {
                throw new Error('Invalid data format');
            }
            
            processNSWData(data);
            var count = data.features.length;
            updateSourceStatus('nsw', true, count);
            updateLastRefresh('NSW RFS');
            return true;
        } catch (error) {
            status('‚ùå NSW RFS failed: ' + error.message, 'error');
            console.error('NSW RFS Error:', error);
            updateSourceStatus('nsw', false);
            return false;
        }
    }

    async function loadVICEmergency() {
        try {
            status('üîÑ Loading VIC Emergency data...', 'info');
            updateSourceStatus('vic', null);  // Loading state
            var url = 'https://data.emergency.vic.gov.au/Show?pageId=getIncidentJSON';
            
            // Try with CORS proxy
            for (var i = 0; i < corsProxies.length; i++) {
                try {
                    console.log('VIC: Trying proxy ' + (i + 1));
                    var proxyUrl = corsProxies[i] + encodeURIComponent(url);
                    var response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        var data = await response.json();
                        var count = processVICData(data);  // Returns count
                        updateSourceStatus('vic', true, count);
                        updateLastRefresh('VIC Emergency');
                        return true;
                    }
                } catch (e) {
                    console.log('VIC: Proxy ' + (i + 1) + ' failed:', e.message);
                    continue;
                }
            }
            
            throw new Error('All proxies failed. Download manually.');
        } catch (error) {
            status('‚ö†Ô∏è VIC Emergency unavailable. Use manual download link below.', 'warning');
            console.error('VIC Emergency Error:', error);
            updateSourceStatus('vic', false);
            return false;
        }
    }

    async function loadQLDFire() {
        try {
            status('üîÑ Loading QLD Fire data...', 'info');
            updateSourceStatus('qld', null);  // Loading state
            var url = 'https://www.qfes.qld.gov.au/data/alerts/bushfireAlert.json';
            
            // Try with CORS proxy
            for (var i = 0; i < corsProxies.length; i++) {
                try {
                    console.log('QLD: Trying proxy ' + (i + 1));
                    var proxyUrl = corsProxies[i] + encodeURIComponent(url);
                    var response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        var data = await response.json();
                        var count = processQLDData(data);  // Returns count
                        updateSourceStatus('qld', true, count);
                        updateLastRefresh('QLD Fire');
                        return true;
                    }
                } catch (e) {
                    console.log('QLD: Proxy ' + (i + 1) + ' failed:', e.message);
                    continue;
                }
            }
            
            throw new Error('All proxies failed. Download manually.');
        } catch (error) {
            status('‚ö†Ô∏è QLD Fire unavailable. Use manual download link below.', 'warning');
            console.error('QLD Fire Error:', error);
            updateSourceStatus('qld', false);
            return false;
        }
    }

    async function loadAllStates() {
        clearHazards();
        status('üîÑ Loading data from all states...', 'info');
        
        var results = await Promise.allSettled([
            loadNSWRFS(),
            loadVICEmergency(),
            loadQLDFire()
        ]);
        
        var successCount = results.filter(r => r.status === 'fulfilled' && r.value === true).length;
        var total = hazardsData.fires.length + hazardsData.incidents.length + hazardsData.warnings.length;
        
        if (successCount > 0) {
            status('‚úÖ Loaded ' + total + ' incidents from ' + successCount + ' state(s)', 'success');
            updateLastRefresh(successCount + ' States');
        } else {
            status('‚ùå All states failed. See manual download links below.', 'error');
        }
    }

    function processVICData(data) {
        console.log('VIC: Processing data, type:', typeof data, 'isArray:', Array.isArray(data));
        
        // VIC Emergency can return different formats - handle all cases
        var incidents = [];
        
        if (Array.isArray(data)) {
            console.log('VIC: Format = Direct Array');
            incidents = data;
        } else if (data && data.results && Array.isArray(data.results)) {
            console.log('VIC: Format = { results: [...] } - Found ' + data.results.length + ' incidents');
            incidents = data.results;
        } else if (data && data.incidents && Array.isArray(data.incidents)) {
            console.log('VIC: Format = { incidents: [...] }');
            incidents = data.incidents;
        } else if (data && data.features && Array.isArray(data.features)) {
            console.log('VIC: Format = GeoJSON');
            incidents = data.features.map(function(f) {
                return {
                    name: f.properties.name,
                    location: {
                        latitude: f.geometry.coordinates[1],
                        longitude: f.geometry.coordinates[0]
                    },
                    category1: f.properties.category,
                    status: f.properties.status,
                    sourceTitle: f.properties.description
                };
            });
        } else {
            console.error('VIC: Unexpected data format. Data:', data);
            console.error('VIC: Data keys:', data ? Object.keys(data) : 'null');
            status('‚ö†Ô∏è VIC data format not recognized. Try manual download.', 'warning');
            return 0;
        }

        if (incidents.length === 0) {
            console.log('VIC: No incidents found in data');
            status('‚ÑπÔ∏è VIC: No active incidents', 'info');
            return 0;
        }

        console.log('VIC: Processing ' + incidents.length + ' incidents');
        var count = 0;
        
        for (var i = 0; i < incidents.length; i++) {
            try {
                var incident = incidents[i];
                
                // Handle different location formats
                var lat, lon;
                
                if (incident.location && incident.location.latitude) {
                    lat = parseFloat(incident.location.latitude);
                    lon = parseFloat(incident.location.longitude);
                } else if (incident.latitude && incident.longitude) {
                    lat = parseFloat(incident.latitude);
                    lon = parseFloat(incident.longitude);
                } else if (incident.geometry && incident.geometry.coordinates) {
                    lon = parseFloat(incident.geometry.coordinates[0]);
                    lat = parseFloat(incident.geometry.coordinates[1]);
                } else {
                    console.log('VIC: Incident missing location:', incident);
                    continue;
                }
                
                if (isNaN(lat) || isNaN(lon)) {
                    console.log('VIC: Invalid coordinates:', lat, lon);
                    continue;
                }

                var h = {
                    title: incident.name || incident.incidentName || 'VIC Incident',
                    category: incident.category1 || incident.category || incident.type1 || '',
                    status: incident.status || incident.incidentStatus || '',
                    type: incident.type || incident.incidentType || 'incident',
                    lat: lat,
                    lon: lon,
                    description: incident.sourceTitle || incident.sourceOrganisation || '',
                    source: 'VIC Emergency',
                    link: incident.url || 'https://emergency.vic.gov.au'
                };

                addHazardMarker(h);
                count++;
            } catch (e) {
                console.error('VIC data parsing error for incident:', incident, e);
            }
        }

        console.log('‚úÖ VIC: Successfully loaded ' + count + ' of ' + incidents.length + ' incidents');
        updateStats();
        return count;  // Return count for caller
        updateAlerts();
        return count;
    }

    function processQLDData(data) {
        if (!data || !data.features) {
            console.error('QLD: Invalid data format');
            return 0;
        }

        var count = 0;
        for (var i = 0; i < data.features.length; i++) {
            try {
                var feature = data.features[i];
                var props = feature.properties || {};
                var coords = feature.geometry ? feature.geometry.coordinates : null;
                
                if (!coords || coords.length < 2) continue;

                var lon = coords[0];
                var lat = coords[1];
                if (isNaN(lat) || isNaN(lon)) continue;

                var h = {
                    title: props.INCIDENT_NAME || 'QLD Incident',
                    category: props.INCIDENT_TYPE || '',
                    status: props.INCIDENT_STATUS || '',
                    type: 'fire',
                    lat: lat,
                    lon: lon,
                    description: props.INCIDENT_SUMMARY || '',
                    source: 'QLD Fire',
                    link: ''
                };

                addHazardMarker(h);
                count++;
            } catch (e) {
                console.error('QLD data parsing error:', e);
            }
        }

        console.log('‚úÖ QLD: Loaded ' + count + ' incidents');
        updateStats();
        updateAlerts();
        return count;  // Return count for caller
    }

    function updateLastRefresh(source) {
        lastRefreshTime = new Date();
        var timeStr = lastRefreshTime.toLocaleTimeString();
        document.getElementById('last-refresh').textContent = 'Last: ' + timeStr + ' (' + source + ')';
        document.getElementById('data-status').textContent = 'Live data from ' + source;
    }

    function setupAutoRefresh() {
        var checkbox = document.getElementById('auto-refresh-enabled');
        
        checkbox.onchange = function() {
            if (this.checked) {
                // Start auto-refresh (5 minutes = 300000 ms)
                autoRefreshInterval = setInterval(function() {
                    loadAllStates();
                }, 300000); // 5 minutes
                status('‚úÖ Auto-refresh enabled (every 5 min)', 'success');
            } else {
                // Stop auto-refresh
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                status('Auto-refresh disabled', 'info');
            }
        };
    }

    function clearHazards() {
        firesCluster.clearLayers();
        incidentsCluster.clearLayers();
        warningsCluster.clearLayers();
        firesLayer.clearLayers();
        incidentsLayer.clearLayers();
        warningsLayer.clearLayers();
        
        hazardsData = { fires: [], incidents: [], warnings: [] };
        allFireMarkers = [];
        allIncidentMarkers = [];
        allWarningMarkers = [];
    }

    window.onload = function() { 
        setTimeout(function() {
            initMap();
            console.log('‚úÖ BAI Hazard Monitor v6.0 - Categories & Import/Export Ready');
            console.log('üìä Export/Import functions loaded');
            
            // Setup live update button handlers
            document.getElementById('load-nsw-btn').onclick = loadNSWRFS;
            document.getElementById('load-vic-btn').onclick = loadVICEmergency;
            document.getElementById('load-qld-btn').onclick = loadQLDFire;
            document.getElementById('load-all-states-btn').onclick = loadAllStates;
            document.getElementById('load-nasa-btn').onclick = function() {
                console.log('üõ∞Ô∏è NASA FIRMS button clicked');
                console.log('NASA FIRMS: Key status:', nasaFirmsKey ? 'Configured (' + nasaFirmsKey.substring(0,8) + '...)' : 'NOT CONFIGURED');
                console.log('NASA FIRMS: Button disabled?', this.disabled);
                loadNASAFIRMS();
            };
            
            // Setup auto-refresh
            setupAutoRefresh();
            
            // Load saved NASA FIRMS key
            loadSavedNASAKey();
            
            // Load saved base map preference
            loadSavedBaseMap();
            
            console.log('‚úÖ Base map initialized. Weather data via external links.');
            
            // Update NASA status indicator
            if (nasaFirmsKey) {
                updateSourceStatus('nasa', null);
                document.getElementById('source-nasa-status').innerHTML = 'NASA: <span style="color: #2196F3;">Ready (click button to load)</span>';
            }
            
            // Update WMS status
            setTimeout(function() {
                if (gaHotspotsWMS && map.hasLayer(gaHotspotsWMS)) {
                    updateSourceStatus('wms', true);
                } else {
                    document.getElementById('source-wms-status').innerHTML = 'WMS: <span style="color: #999;">Layer added</span>';
                }
            }, 2000);
            
            // Update button states
            updateStats();
            
            if (sitesData.length > 0) {
                           var bs = sitesData.map(function(s) { return [s.lat, s.lon]; });
                map.fitBounds(bs, { padding: [50, 50] });
            }
        }, 500);
    };
</script>
```

</body>
</html>